<!DOCTYPE html>
<html lang="tr">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9TBV0530VS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-9TBV0530VS');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Salon Yönetimi - Zamanli</title>
    
    <!-- PWA Install Prompt - En Erken Yakala -->
    <script>window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();window.__pwaPrompt=e;console.log('[PWA] Install prompt yakalandı');});</script>
    
    <!-- PWA Temel -->
    <meta name="application-name" content="Zamanli Panel">
    <meta name="theme-color" content="#0B2B26">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Apple/iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zamanli Panel">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png">
    
    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" href="/icons/splash/apple-splash-1170-2532.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/icons/splash/apple-splash-1125-2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/icons/splash/apple-splash-750-1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-72x72.png">
    <link rel="shortcut icon" href="/icons/favicon.ico">
    <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
    
    <!-- Fonts: Satoshi + Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://api.fontshare.com" crossorigin>
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,600,700,800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            /* Brand Core */
            --brand-deep-forest: #0B2B26;
            --brand-emerald: #10B981;
            --brand-emerald-hover: #0EA371;
            --brand-gold: #C5A065;
            
            --primary: #10B981;
            --primary-dark: #0EA371;
            --primary-light: #34D399;
            --success: #10b981;
            --success-light: #ECFDF5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            --radius: 0.75rem;
            --radius-lg: 1rem;
            --shadow: 0 1px 3px rgba(11,43,38,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(11,43,38,0.1);
            
            /* Typography */
            --font-heading: 'Satoshi', 'Inter', system-ui, sans-serif;
            --font-body: 'Inter', system-ui, sans-serif;
        }
        
        body {
            font-family: var(--font-body);
            background: var(--slate-100);
            color: var(--slate-800);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden; /* Yatay taşmayı engelle */
        }
        
        /* Mobil genel düzeltmeler */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            html, body {
                overflow-x: hidden;
                width: 100%;
                max-width: 100vw;
            }
            
            .dashboard {
                overflow-x: hidden;
                max-width: 100vw;
            }
            
            /* Tablo taşmasını engelle */
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Input ve select taşmasını engelle */
            input, select, textarea, button {
                max-width: 100%;
            }
            
            /* Kartlar taşmasın */
            .card, .panel, .form-step {
                max-width: 100%;
                overflow-x: hidden;
            }
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
        }
        
        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }
        
        .login-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-logo-image {
            height: 48px;
            width: auto;
            margin-bottom: 0.5rem;
        }
        
        .login-logo-text {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--slate-900);
            letter-spacing: -0.02em;
        }
        
        .login-title {
            text-align: center;
            font-size: 1.25rem;
            color: var(--slate-600);
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--slate-700);
        }
        
        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--slate-200);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-input.error {
            border-color: var(--danger);
        }
        
        .form-error {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-family: inherit;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-outline {
            background: white;
            color: var(--slate-700);
            border: 2px solid var(--slate-200);
        }
        
        .btn-outline:hover {
            border-color: var(--slate-300);
            background: var(--slate-50);
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .btn-icon {
            padding: 0.5rem;
            min-width: 36px;
            height: 36px;
        }
        
        .btn-icon-sm {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--slate-200);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .btn-icon-sm:hover {
            background: var(--slate-100);
            border-color: var(--slate-300);
        }
        
        /* ===== MOBİL HAMBURGER MENÜ ===== */
        .mobile-menu-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--slate-100);
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            color: var(--slate-700);
            z-index: 101;
            border-radius: var(--radius);
            transition: all 0.2s;
        }
        
        .mobile-menu-toggle:hover {
            background: var(--slate-200);
        }
        
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                padding: 0.4rem 0.6rem;
                font-size: 1.2rem;
            }
            
            .header-salon {
                display: none;
            }
            
            .header-right .btn-text,
            .header-user,
            .btn-logout {
                display: none !important;
            }
            
            .header-right {
                gap: 0.5rem;
            }
            
            .header-right .btn-outline {
                padding: 0.5rem;
            }
            
            .tabs {
                display: none;
            }
        }
        
        /* Mobil Slide Menü */
        .mobile-slide-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 280px;
            max-width: 85vw;
            height: 100%;
            background: white;
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
        }
        
        .mobile-slide-menu.active {
            left: 0;
        }
        
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .mobile-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .mobile-menu-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--slate-200);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .mobile-menu-header .salon-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .mobile-menu-header .salon-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .mobile-menu-header .salon-name {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .mobile-menu-header .salon-type {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        .mobile-menu-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-menu-nav {
            flex: 1;
            padding: 0.5rem 0;
            overflow-y: auto;
        }
        
        .mobile-menu-nav a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            color: var(--slate-700);
            text-decoration: none;
            font-weight: 500;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .mobile-menu-nav a:hover,
        .mobile-menu-nav a.active {
            background: var(--slate-50);
            border-left-color: var(--primary);
            color: var(--primary);
        }
        
        .mobile-menu-nav a .menu-icon {
            font-size: 1.25rem;
            width: 28px;
            text-align: center;
        }
        
        .mobile-menu-nav .menu-divider {
            height: 1px;
            background: var(--slate-200);
            margin: 0.5rem 1rem;
        }
        
        .mobile-menu-footer {
            padding: 1rem;
            border-top: 1px solid var(--slate-200);
        }
        
        .mobile-menu-footer .logout-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.875rem;
            background: var(--slate-100);
            color: var(--danger);
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .mobile-menu-footer .logout-btn:hover {
            background: var(--danger-light);
        }
        
        /* ===== YENİ ANA LAYOUT ===== */
        .main.new-layout {
            padding: 0.75rem;
            max-width: 100%;
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border-radius: var(--radius);
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow);
        }
        
        .top-bar-stats {
            display: flex;
            gap: 1.5rem;
        }
        
        .mini-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .mini-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--slate-800);
        }
        
        .mini-stat-label {
            font-size: 0.7rem;
            color: var(--slate-500);
            text-transform: uppercase;
        }
        
        .mini-stat.pending .mini-stat-value {
            color: var(--warning);
        }
        
        .mini-stat.success .mini-stat-value {
            color: var(--success);
        }
        
        .menu-toggle-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            background: var(--slate-100);
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--slate-700);
            transition: all 0.2s;
        }
        
        .menu-toggle-btn:hover {
            background: var(--slate-200);
        }
        
        .menu-toggle-btn span:first-child {
            font-size: 1.1rem;
        }
        
        /* Ana Split View */
        .main-split-view {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 0.75rem;
            height: calc(100vh - 160px);
            min-height: 400px;
            max-height: calc(100vh - 140px);
        }
        
        @media (max-width: 1024px) {
            .main-split-view {
                grid-template-columns: 1fr 240px;
                height: calc(100vh - 180px);
            }
        }
        
        @media (max-width: 768px) {
            .main-split-view {
                grid-template-columns: 1fr;
                height: auto;
                max-height: none;
                gap: 0.5rem;
            }
            
            .calendar-panel {
                max-height: none;
                min-height: auto;
            }
            
            .requests-panel {
                max-height: 35vh;
                min-height: 200px;
            }
            
            .top-bar {
                flex-direction: row;
                flex-wrap: wrap;
                padding: 0.5rem;
                gap: 0.5rem;
            }
            
            .top-bar-stats {
                flex: 1;
                min-width: 200px;
            }
            
            .mini-stat {
                padding: 0.4rem 0.6rem;
            }
            
            .mini-stat span:first-child {
                font-size: 1rem;
            }
            
            .mini-stat span:last-child {
                font-size: 0.6rem;
            }
        }
        
        /* Panel Stilleri */
        .calendar-panel,
        .requests-panel {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--slate-200);
            background: var(--slate-50);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .panel-header h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--slate-800);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .pending-badge {
            background: var(--warning);
            color: white;
            font-size: 0.7rem;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .calendar-controls-inline {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        .calendar-controls-inline .cal-nav-btn {
            padding: 0.3rem 0.5rem;
            font-size: 0.8rem;
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 6px;
            cursor: pointer;
        }
        
        .calendar-controls-inline .cal-nav-btn:hover {
            background: var(--slate-100);
        }
        
        .btn-add-appointment {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-add-appointment:hover {
            background: #059669;
            transform: scale(1.05);
        }
        
        .week-range-text {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--slate-700);
            min-width: 80px;
            text-align: center;
        }
        
        @media (max-width: 480px) {
            .week-range-text {
                font-size: 0.6rem;
                min-width: 70px;
            }
            
            .calendar-controls-inline .cal-nav-btn {
                padding: 0.2rem 0.4rem;
                font-size: 0.75rem;
            }
            
            .cal-today-btn-small {
                padding: 0.2rem 0.4rem;
                font-size: 0.65rem;
            }
        }
            min-width: 100px;
            text-align: center;
        }
        
        .cal-today-btn-small {
            padding: 0.35rem 0.6rem;
            font-size: 0.75rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .staff-filter-inline {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--slate-100);
        }
        
        .staff-filter-inline select {
            width: 100%;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--slate-200);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        /* Yeni Haftalık Takvim - Kompakt */
        .weekly-calendar-new {
            flex: 1;
            overflow: auto;
            display: grid;
            grid-template-columns: 40px repeat(7, 1fr);
            grid-auto-rows: minmax(32px, auto);
            font-size: 0.7rem;
            position: relative;
            max-height: calc(100vh - 320px);
            min-height: 250px;
        }
        
        @media (max-width: 768px) {
            .weekly-calendar-new {
                grid-template-columns: 35px repeat(7, 1fr);
                grid-auto-rows: minmax(28px, auto);
                font-size: 0.65rem;
                max-height: 45vh;
                min-height: 200px;
            }
        }
        
        @media (max-width: 480px) {
            .weekly-calendar-new {
                grid-template-columns: 30px repeat(7, 1fr);
                grid-auto-rows: minmax(26px, auto);
                font-size: 0.6rem;
            }
        }
        
        .weekly-calendar-new .cal-time-header {
            background: var(--slate-50);
            border-right: 1px solid var(--slate-200);
            border-bottom: 1px solid var(--slate-200);
            position: sticky;
            top: 0;
            left: 0;
            z-index: 3;
        }
        
        .weekly-calendar-new .cal-header {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 0.2rem 0.1rem;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid #059669;
            border-right: 1px solid rgba(255,255,255,0.15);
            position: sticky;
            top: 0;
            z-index: 2;
            font-size: 0.6rem;
        }
        
        .weekly-calendar-new .cal-header.today {
            background: linear-gradient(135deg, #1e293b, #334155);
            border-bottom-color: #1e293b;
        }
        
        .weekly-calendar-new .cal-header-day {
            font-size: 0.5rem;
            opacity: 0.9;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .weekly-calendar-new .cal-header-date {
            font-size: 0.8rem;
            font-weight: 700;
            line-height: 1.1;
        }
        
        @media (max-width: 480px) {
            .weekly-calendar-new .cal-header {
                padding: 0.15rem 0.05rem;
            }
            .weekly-calendar-new .cal-header-day {
                font-size: 0.45rem;
            }
            .weekly-calendar-new .cal-header-date {
                font-size: 0.7rem;
            }
        }
        
        .weekly-calendar-new .cal-time-slot {
            padding: 0.1rem;
            text-align: center;
            font-size: 0.55rem;
            color: var(--slate-500);
            border-right: 1px solid var(--slate-200);
            border-bottom: 1px solid var(--slate-100);
            background: white;
            position: sticky;
            left: 0;
            z-index: 1;
        }
        
        .weekly-calendar-new .cal-cell {
            border-right: 1px solid var(--slate-100);
            border-bottom: 1px solid var(--slate-100);
            padding: 1px;
            min-height: 36px;
            position: relative;
            transition: background 0.2s;
        }
        
        .weekly-calendar-new .cal-cell.past {
            background: var(--slate-50);
        }
        
        .weekly-calendar-new .cal-cell.drag-over {
            background: rgba(16, 185, 129, 0.15);
            outline: 2px dashed var(--primary);
        }
        
        .weekly-calendar-new .cal-appointment {
            background: var(--primary);
            color: white;
            padding: 0.15rem 0.25rem;
            border-radius: 3px;
            font-size: 0.6rem;
            margin-bottom: 1px;
            cursor: grab;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: transform 0.1s, box-shadow 0.1s;
            line-height: 1.2;
        }
        
        .weekly-calendar-new .cal-appointment:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .weekly-calendar-new .cal-appointment.pending {
            background: var(--warning);
        }
        
        .weekly-calendar-new .cal-appointment.confirmed {
            background: var(--primary);
        }
        
        .weekly-calendar-new .cal-appointment.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        /* Mobilde randevu kartları */
        @media (max-width: 768px) {
            .weekly-calendar-new .cal-appointment {
                font-size: 0.55rem;
                padding: 0.1rem 0.2rem;
            }
        }
        
        /* Sağ Panel - Talepler */
        .requests-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .side-panel-tabs {
            display: flex;
            gap: 0;
            width: 100%;
        }
        
        .side-tab {
            flex: 1;
            padding: 0.5rem 0.5rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--slate-500);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            transition: all 0.2s;
        }
        
        .side-tab:hover {
            color: var(--slate-700);
            background: var(--slate-50);
        }
        
        .side-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .today-badge {
            background: var(--primary);
            color: white;
            font-size: 0.65rem;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .side-tab-content {
            display: block;
        }
        
        .side-tab-content[style*="display: none"] {
            display: none !important;
        }
        
        .request-card {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: var(--radius);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--warning);
        }
        
        .request-card .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .request-card .customer-name {
            font-weight: 600;
            color: var(--slate-800);
            font-size: 0.9rem;
        }
        
        .request-card .request-time {
            font-size: 0.75rem;
            color: var(--warning);
            font-weight: 600;
        }
        
        .request-card .request-details {
            font-size: 0.8rem;
            color: var(--slate-600);
            margin-bottom: 0.5rem;
        }
        
        .request-card .request-details span {
            display: block;
            margin-bottom: 0.15rem;
        }
        
        .request-card .request-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .request-card .btn-approve {
            flex: 1;
            padding: 0.4rem;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .request-card .btn-reject {
            padding: 0.4rem 0.6rem;
            background: white;
            color: var(--danger);
            border: 1px solid var(--danger);
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .empty-requests {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--slate-400);
        }
        
        .empty-requests .empty-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        /* Gizli Sekmeler Container */
        .hidden-tabs-container {
            margin-top: 1rem;
        }
        
        .staff-pin-section {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: var(--slate-50);
            border-radius: 6px;
        }
        
        .staff-card.owner-card {
            border: 2px solid var(--primary);
            background: linear-gradient(to bottom, rgba(99, 102, 241, 0.05), white);
        }
        
        .staff-mode-banner {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.9rem;
            border-radius: var(--radius);
            margin: 1rem;
        }
        
        .staff-mode-banner .btn-outline {
            background: white;
            color: var(--primary);
            border-color: white;
        }
        
        /* Dashboard Layout */
        .dashboard {
            display: none;
        }
        
        .dashboard.active {
            display: block;
        }
        
        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid var(--slate-200);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 1.35rem;
            color: var(--slate-900);
        }
        
        .header-logo .logo-image {
            height: 28px;
            width: auto;
            object-fit: contain;
        }
        
        .header-logo .logo-text {
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--slate-900);
            letter-spacing: -0.02em;
        }
        
        .header-salon {
            padding-left: 1rem;
            border-left: 2px solid var(--slate-200);
        }
        
        .header-salon-name {
            font-weight: 600;
            color: var(--slate-800);
        }
        
        .header-salon-type {
            font-size: 0.8rem;
            color: var(--slate-500);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header-user {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .header-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        /* Main Content */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: var(--shadow);
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .stat-icon.primary { background: rgba(99, 102, 241, 0.1); }
        .stat-icon.success { background: rgba(16, 185, 129, 0.1); }
        .stat-icon.warning { background: rgba(245, 158, 11, 0.1); }
        .stat-icon.danger { background: rgba(239, 68, 68, 0.1); }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--slate-900);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--slate-500);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            background: white;
            padding: 0.5rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }
        
        .tab {
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            border: none;
            background: none;
            font-family: inherit;
            font-size: 0.95rem;
            color: var(--slate-600);
        }
        
        .tab:hover {
            background: var(--slate-100);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Appointments */
        .appointments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .appointments-title {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .appointments-filters {
            display: flex;
            gap: 0.5rem;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--slate-200);
            background: white;
            border-radius: var(--radius);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            color: var(--primary);
        }
        
        .appointment-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .appointment-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: var(--shadow);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            align-items: center;
        }
        
        @media (max-width: 700px) {
            .appointment-card {
                grid-template-columns: 1fr;
            }
        }
        
        .appointment-date {
            text-align: center;
            padding: 0.75rem 1rem;
            background: var(--slate-100);
            border-radius: var(--radius);
            min-width: 80px;
        }
        
        .appointment-day {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .appointment-month {
            font-size: 0.8rem;
            color: var(--slate-500);
        }
        
        .appointment-time {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--slate-700);
            margin-top: 0.25rem;
        }
        
        .appointment-info h4 {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .appointment-details {
            font-size: 0.9rem;
            color: var(--slate-600);
        }
        
        .appointment-details span {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-right: 1rem;
        }
        
        .appointment-status {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 0.5rem;
        }
        
        .status-pending {
            background: var(--warning-light);
            color: #b45309;
        }
        
        .status-confirmed {
            background: var(--success-light);
            color: #047857;
        }
        
        .status-cancelled {
            background: var(--danger-light);
            color: #b91c1c;
        }
        
        .status-completed {
            background: var(--slate-200);
            color: var(--slate-600);
        }
        
        .appointment-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            background: white;
            border-radius: var(--radius);
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .empty-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .empty-text {
            color: var(--slate-500);
        }
        
        /* Settings Sections */
        .settings-section {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        /* Settings Tab arka planı - açık yeşil */
        #tab-settings {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            min-height: 100%;
        }
        
        #tab-settings .settings-section {
            background: white;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .settings-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Services Management */
        .service-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border: 2px solid var(--slate-200);
            border-radius: var(--radius);
            margin-bottom: 0.75rem;
        }
        
        .service-item:last-child {
            margin-bottom: 0;
        }
        
        .service-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .service-icon {
            width: 45px;
            height: 45px;
            background: var(--slate-100);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .service-name {
            font-weight: 600;
        }
        
        .service-duration {
            font-size: 0.85rem;
            color: var(--slate-500);
        }
        
        .service-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .service-price {
            font-weight: 700;
            color: var(--primary);
        }
        
        /* Staff Management */
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .staff-card {
            background: var(--slate-50);
            border: 2px solid var(--slate-200);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
        }
        
        .staff-avatar {
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 auto 0.75rem;
        }
        
        .staff-name {
            font-weight: 600;
        }
        
        .staff-title {
            font-size: 0.85rem;
            color: var(--slate-500);
            margin-bottom: 0.75rem;
        }
        
        /* Working Hours */
        .hours-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .hours-row {
            display: grid;
            grid-template-columns: 120px 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem;
            background: var(--slate-50);
            border-radius: var(--radius);
        }
        
        @media (max-width: 600px) {
            .hours-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }
        
        .hours-day {
            font-weight: 600;
        }
        
        .hours-inputs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .hours-input {
            padding: 0.5rem;
            border: 2px solid var(--slate-200);
            border-radius: var(--radius);
            font-family: inherit;
            width: 100px;
        }
        
        .hours-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Toggle Switch */
        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
        }
        
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--slate-300);
            border-radius: 9999px;
            transition: 0.3s;
        }
        
        .toggle-slider:before {
            content: '';
            position: absolute;
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        .toggle input:checked + .toggle-slider {
            background: var(--success);
        }
        
        .toggle input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* Toggle Switch - Yeni Stil */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
            flex-shrink: 0;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-switch .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--slate-300);
            border-radius: 26px;
            transition: 0.3s;
        }
        
        .toggle-switch .toggle-slider:before {
            content: '';
            position: absolute;
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background: var(--success);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: white;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal-overlay.active .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--slate-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--slate-400);
            padding: 0.25rem;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--slate-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--slate-800);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1100;
        }
        
        .toast.active {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background: var(--success);
        }
        
        .toast.error {
            background: var(--danger);
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1200;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--slate-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay p {
            margin-top: 1rem;
            color: var(--slate-600);
        }
        
        /* ========== HAFTALIK TAKVİM STİLLERİ ========== */
        .view-toggle {
            display: flex;
            gap: 0;
            border: 2px solid var(--slate-200);
            border-radius: var(--radius);
            overflow: hidden;
        }
        
        .view-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: white;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-right: 1px solid var(--slate-200);
        }
        
        .view-btn:last-child {
            border-right: none;
        }
        
        .view-btn:hover {
            background: var(--slate-50);
        }
        
        .view-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .gcal-export-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--success);
            background: white;
            color: var(--success);
            border-radius: var(--radius);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        
        .gcal-export-btn:hover {
            background: var(--success);
            color: white;
        }
        
        .view-container {
            display: none;
        }
        
        .view-container.active {
            display: block;
        }
        
        .staff-filter-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 1rem 0;
            padding: 0.75rem;
            background: var(--slate-50);
            border-radius: var(--radius);
        }
        
        .staff-filter-row label {
            font-weight: 500;
            color: var(--slate-600);
            font-size: 0.9rem;
        }
        
        .staff-filter-row select {
            padding: 0.5rem 1rem;
            border: 2px solid var(--slate-200);
            border-radius: var(--radius);
            font-size: 0.9rem;
            background: white;
            min-width: 150px;
        }
        
        .calendar-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .cal-nav-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--slate-200);
            background: white;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cal-nav-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .cal-today-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
        }
        
        .week-range {
            font-weight: 700;
            font-size: 1rem;
            color: var(--slate-800);
        }
        
        .weekly-calendar {
            display: grid;
            grid-template-columns: 40px repeat(7, 1fr);
            grid-auto-rows: minmax(32px, auto);
            font-size: 0.7rem;
            background: white;
            border-radius: var(--radius);
            overflow: auto;
            max-height: calc(100vh - 320px);
            min-height: 250px;
        }
        
        @media (max-width: 768px) {
            .weekly-calendar {
                grid-template-columns: 35px repeat(7, 1fr);
                grid-auto-rows: minmax(28px, auto);
                font-size: 0.65rem;
                max-height: 45vh;
            }
        }
        
        .cal-header {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 0.2rem 0.1rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.6rem;
            border-bottom: 2px solid #059669;
            border-right: 1px solid rgba(255,255,255,0.15);
            position: sticky;
            top: 0;
            z-index: 2;
        }
        
        .cal-header.today {
            background: linear-gradient(135deg, #1e293b, #334155);
            border-bottom-color: #1e293b;
        }
        
        .cal-header-day {
            font-size: 0.5rem;
            opacity: 0.9;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .cal-header-date {
            font-size: 0.8rem;
            font-weight: 700;
            line-height: 1.1;
        }
        
        .cal-time-header {
            background: var(--slate-50);
            padding: 0.2rem;
            font-size: 0.6rem;
            color: var(--slate-500);
            text-align: center;
            border-right: 1px solid var(--slate-200);
            border-bottom: 2px solid #059669;
            position: sticky;
            top: 0;
            left: 0;
            z-index: 3;
        }
        
        .cal-time-slot {
            background: white;
            padding: 0.1rem;
            font-size: 0.55rem;
            color: var(--slate-500);
            text-align: center;
            border-right: 1px solid var(--slate-200);
            border-bottom: 1px solid var(--slate-100);
            position: sticky;
            left: 0;
            z-index: 1;
        }
        
        .cal-cell {
            background: white;
            padding: 1px;
            min-height: 32px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            border-right: 1px solid var(--slate-100);
            border-bottom: 1px solid var(--slate-100);
        }
        
        .cal-cell:hover {
            background: rgba(16, 185, 129, 0.05);
        }
        
        .cal-cell.past {
            background: var(--slate-50);
            cursor: not-allowed;
        }
        
        .cal-appointment {
            background: var(--primary);
            color: white;
            padding: 0.15rem 0.25rem;
            border-radius: 3px;
            font-size: 0.55rem;
            margin-bottom: 1px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.2;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        .cal-appointment.pending {
            background: var(--warning);
        }
        
        .cal-appointment.confirmed {
            background: var(--primary);
        }
        
        .cal-appointment.cancelled {
            background: var(--danger);
            opacity: 0.6;
        }
        
        .cal-appointment.completed {
            background: var(--slate-400);
            opacity: 0.7;
        }
        
        .cal-appointment:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        /* Sürükle-Bırak stilleri */
        .cal-appointment.dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }
        
        .cal-cell.drag-over {
            background: rgba(99, 102, 241, 0.1);
            border: 2px dashed var(--primary);
        }
        
        /* Quick Add Popup */
        .quick-add-popup {
            position: fixed;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            pointer-events: none;
        }
        
        .quick-add-popup.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        
        .quick-add-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 0.75rem;
            min-width: 180px;
            position: relative;
        }
        
        .quick-add-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--slate-600);
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--slate-100);
        }
        
        .quick-add-btn {
            width: 100%;
            padding: 0.6rem 1rem;
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-add-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .quick-add-close {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: var(--slate-100);
            border: none;
            border-radius: 50%;
            font-size: 0.65rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate-500);
        }
        
        .quick-add-close:hover {
            background: var(--slate-200);
        }
        
        /* ========== MOBILE RESPONSIVE - TAM DÜZENLEME ========== */
        .btn-icon-only { display: none; }
        .btn-text { display: inline; }
        .header-user-name { display: none; }
        .btn-logout { display: inline-flex; }
        
        /* Tablet (768px ve altı) */
        @media (max-width: 768px) {
            /* Header */
            .header {
                padding: 0.5rem 0.75rem;
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .header-container {
                gap: 0.5rem;
            }
            
            .header-left {
                flex: 1;
                min-width: 0;
                overflow: hidden;
            }
            
            .header-logo {
                font-size: 0.9rem;
                flex-shrink: 0;
            }
            
            .header-logo span:last-child {
                display: none;
            }
            
            .header-salon {
                padding-left: 0.5rem;
                margin-left: 0.5rem;
                border-left: 2px solid var(--slate-200);
                overflow: hidden;
            }
            
            .header-salon-name {
                font-size: 0.75rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100px;
            }
            
            .header-salon-type {
                display: none;
            }
            
            .header-right {
                gap: 0.35rem;
                flex-shrink: 0;
            }
            
            .btn-icon-only { display: inline; }
            .btn-text { display: none; }
            
            .header-user {
                display: none;
            }
            
            .btn-logout {
                padding: 0.35rem 0.5rem;
                font-size: 0.7rem;
            }
            
            .btn-outline.btn-sm {
                padding: 0.35rem 0.45rem;
                font-size: 0.7rem;
            }
            
            /* Main Content */
            .main {
                padding: 0.5rem;
            }
            
            .main.new-layout {
                padding: 0.5rem;
                gap: 0.5rem;
            }
            
            /* Top Bar Stats */
            .top-bar {
                padding: 0.5rem;
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            .top-bar-stats {
                flex: 1;
                min-width: 180px;
                gap: 0.35rem;
            }
            
            .mini-stat {
                padding: 0.35rem 0.5rem;
                min-width: 55px;
            }
            
            .mini-stat-value {
                font-size: 0.95rem !important;
            }
            
            .mini-stat-label {
                font-size: 0.55rem !important;
            }
            
            .menu-toggle-btn {
                padding: 0.4rem 0.75rem;
                font-size: 0.8rem;
            }
            
            /* Split View */
            .main-split-view {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .calendar-panel,
            .requests-panel {
                max-height: none;
                min-height: auto;
            }
            
            .calendar-panel {
                order: 1;
            }
            
            .requests-panel {
                order: 2;
                max-height: 35vh;
            }
            
            .panel-header {
                padding: 0.5rem 0.75rem;
                flex-wrap: wrap;
                gap: 0.35rem;
            }
            
            .panel-header h3 {
                font-size: 0.85rem;
            }
            
            /* Calendar Controls */
            .calendar-controls-inline {
                gap: 0.2rem;
            }
            
            .calendar-controls-inline .cal-nav-btn {
                padding: 0.25rem 0.4rem;
                font-size: 0.75rem;
            }
            
            .cal-today-btn-small {
                padding: 0.25rem 0.4rem;
                font-size: 0.65rem;
            }
            
            .week-range-text {
                font-size: 0.65rem;
                min-width: 65px;
            }
            
            /* Weekly Calendar */
            .weekly-calendar,
            .weekly-calendar-new {
                max-height: 40vh;
                min-height: 180px;
            }
            
            /* Side Panel Tabs */
            .side-tabs {
                gap: 0;
            }
            
            .side-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
            
            .side-tab-badge {
                width: 16px;
                height: 16px;
                font-size: 0.6rem;
            }
            
            /* Request Cards */
            .request-card {
                padding: 0.6rem;
                gap: 0.5rem;
            }
            
            .request-time {
                font-size: 0.7rem;
                padding: 0.25rem 0.4rem;
            }
            
            .request-info h4 {
                font-size: 0.85rem;
            }
            
            .request-meta {
                font-size: 0.7rem;
                gap: 0.35rem;
            }
            
            .request-actions {
                gap: 0.25rem;
            }
            
            .request-actions .btn-sm {
                padding: 0.3rem 0.5rem;
                font-size: 0.65rem;
            }
            
            /* Hidden Tabs Section */
            .hidden-tabs-section {
                padding: 0.5rem;
            }
            
            .tab-nav {
                gap: 0.25rem;
                padding: 0.5rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
                white-space: nowrap;
            }
            
            /* Appointments Tab */
            .appointments-header {
                padding: 0.5rem 0.75rem;
                gap: 0.35rem;
            }
            
            .appointments-title {
                font-size: 0.9rem !important;
            }
            
            .view-toggle {
                padding: 2px;
            }
            
            .view-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.7rem;
            }
            
            .appointments-filters {
                padding: 0.5rem 0.75rem;
                gap: 0.25rem;
            }
            
            .filter-btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
            }
            
            /* Appointment Cards */
            .appointment-card {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.75rem;
            }
            
            .appointment-date {
                width: 100%;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem;
                border-radius: 8px;
            }
            
            .appointment-day {
                font-size: 1.25rem;
            }
            
            .appointment-month {
                font-size: 0.7rem;
            }
            
            .appointment-time {
                margin-left: auto;
                font-size: 0.9rem;
            }
            
            .appointment-info h4 {
                font-size: 0.9rem;
            }
            
            .appointment-details {
                font-size: 0.75rem;
                flex-wrap: wrap;
            }
            
            .appointment-actions {
                flex-direction: row;
                width: 100%;
                justify-content: flex-end;
            }
            
            /* Calendar Controls for appointments tab */
            .calendar-controls {
                padding: 0.5rem 0.75rem;
                gap: 0.35rem;
            }
            
            .cal-nav-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.8rem;
            }
            
            .cal-today-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .week-range {
                font-size: 0.8rem;
                min-width: 100px;
            }
            
            /* Settings */
            .settings-section {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }
            
            .settings-title {
                font-size: 0.95rem;
            }
            
            .form-label {
                font-size: 0.8rem;
            }
            
            .form-input {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            
            /* Modal */
            .modal {
                width: 95%;
                max-width: 400px;
                margin: 0.5rem;
                max-height: 90vh;
            }
            
            .modal-header {
                padding: 0.75rem 1rem;
            }
            
            .modal-title {
                font-size: 1rem;
            }
            
            .modal-body {
                padding: 1rem;
                max-height: 60vh;
                overflow-y: auto;
            }
            
            .modal-footer {
                padding: 0.75rem 1rem;
                gap: 0.35rem;
            }
            
            .modal-footer .btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
            }
            
            /* Quick Add Popup */
            .quick-add-content {
                min-width: 160px;
                padding: 0.6rem;
            }
            
            .quick-add-header {
                font-size: 0.7rem;
            }
            
            .quick-add-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            
            /* Reports */
            .report-section {
                padding: 0.75rem;
            }
            
            .report-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .report-stat {
                padding: 0.75rem;
            }
            
            .report-stat-value {
                font-size: 1.25rem;
            }
            
            .detailed-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .detail-stat-card {
                padding: 0.6rem;
                font-size: 0.8rem;
            }
            
            .hourly-bars {
                height: 80px;
            }
            
            /* Mobile Menu */
            .mobile-menu-overlay.active {
                display: flex;
            }
            
            .mobile-menu {
                width: 85%;
                max-width: 300px;
            }
            
            .mobile-menu-header {
                padding: 1rem;
            }
            
            .mobile-menu-nav a {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
        }
        
        /* Küçük telefon (480px ve altı) */
        @media (max-width: 480px) {
            .header {
                padding: 0.4rem 0.5rem;
            }
            
            .header-logo {
                font-size: 0.85rem;
            }
            
            .header-salon-name {
                font-size: 0.7rem;
                max-width: 70px;
            }
            
            .btn-logout {
                padding: 0.3rem 0.4rem;
                font-size: 0.65rem;
            }
            
            .main,
            .main.new-layout {
                padding: 0.35rem;
            }
            
            .top-bar {
                padding: 0.35rem;
            }
            
            .mini-stat {
                padding: 0.3rem 0.4rem;
                min-width: 50px;
            }
            
            .mini-stat-value {
                font-size: 0.85rem !important;
            }
            
            .mini-stat-label {
                font-size: 0.5rem !important;
            }
            
            .menu-toggle-btn {
                padding: 0.35rem 0.6rem;
                font-size: 0.75rem;
            }
            
            .panel-header {
                padding: 0.4rem 0.5rem;
            }
            
            .panel-header h3 {
                font-size: 0.8rem;
            }
            
            .btn-add-appointment {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }
            
            .week-range-text {
                font-size: 0.6rem;
                min-width: 60px;
            }
            
            .calendar-controls-inline .cal-nav-btn {
                padding: 0.2rem 0.35rem;
                font-size: 0.7rem;
            }
            
            .cal-today-btn-small {
                padding: 0.2rem 0.35rem;
                font-size: 0.6rem;
            }
            
            .weekly-calendar,
            .weekly-calendar-new {
                max-height: 35vh;
                min-height: 150px;
                grid-template-columns: 28px repeat(7, 1fr);
                grid-auto-rows: minmax(24px, auto);
                font-size: 0.55rem;
            }
            
            .cal-header {
                padding: 0.15rem 0.05rem;
            }
            
            .cal-header-day {
                font-size: 0.4rem;
            }
            
            .cal-header-date {
                font-size: 0.65rem;
            }
            
            .cal-time-slot {
                font-size: 0.5rem;
                padding: 0.05rem;
            }
            
            .cal-cell {
                min-height: 24px;
            }
            
            .cal-appointment {
                padding: 0.1rem 0.15rem;
                font-size: 0.45rem;
                border-radius: 2px;
            }
            
            .side-tab {
                padding: 0.4rem 0.5rem;
                font-size: 0.7rem;
            }
            
            .request-card {
                padding: 0.5rem;
            }
            
            .request-time {
                font-size: 0.65rem;
                padding: 0.2rem 0.35rem;
            }
            
            .request-info h4 {
                font-size: 0.8rem;
            }
            
            .request-meta {
                font-size: 0.65rem;
            }
            
            .request-actions .btn-sm {
                padding: 0.25rem 0.4rem;
                font-size: 0.6rem;
            }
            
            .tab {
                padding: 0.35rem 0.5rem;
                font-size: 0.65rem;
            }
            
            .appointments-title {
                font-size: 0.85rem !important;
            }
            
            .view-btn {
                padding: 0.25rem 0.4rem;
                font-size: 0.65rem;
            }
            
            .filter-btn {
                padding: 0.2rem 0.4rem;
                font-size: 0.65rem;
            }
            
            .appointment-card {
                padding: 0.6rem;
            }
            
            .appointment-day {
                font-size: 1.1rem;
            }
            
            .appointment-info h4 {
                font-size: 0.85rem;
            }
            
            .appointment-details {
                font-size: 0.7rem;
            }
            
            .modal {
                width: 98%;
                margin: 0.25rem;
            }
            
            .modal-body {
                padding: 0.75rem;
            }
            
            .settings-section {
                padding: 0.75rem;
            }
            
            .report-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .report-stat-value {
                font-size: 1.1rem;
            }
            
            .detailed-stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .quick-add-content {
                min-width: 140px;
                padding: 0.5rem;
            }
            
            .quick-add-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
        }
        
        /* Çok küçük telefon (360px ve altı) */
        @media (max-width: 360px) {
            .header-salon-name {
                max-width: 50px;
                font-size: 0.65rem;
            }
            
            .mini-stat {
                min-width: 45px;
                padding: 0.25rem 0.35rem;
            }
            
            .mini-stat-value {
                font-size: 0.8rem !important;
            }
            
            .weekly-calendar,
            .weekly-calendar-new {
                grid-template-columns: 25px repeat(7, 1fr);
            }
            
            .cal-header-day {
                font-size: 0.35rem;
            }
            
            .cal-header-date {
                font-size: 0.6rem;
            }
            
            .cal-appointment {
                font-size: 0.4rem;
            }
            
            .view-btn {
                padding: 0.2rem 0.35rem;
                font-size: 0.6rem;
            }
            
            .tab {
                padding: 0.3rem 0.4rem;
                font-size: 0.6rem;
            }
        }
        
        
        /* Logo ve Galeri Yükleme */
        .logo-upload-area {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-preview {
            width: 80px;
            height: 80px;
            border-radius: var(--radius);
            background: var(--slate-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            overflow: hidden;
        }
        
        .logo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .logo-upload-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .gallery-upload-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }
        
        @media (max-width: 600px) {
            .gallery-upload-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .gallery-item-upload {
            aspect-ratio: 1;
            border-radius: var(--radius);
            overflow: hidden;
            position: relative;
        }
        
        .gallery-item-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .gallery-item-upload .remove-gallery-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        /* QR Kod */
        .qr-code-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: var(--slate-50);
            border-radius: var(--radius);
        }
        
        .qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 2px solid var(--brand-emerald);
        }
        
        .qr-code-display {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        .qr-code-display canvas,
        .qr-code-display img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .qr-branding {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--slate-200);
        }
        
        .qr-branding-logo {
            height: 24px;
            width: auto;
        }
        
        .qr-branding-text {
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 1rem;
            color: var(--brand-deep-forest);
            letter-spacing: -0.01em;
        }
        
        .qr-branding-tagline {
            font-size: 0.7rem;
            color: var(--slate-500);
        }
        
        .qr-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .settings-desc {
            color: var(--slate-500);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        /* Müşteri Listesi */
        .customer-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .customer-card {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: var(--radius);
            padding: 1rem;
        }
        
        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .customer-info h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .customer-info p {
            font-size: 0.85rem;
            color: var(--slate-500);
        }
        
        .customer-stats {
            display: flex;
            gap: 1rem;
            text-align: center;
        }
        
        .customer-stat {
            font-size: 0.75rem;
            color: var(--slate-500);
        }
        
        .customer-stat strong {
            display: block;
            font-size: 1rem;
            color: var(--slate-800);
        }
        
        .customer-history {
            background: var(--slate-50);
            border-radius: var(--radius);
            padding: 0.75rem;
            margin-top: 0.75rem;
        }
        
        .customer-history h5 {
            font-size: 0.8rem;
            color: var(--slate-600);
            margin-bottom: 0.5rem;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            padding: 0.35rem 0;
            border-bottom: 1px solid var(--slate-200);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .customer-note {
            margin-top: 0.75rem;
        }
        
        .customer-note textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--slate-200);
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 60px;
        }
        
        .empty-text {
            color: var(--slate-500);
            text-align: center;
            padding: 2rem;
        }
        
        .form-hint {
            font-size: 0.75rem;
            color: var(--slate-500);
            margin-top: 0.25rem;
        }
        
        /* ========== RAPORLAR STİLLERİ ========== */
        .reports-container {
            padding: 1rem 0;
        }
        
        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .reports-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--slate-800);
        }
        
        .report-period-selector {
            display: flex;
            gap: 0;
            border: 2px solid var(--slate-200);
            border-radius: var(--radius);
            overflow: hidden;
        }
        
        .period-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: white;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-right: 1px solid var(--slate-200);
        }
        
        .period-btn:last-child {
            border-right: none;
        }
        
        .period-btn:hover {
            background: var(--slate-50);
        }
        
        .period-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .report-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .report-card {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .report-card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .report-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--slate-800);
        }
        
        .report-card-label {
            font-size: 0.85rem;
            color: var(--slate-500);
        }
        
        .report-section {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }
        
        .report-section h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--slate-800);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--slate-100);
        }
        
        /* Detaylı İstatistik Kartları */
        .detailed-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }
        
        .detail-stat-card {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--slate-50);
            border-radius: var(--radius);
            border-left: 3px solid var(--slate-300);
        }
        
        .detail-stat-card.priority-high {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }
        
        .detail-stat-card.priority-warning {
            border-left-color: var(--warning);
            background: rgba(245, 158, 11, 0.05);
        }
        
        .detail-stat-card.priority-danger {
            border-left-color: var(--danger);
            background: rgba(239, 68, 68, 0.05);
        }
        
        .detail-stat-card.priority-success {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }
        
        .detail-stat-icon {
            font-size: 1.25rem;
        }
        
        .detail-stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--slate-800);
        }
        
        .detail-stat-label {
            font-size: 0.7rem;
            color: var(--slate-500);
            text-transform: uppercase;
        }
        
        /* Saatlik Dağılım */
        .hourly-distribution {
            padding: 0.5rem 0;
        }
        
        .hourly-header {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: var(--slate-600);
        }
        
        .hourly-bars {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 100px;
            gap: 2px;
        }
        
        .hourly-bar {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }
        
        .hourly-bar-count {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--slate-500);
        }
        
        .hourly-bar-fill {
            width: 100%;
            min-width: 16px;
            max-width: 30px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
            min-height: 4px;
            transition: height 0.3s;
        }
        
        .hourly-bar.peak .hourly-bar-fill {
            background: var(--warning);
        }
        
        .hourly-bar-label {
            font-size: 0.6rem;
            color: var(--slate-500);
        }
        
        @media (max-width: 600px) {
            .detailed-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .hourly-bars {
                gap: 1px;
            }
            
            .hourly-bar-fill {
                min-width: 12px;
            }
            
            .hourly-bar-label {
                font-size: 0.5rem;
            }
        }
        
        .staff-performance-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .staff-performance-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--slate-50);
            border-radius: var(--radius);
        }
        
        .staff-performance-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .staff-performance-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .staff-performance-stats {
            display: flex;
            gap: 1.5rem;
            font-size: 0.85rem;
        }
        
        .staff-performance-stats span {
            color: var(--slate-600);
        }
        
        .staff-performance-stats strong {
            color: var(--slate-800);
        }
        
        .popular-services-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .popular-service-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--slate-50);
            border-radius: var(--radius);
        }
        
        .popular-service-bar {
            height: 8px;
            background: var(--slate-200);
            border-radius: 4px;
            flex: 1;
            margin: 0 1rem;
            overflow: hidden;
        }
        
        .popular-service-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
        }
        
        .daily-distribution {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        
        .daily-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .daily-bar-fill {
            width: 100%;
            background: var(--slate-200);
            border-radius: 4px;
            min-height: 100px;
            position: relative;
        }
        
        .daily-bar-value {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--primary);
            border-radius: 4px;
            transition: height 0.3s;
        }
        
        .daily-bar-label {
            font-size: 0.75rem;
            color: var(--slate-500);
            font-weight: 500;
        }
        
        .daily-bar-count {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--slate-700);
        }
        
        /* ========== CHART.JS GRAFİK STİLLERİ ========== */
        .chart-section {
            padding: 1.25rem;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--slate-100);
        }
        
        .chart-header h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--slate-800);
            margin: 0;
            border: none;
            padding: 0;
        }
        
        .chart-legend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--slate-500);
        }
        
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .chart-container {
            position: relative;
            width: 100%;
        }
        
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 900px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }
        
        .comparison-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .comparison-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 1rem;
            background: var(--slate-50);
            border-radius: var(--radius);
        }
        
        .comparison-label {
            font-size: 0.85rem;
            color: var(--slate-500);
        }
        
        .comparison-value {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        /* Finance Period Buttons (opsiyonel ayrı selector) */
        .finance-period-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: white;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-right: 1px solid var(--slate-200);
        }
        
        .finance-period-btn:last-child {
            border-right: none;
        }
        
        .finance-period-btn.active {
            background: var(--primary);
            color: white;
        }
    </style>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Loading -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Yükleniyor...</p>
    </div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen" style="display: none;">
        <div class="login-card">
            <div class="login-logo">
                <img src="/icons/logo.png" alt="Zamanli" class="login-logo-image">
                <div class="login-logo-text">Zamanli</div>
            </div>
            <h2 class="login-title">Salon Yönetim Paneli</h2>
            
            <p style="text-align:center;font-size:0.85rem;color:var(--slate-500);margin-bottom:1.25rem;">
                Telefon numaranız ve PIN kodunuz ile giriş yapın
            </p>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Telefon Numarası</label>
                    <input type="tel" id="loginPhone" class="form-input" placeholder="05XX XXX XX XX" required>
                </div>
                <div class="form-group">
                    <label class="form-label">PIN Kodu</label>
                    <input type="password" id="loginPin" class="form-input" placeholder="PIN kodunuz" maxlength="6" required>
                    <p id="loginError" class="form-error" style="display: none;"></p>
                </div>
                <button type="submit" class="btn btn-primary">
                    Giriş Yap
                </button>
            </form>
            <p style="text-align: center; margin-top: 1.5rem; font-size: 0.9rem; color: var(--slate-500);">
                PIN kodunuzu unuttunuz mu?<br>
                <a href="https://wa.me/905433838587" target="_blank" style="color: var(--primary);">Destek ile iletişime geçin</a>
            </p>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <!-- Mobil Slide Menü -->
        <div id="mobileMenuOverlay" class="mobile-menu-overlay" onclick="closeMobileMenu()"></div>
        <div id="mobileSlideMenu" class="mobile-slide-menu">
            <div class="mobile-menu-header">
                <div class="salon-info">
                    <div id="mobileMenuAvatar" class="salon-avatar">S</div>
                    <div>
                        <div id="mobileMenuSalonName" class="salon-name">Salon Adı</div>
                        <div class="salon-type">Yönetim Paneli</div>
                    </div>
                </div>
                <button class="mobile-menu-close" onclick="closeMobileMenu()">✕</button>
            </div>
            <nav class="mobile-menu-nav">
                <a href="#" class="active" onclick="showMainView(); closeMobileMenu(); return false;">
                    <span class="menu-icon">📅</span> Takvim & Talepler
                </a>
                <a href="#" onclick="showHiddenTabs('appointments'); return false;">
                    <span class="menu-icon">📋</span> Tüm Randevular
                </a>
                <div class="menu-divider"></div>
                <a href="#" onclick="showHiddenTabs('customers'); return false;">
                    <span class="menu-icon">👥</span> Müşteriler
                </a>
                <a href="#" data-menu-tab="services" onclick="showHiddenTabs('services'); return false;">
                    <span class="menu-icon">✂️</span> Hizmetler
                </a>
                <a href="#" data-menu-tab="staff" onclick="showHiddenTabs('staff'); return false;">
                    <span class="menu-icon">👤</span> Personel
                </a>
                <a href="#" data-menu-tab="hours" onclick="showHiddenTabs('hours'); return false;">
                    <span class="menu-icon">🕐</span> Çalışma Saatleri
                </a>
                <div class="menu-divider"></div>
                <a href="#" data-menu-tab="reports" onclick="showHiddenTabs('reports'); return false;">
                    <span class="menu-icon">📊</span> Raporlar
                </a>
                <!-- Salon Ayarları - Sadece salon sahibi görecek -->
                <a href="#" data-menu-tab="settings" id="menuSalonSettings" onclick="showHiddenTabs('settings'); return false;">
                    <span class="menu-icon">⚙️</span> Salon Ayarları
                </a>
                <!-- Profilim - Sadece salon sahibi görecek -->
                <a href="#" id="menuMyProfile" onclick="openOwnerProfileModal(); closeMobileMenu(); return false;">
                    <span class="menu-icon">👤</span> Profilim
                </a>
                <!-- Ayarlarım - Personel için -->
                <a href="#" id="menuMySettings" onclick="openStaffSettingsModal(); closeMobileMenu(); return false;" style="display:none;">
                    <span class="menu-icon">👤</span> Ayarlarım
                </a>
                <div class="menu-divider"></div>
                <a href="#" id="mobileViewSalonBtn" target="_blank">
                    <span class="menu-icon">👁️</span> Salonu Görüntüle
                </a>
            </nav>
            <div class="mobile-menu-footer">
                <button class="logout-btn" onclick="logout()">
                    <span>🚪</span> Çıkış Yap
                </button>
            </div>
        </div>
        
        <!-- Header -->
        <header class="header">
            <div class="header-container">
                <div class="header-left">
                    <button class="mobile-menu-toggle" onclick="openMobileMenu()" aria-label="Menü">
                        ☰
                    </button>
                    <a href="/" class="header-logo">
                        <img src="/icons/logo.png" alt="Zamanli" class="logo-image">
                        <span class="logo-text">Zamanli</span>
                    </a>
                    <div class="header-salon">
                        <div id="headerSalonName" class="header-salon-name">Salon Adı</div>
                        <div class="header-salon-type">Yönetim Paneli</div>
                    </div>
                </div>
                <div class="header-right">
                    <a href="#" id="viewSalonBtn" class="btn btn-outline btn-sm" target="_blank">
                        <span class="btn-icon-only">👁️</span>
                        <span class="btn-text">Salonu Görüntüle</span>
                    </a>
                    <div class="header-user">
                        <div id="headerAvatar" class="header-avatar">S</div>
                        <span class="header-user-name">Çıkış</span>
                    </div>
                    <button onclick="logout()" class="btn btn-outline btn-sm btn-logout">
                        Çıkış
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main new-layout">
            <!-- ÜST BAR: İstatistikler + Menü Butonu -->
            <div class="top-bar">
                <div class="top-bar-stats">
                    <div class="mini-stat">
                        <span class="mini-stat-value" id="statTodayMini">0</span>
                        <span class="mini-stat-label">Bugün</span>
                    </div>
                    <div class="mini-stat pending">
                        <span class="mini-stat-value" id="statPendingMini">0</span>
                        <span class="mini-stat-label">Bekleyen</span>
                    </div>
                    <div class="mini-stat success">
                        <span class="mini-stat-value" id="statRevenueMini">0₺</span>
                        <span class="mini-stat-label">Bu Ay</span>
                    </div>
                </div>
                <button class="menu-toggle-btn" onclick="openMobileMenu()">
                    <span>☰</span>
                    <span>Menü</span>
                </button>
            </div>
            
            <!-- ANA İÇERİK: Takvim + Talepler yan yana -->
            <div class="main-split-view">
                <!-- SOL: Haftalık Takvim -->
                <div class="calendar-panel">
                    <div class="panel-header">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <h3 style="margin: 0; font-size: 0.85rem;">📅 Takvim</h3>
                            <button class="btn-add-appointment" onclick="openManualAppointmentModal()" title="Manuel Randevu Ekle">
                                ➕
                            </button>
                        </div>
                        <div class="calendar-controls-inline">
                            <button class="cal-nav-btn" onclick="changeWeek(-1)">←</button>
                            <span id="weekRangeNew" class="week-range-text">Tarih</span>
                            <button class="cal-nav-btn" onclick="changeWeek(1)">→</button>
                            <button class="cal-today-btn-small" onclick="goToToday()">Bugün</button>
                        </div>
                    </div>
                    <div class="staff-filter-inline">
                        <select id="calendarStaffFilterNew" onchange="renderWeeklyCalendarNew()">
                            <option value="all">Tüm Personel</option>
                        </select>
                    </div>
                    <div id="weeklyCalendarNew" class="weekly-calendar-new">
                        <!-- Takvim burada render edilecek -->
                    </div>
                </div>
                
                <!-- SAĞ: Randevu Paneli (Sekmeli) -->
                <div class="requests-panel">
                    <div class="panel-header" style="padding: 0.5rem 0.75rem;">
                        <div class="side-panel-tabs">
                            <button class="side-tab active" onclick="switchSideTab('pending')">
                                ⏳ Bekleyen <span id="pendingCount" class="pending-badge">0</span>
                            </button>
                            <button class="side-tab" onclick="switchSideTab('today')">
                                📅 Bugün <span id="todayCount" class="today-badge">0</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bekleyen Talepler -->
                    <div id="pendingRequestsList" class="requests-list side-tab-content active">
                        <!-- Bekleyen randevular burada listelenecek -->
                    </div>
                    
                    <!-- Bugünkü Randevular -->
                    <div id="todayAppointmentsList" class="requests-list side-tab-content" style="display: none;">
                        <!-- Bugünkü randevular burada listelenecek -->
                    </div>
                </div>
            </div>
            
            <!-- GİZLİ SEKMELER (Hamburger menüden açılacak) -->
            <div id="hiddenTabs" class="hidden-tabs-container" style="display: none;">
            <!-- Tabs - KALDIRILDI, hamburger menüden erişilsin -->
            
            <!-- Appointments Tab - Yeni Tasarım -->
            <div id="tab-appointments" class="tab-content active">
                <div class="appointments-header" style="flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
                        <h3 class="appointments-title" style="margin: 0; font-size: 1rem;">📅 Tüm Randevular</h3>
                        <button class="btn-add-appointment" onclick="openManualAppointmentModal()" title="Manuel Randevu Ekle">
                            ➕
                        </button>
                    </div>
                    <div style="display: flex; gap: 0.35rem; align-items: center;">
                        <div class="view-toggle" style="background: var(--slate-100); border-radius: 8px; padding: 2px;">
                            <button class="view-btn active" data-view="calendar" onclick="switchView('calendar')" style="padding: 0.35rem 0.6rem; font-size: 0.75rem;">📅 Takvim</button>
                            <button class="view-btn" data-view="list" onclick="switchView('list')" style="padding: 0.35rem 0.6rem; font-size: 0.75rem;">📋 Liste</button>
                        </div>
                        <button class="btn btn-outline btn-sm" onclick="exportToGoogleCalendar()" title="Google Takvime Aktar" style="padding: 0.3rem 0.5rem; font-size: 0.7rem;">
                            📅
                        </button>
                    </div>
                </div>
                
                <!-- Haftalık Takvim Görünümü (ÖNCELİKLİ) -->
                <div id="calendarView" class="view-container active">
                    <div class="calendar-controls" style="padding: 0.5rem 1rem; background: var(--slate-50); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.35rem;">
                            <button class="cal-nav-btn" onclick="changeWeek(-1)" style="padding: 0.3rem 0.5rem;">←</button>
                            <span id="weekRange" class="week-range" style="font-size: 0.8rem; min-width: 100px; text-align: center; font-weight: 600;">Tarih</span>
                            <button class="cal-nav-btn" onclick="changeWeek(1)" style="padding: 0.3rem 0.5rem;">→</button>
                            <button class="cal-today-btn" onclick="goToToday()" style="padding: 0.3rem 0.5rem; font-size: 0.75rem;">Bugün</button>
                        </div>
                        <select id="calendarStaffFilter" onchange="renderWeeklyCalendar()" style="padding: 0.3rem 0.5rem; font-size: 0.75rem; border: 1px solid var(--slate-200); border-radius: 6px;">
                            <option value="all">Tüm Personel</option>
                        </select>
                    </div>
                    <div id="weeklyCalendar" class="weekly-calendar">
                        <!-- Calendar will be rendered here -->
                    </div>
                </div>
                
                <!-- Liste Görünümü -->
                <div id="listView" class="view-container" style="display: none;">
                    <div class="appointments-filters" style="padding: 0.5rem 1rem; background: var(--slate-50); display: flex; flex-wrap: wrap; gap: 0.35rem;">
                        <button class="filter-btn active" data-filter="all" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;">Tümü</button>
                        <button class="filter-btn" data-filter="pending" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;">⏳ Bekleyen</button>
                        <button class="filter-btn" data-filter="confirmed" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;">✅ Onaylı</button>
                        <button class="filter-btn" data-filter="today" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;">📅 Bugün</button>
                        <select id="staffFilterSelect" onchange="filterByStaff()" style="margin-left: auto; padding: 0.3rem 0.5rem; font-size: 0.75rem; border: 1px solid var(--slate-200); border-radius: 6px;">
                            <option value="all">Tüm Personel</option>
                        </select>
                    </div>
                    <div id="appointmentList" class="appointment-list">
                        <!-- Appointments will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Customers Tab (Müşteri Geçmişi) -->
            <div id="tab-customers" class="tab-content">
                <div class="settings-section">
                    <div class="settings-title" style="display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                        👥 Müşteri Yönetimi
                        <div style="display: flex; gap: 0.5rem; margin-left: auto; flex-wrap: wrap;">
                            <input type="text" id="customerSearch" class="form-input" placeholder="Müşteri ara..." style="width: 180px; padding: 0.5rem 0.75rem;" onkeyup="searchCustomers()">
                            <button class="btn btn-primary btn-sm" onclick="openAddCustomerModal()">
                                + Müşteri Ekle
                            </button>
                        </div>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--slate-500); margin-bottom: 1rem;">
                        💡 Randevu alan müşteriler otomatik olarak bu listeye eklenir. Manuel olarak da müşteri ekleyebilirsiniz.
                    </p>
                    <div id="customerList" class="customer-list">
                        <!-- Müşteriler burada listelenecek -->
                        <p class="empty-text">Müşteri verisi yükleniyor...</p>
                    </div>
                </div>
            </div>
            
            <!-- Services Tab -->
            <div id="tab-services" class="tab-content">
                <div class="settings-section">
                    <div class="settings-title">
                        ✂️ Hizmetler
                        <button class="btn btn-primary btn-sm" style="margin-left: auto;" onclick="openServiceModal()">
                            + Hizmet Ekle
                        </button>
                    </div>
                    <div id="serviceList">
                        <!-- Services will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Staff Tab -->
            <div id="tab-staff" class="tab-content">
                <div class="settings-section">
                    <div class="settings-title">
                        👥 Personel
                        <div id="addStaffBtnContainer" style="margin-left: auto;">
                            <button class="btn btn-primary btn-sm" onclick="openStaffModal()">
                                + Personel Ekle
                            </button>
                        </div>
                    </div>
                    <div id="staffList" class="staff-grid">
                        <!-- Staff will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Working Hours Tab -->
            <div id="tab-hours" class="tab-content">
                <div class="settings-section">
                    <div class="settings-title">🕐 Çalışma Saatleri</div>
                    <div id="hoursList" class="hours-grid">
                        <!-- Hours will be loaded here -->
                    </div>
                    <button class="btn btn-primary" style="margin-top: 1rem;" onclick="saveWorkingHours()">
                        Kaydet
                    </button>
                </div>
            </div>
            
            <!-- Reports Tab -->
            <div id="tab-reports" class="tab-content">
                <div class="reports-container">
                    <div class="reports-header">
                        <h3>📊 Raporlar</h3>
                        <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
                            <div class="report-period-selector">
                                <button class="period-btn active" data-period="week" onclick="changeReportPeriod('week')">Bu Hafta</button>
                                <button class="period-btn" data-period="month" onclick="changeReportPeriod('month')">Bu Ay</button>
                                <button class="period-btn" data-period="year" onclick="changeReportPeriod('year')">Bu Yıl</button>
                            </div>
                            <div id="exportButtons" style="display:flex;gap:0.25rem;">
                                <button onclick="exportAppointmentsCSV()" class="btn btn-outline btn-sm" title="Randevuları CSV olarak indir" id="btnExportCSV">📥 CSV</button>
                                <button onclick="exportReportPDF()" class="btn btn-outline btn-sm" title="Rapor PDF olarak indir" id="btnExportPDF">📄 PDF</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Özet Kartları -->
                    <div class="report-summary-cards">
                        <div class="report-card">
                            <div class="report-card-icon" style="background: rgba(99, 102, 241, 0.1); color: var(--primary);">📅</div>
                            <div class="report-card-content">
                                <div class="report-card-value" id="reportTotalAppointments">0</div>
                                <div class="report-card-label">Toplam Randevu</div>
                            </div>
                        </div>
                        <div class="report-card">
                            <div class="report-card-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--success);">✅</div>
                            <div class="report-card-content">
                                <div class="report-card-value" id="reportCompletedAppointments">0</div>
                                <div class="report-card-label">Tamamlanan</div>
                            </div>
                        </div>
                        <div class="report-card">
                            <div class="report-card-icon" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);">❌</div>
                            <div class="report-card-content">
                                <div class="report-card-value" id="reportCancelledAppointments">0</div>
                                <div class="report-card-label">İptal Edilen</div>
                            </div>
                        </div>
                        <div class="report-card">
                            <div class="report-card-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">💰</div>
                            <div class="report-card-content">
                                <div class="report-card-value" id="reportTotalRevenue">0 ₺</div>
                                <div class="report-card-label">Tahsil Edilen</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detaylı İstatistikler (Öncelik Sırasına Göre) -->
                    <div class="report-section" style="margin-bottom: 1.5rem;">
                        <h4>📈 Detaylı İstatistikler</h4>
                        <div id="detailedStatsContainer">
                            <!-- Detaylı istatistikler buraya yüklenecek -->
                        </div>
                    </div>
                    
                    <!-- Saatlik Dağılım (Yoğun Saatler) -->
                    <div class="report-section" style="margin-bottom: 1.5rem;">
                        <h4>⏰ Saatlik Yoğunluk</h4>
                        <div id="hourlyDistribution" class="hourly-distribution">
                            <!-- Saatlik dağılım buraya yüklenecek -->
                        </div>
                    </div>
                    
                    <!-- Personel Performansı -->
                    <div class="report-section">
                        <h4>👥 Personel Performansı</h4>
                        <div id="staffPerformanceList" class="staff-performance-list">
                            <!-- Personel performansı buraya yüklenecek -->
                        </div>
                    </div>
                    
                    <!-- Popüler Hizmetler -->
                    <div class="report-section">
                        <h4>⭐ Popüler Hizmetler</h4>
                        <div id="popularServicesList" class="popular-services-list">
                            <!-- Popüler hizmetler buraya yüklenecek -->
                        </div>
                    </div>
                    
                    <!-- Günlük Dağılım -->
                    <div class="report-section">
                        <h4>📊 Günlere Göre Dağılım</h4>
                        <div id="dailyDistribution" class="daily-distribution">
                            <!-- Günlük dağılım buraya yüklenecek -->
                        </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content">
                <!-- Salon Sahibi Profili -->
                <div class="settings-section" id="ownerProfileSection">
                    <div class="settings-title">👤 Kişisel Profilim (Salon Sahibi)</div>
                    <p class="settings-desc" style="margin-bottom: 1rem;">Salon sahibi olarak kendi bilgilerinizi güncelleyin. Bu bilgiler personel listesinde görünür.</p>
                    <form id="ownerProfileForm" onsubmit="saveOwnerProfile(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Ad Soyad</label>
                                <input type="text" id="ownerName" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Unvan</label>
                                <input type="text" id="ownerTitle" class="form-input" placeholder="örn: Salon Sahibi / Kuaför">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefon</label>
                            <input type="tel" id="ownerPhone" class="form-input" readonly style="background: var(--slate-50);">
                            <p class="form-hint">Telefon numarası değiştirilemez (Giriş için kullanılıyor)</p>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Profilimi Güncelle
                        </button>
                    </form>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">📍 Salon Bilgileri</div>
                    <form id="settingsForm" onsubmit="saveSettings(event)">
                        <div class="form-group">
                            <label class="form-label">Salon Adı</label>
                            <input type="text" id="settingName" class="form-input" required>
                        </div>
                        
                        <!-- Kategori Seçimi -->
                        <div class="form-group">
                            <label class="form-label">🏷️ Salon Türü</label>
                            <div class="category-selector" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 0.5rem;">
                                <label class="category-option" id="catOptBerber" style="display: flex; flex-direction: column; align-items: center; padding: 1rem; border: 2px solid var(--slate-200); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center;">
                                    <input type="radio" name="settingCategory" value="berber" style="display: none;" onchange="updateSettingCategory('berber')">
                                    <span style="font-size: 1.5rem; margin-bottom: 0.25rem;">💈</span>
                                    <span style="font-weight: 600; font-size: 0.85rem;">Berber</span>
                                </label>
                                <label class="category-option" id="catOptKuafor" style="display: flex; flex-direction: column; align-items: center; padding: 1rem; border: 2px solid var(--slate-200); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center;">
                                    <input type="radio" name="settingCategory" value="kuafor" style="display: none;" onchange="updateSettingCategory('kuafor')">
                                    <span style="font-size: 1.5rem; margin-bottom: 0.25rem;">💇‍♀️</span>
                                    <span style="font-weight: 600; font-size: 0.85rem;">Kuaför</span>
                                </label>
                                <label class="category-option" id="catOptBeauty" style="display: flex; flex-direction: column; align-items: center; padding: 1rem; border: 2px solid var(--slate-200); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center;">
                                    <input type="radio" name="settingCategory" value="beauty" style="display: none;" onchange="updateSettingCategory('beauty')">
                                    <span style="font-size: 1.5rem; margin-bottom: 0.25rem;">💆</span>
                                    <span style="font-weight: 600; font-size: 0.85rem;">Güzellik</span>
                                </label>
                            </div>
                            <p class="form-hint" style="margin-top: 0.5rem;">Kategori, salonunuzun listelenme şeklini ve varsayılan hizmetleri belirler</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">İl</label>
                                <input type="text" id="settingCity" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">İlçe</label>
                                <input type="text" id="settingDistrict" class="form-input" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Adres</label>
                            <input type="text" id="settingAddress" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefon</label>
                            <input type="tel" id="settingPhone" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">E-posta</label>
                            <input type="email" id="settingEmail" class="form-input" placeholder="salon@email.com">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Kaydet
                        </button>
                    </form>
                </div>
                
                <!-- Logo ve Galeri -->
                <div class="settings-section">
                    <div class="settings-title">📸 Logo ve Galeri</div>
                    
                    <div class="form-group">
                        <label class="form-label">Salon Logosu</label>
                        <div class="logo-upload-area">
                            <div id="logoPreview" class="logo-preview">
                                <span>💈</span>
                            </div>
                            <div class="logo-upload-actions">
                                <input type="file" id="logoInput" accept="image/*" onchange="uploadLogo(event)" style="display:none;">
                                <button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('logoInput').click()">
                                    📤 Logo Yükle
                                </button>
                                <button type="button" class="btn btn-outline btn-sm" onclick="removeLogo()" id="removeLogoBtn" style="display:none;">
                                    🗑️ Kaldır
                                </button>
                            </div>
                        </div>
                        <p class="form-hint">📐 <strong>Boyut:</strong> 200x200 piksel (kare) • <strong>Max:</strong> 5MB • <strong>Format:</strong> JPG, PNG, WebP</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Galeri (max 10 görsel)</label>
                        <div id="galleryGrid" class="gallery-upload-grid">
                            <!-- Galeri görselleri -->
                        </div>
                        <input type="file" id="galleryInput" accept="image/*" multiple onchange="uploadGalleryImages(event)" style="display:none;">
                        <button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('galleryInput').click()" id="addGalleryBtn" style="margin-top: 0.5rem;">
                            ➕ Görsel Ekle
                        </button>
                        <p class="form-hint">📐 <strong>Boyut:</strong> 800x600 piksel (yatay) • <strong>Max:</strong> 5MB/görsel • <strong>Format:</strong> JPG, PNG</p>
                    </div>
                </div>
                
                <!-- QR Kod -->
                <div class="settings-section">
                    <div class="settings-title">📱 Salon QR Kodu</div>
                    <p class="settings-desc">Müşterileriniz bu QR kodu okutarak doğrudan salon sayfanıza erişebilir.</p>
                    
                    <div class="qr-code-area">
                        <div class="qr-code-container">
                            <div id="qrCodeDisplay" class="qr-code-display">
                                <div class="qr-loading">⏳ QR kod yükleniyor...</div>
                            </div>
                            <div class="qr-branding">
                                <img src="/icons/logo.png" alt="Zamanli" class="qr-branding-logo">
                                <div class="qr-branding-text">Zamanli</div>
                                <div class="qr-branding-tagline">Online Randevu Sistemi</div>
                            </div>
                        </div>
                        <div class="qr-actions">
                            <button class="btn btn-primary btn-sm" onclick="downloadQRCodeWithBranding()">
                                📥 QR Kodu İndir
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="printQRCode()">
                                🖨️ Yazdır
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Google Business Link -->
                <div class="settings-section">
                    <div class="settings-title">⭐ Google Business</div>
                    <p class="settings-desc">Google Business yorum linkinizi ekleyerek müşterilerinizin sizi değerlendirmesini kolaylaştırın.</p>
                    
                    <div class="form-group">
                        <label class="form-label">Google Business Yorum Linki</label>
                        <input type="url" id="settingGoogleBusiness" class="form-input" placeholder="https://g.page/r/...">
                        <p class="form-hint">Google Maps'te işletmenize gidin > "Yorum yaz" butonuna sağ tıklayın > Link adresini kopyalayın</p>
                    </div>
                    <button type="button" class="btn btn-primary btn-sm" onclick="saveGoogleBusinessLink()">
                        Kaydet
                    </button>
                </div>
                
                <!-- PIN Değiştir -->
                <div class="settings-section">
                    <div class="settings-title">🔐 PIN Değiştir</div>
                    <form onsubmit="changePin(event)">
                        <div class="form-group">
                            <label class="form-label">Mevcut PIN</label>
                            <input type="password" id="currentPin" class="form-input" maxlength="6" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Yeni PIN</label>
                            <input type="password" id="newPin" class="form-input" maxlength="6" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            PIN Değiştir
                        </button>
                    </form>
                </div>
                
                <!-- Gelişmiş Ayarlar (Opsiyonel) -->
                <div class="settings-section" style="border: 2px dashed var(--slate-200); background: var(--slate-50);">
                    <div class="settings-title" style="display: flex; align-items: center; justify-content: space-between;">
                        <span>⚙️ Gelişmiş Ayarlar</span>
                        <span style="font-size: 0.7rem; background: var(--primary); color: white; padding: 0.15rem 0.5rem; border-radius: 10px;">Opsiyonel</span>
                    </div>
                    <p class="settings-desc" style="margin-bottom: 1rem;">Bu ayarlar işletmeniz için ek özellikler sağlar. Değiştirmeden önce dikkatli düşünün.</p>
                    
                    <!-- Otomatik Onay -->
                    <div class="advanced-option">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 8px; margin-bottom: 0.75rem;">
                            <div>
                                <div style="font-weight: 600; font-size: 0.9rem; color: var(--slate-700);">✅ Otomatik Randevu Onayı</div>
                                <div style="font-size: 0.75rem; color: var(--slate-500);">Yeni randevular manuel onay gerektirmeden otomatik onaylanır</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="settingAutoApprove" onchange="saveAdvancedSetting('autoApprove', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Randevu İptal Süresi -->
                    <div class="advanced-option">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 8px; margin-bottom: 0.75rem;">
                            <div>
                                <div style="font-weight: 600; font-size: 0.9rem; color: var(--slate-700);">⏰ Minimum İptal Süresi</div>
                                <div style="font-size: 0.75rem; color: var(--slate-500);">Müşteri kaç saat önceye kadar iptal edebilir?</div>
                            </div>
                            <select id="settingMinCancelHours" class="form-input" style="width: auto; padding: 0.4rem 0.6rem;" onchange="saveAdvancedSetting('minCancelHours', this.value)">
                                <option value="0">Sınırsız</option>
                                <option value="1">1 saat</option>
                                <option value="2">2 saat</option>
                                <option value="4">4 saat</option>
                                <option value="12">12 saat</option>
                                <option value="24">24 saat</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Randevu Aralığı -->
                    <div class="advanced-option">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 8px; margin-bottom: 0.75rem;">
                            <div>
                                <div style="font-weight: 600; font-size: 0.9rem; color: var(--slate-700);">📅 Randevu Aralığı</div>
                                <div style="font-size: 0.75rem; color: var(--slate-500);">Randevu slotları kaç dakikada bir olsun?</div>
                            </div>
                            <select id="settingSlotInterval" class="form-input" style="width: auto; padding: 0.4rem 0.6rem;" onchange="saveAdvancedSetting('slotInterval', this.value)">
                                <option value="15">15 dakika</option>
                                <option value="30">30 dakika</option>
                                <option value="45">45 dakika</option>
                                <option value="60">60 dakika</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Maksimum İleri Randevu -->
                    <div class="advanced-option">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 8px; margin-bottom: 0.75rem;">
                            <div>
                                <div style="font-weight: 600; font-size: 0.9rem; color: var(--slate-700);">📆 Maksimum İleri Tarih</div>
                                <div style="font-size: 0.75rem; color: var(--slate-500);">Müşteri en fazla kaç gün sonrası için randevu alabilir?</div>
                            </div>
                            <select id="settingMaxAdvanceDays" class="form-input" style="width: auto; padding: 0.4rem 0.6rem;" onchange="saveAdvancedSetting('maxAdvanceDays', this.value)">
                                <option value="7">1 hafta</option>
                                <option value="14">2 hafta</option>
                                <option value="30">1 ay</option>
                                <option value="60">2 ay</option>
                                <option value="90">3 ay</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- SMS/WhatsApp Hatırlatma -->
                    <div class="advanced-option">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600; font-size: 0.9rem; color: var(--slate-700);">📱 Hatırlatma Bildirimi</div>
                                <div style="font-size: 0.75rem; color: var(--slate-500);">Randevudan önce size bildirim gelir, tek tıkla WhatsApp gönderirsiniz</div>
                            </div>
                            <select id="settingReminderHours" class="form-input" style="width: auto; padding: 0.4rem 0.6rem;" onchange="saveAdvancedSetting('reminderHours', this.value)">
                                <option value="0">Kapalı</option>
                                <option value="0.5">30 dakika önce</option>
                                <option value="1">1 saat önce</option>
                                <option value="2">2 saat önce</option>
                                <option value="3">3 saat önce</option>
                                <option value="4">4 saat önce</option>
                                <option value="6">6 saat önce</option>
                                <option value="12">12 saat önce</option>
                                <option value="24">1 gün önce</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Müşteri Ekleme Modal -->
    <div id="addCustomerModal" class="modal-overlay">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border-radius: var(--radius-lg) var(--radius-lg) 0 0;">
                <h3 class="modal-title">👤 Yeni Müşteri Ekle</h3>
                <button class="modal-close" onclick="closeAddCustomerModal()" style="color: white;">×</button>
            </div>
            <div class="modal-body" style="padding: 1.25rem;">
                <form onsubmit="saveNewCustomer(event)">
                    <div class="form-group">
                        <label class="form-label">Müşteri Adı *</label>
                        <input type="text" id="newCustomerName" class="form-input" placeholder="Ad Soyad" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefon *</label>
                        <input type="tel" id="newCustomerPhone" class="form-input" placeholder="5XX XXX XX XX" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">E-posta (Opsiyonel)</label>
                        <input type="email" id="newCustomerEmail" class="form-input" placeholder="ornek@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Not (Opsiyonel)</label>
                        <textarea id="newCustomerNote" class="form-input" rows="2" placeholder="Müşteri hakkında not..."></textarea>
                    </div>
                    <div class="modal-footer" style="border-top: none; padding-top: 1rem;">
                        <button type="button" class="btn btn-outline" onclick="closeAddCustomerModal()">İptal</button>
                        <button type="submit" class="btn btn-primary">Müşteri Ekle</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Manuel Randevu Ekleme Modal -->
    <div id="manualAppointmentModal" class="modal-overlay">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: var(--radius-lg) var(--radius-lg) 0 0;">
                <h3 class="modal-title">➕ Manuel Randevu Ekle</h3>
                <button class="modal-close" onclick="closeManualAppointmentModal()" style="color: white;">×</button>
            </div>
            <div class="modal-body" style="padding: 1.25rem;">
                <form id="manualAppointmentForm" onsubmit="submitManualAppointment(event)">
                    <!-- Müşteri Seçim/Ekleme Toggle -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <button type="button" id="btnExistingCustomer" class="btn btn-primary btn-sm" onclick="toggleCustomerMode('existing')" style="flex: 1;">
                            📋 Kayıtlı Müşteri
                        </button>
                        <button type="button" id="btnNewCustomer" class="btn btn-outline btn-sm" onclick="toggleCustomerMode('new')" style="flex: 1;">
                            ➕ Yeni Müşteri
                        </button>
                    </div>
                    
                    <!-- Kayıtlı Müşteri Seçimi -->
                    <div id="existingCustomerSection" style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--slate-700); display: block; margin-bottom: 0.35rem;">
                            🔍 Müşteri Ara/Seç
                        </label>
                        <input type="text" id="customerSearchInput" class="form-input" placeholder="İsim veya telefon ile ara..." oninput="searchSavedCustomers()" style="width: 100%; margin-bottom: 0.5rem;">
                        <div id="customerSearchResults" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--slate-200); border-radius: 8px; display: none;">
                            <!-- Arama sonuçları buraya gelecek -->
                        </div>
                        <div id="selectedCustomerInfo" style="display: none; background: var(--success-light); padding: 0.75rem; border-radius: 8px; margin-top: 0.5rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div id="selectedCustomerName" style="font-weight: 600; color: var(--slate-800);"></div>
                                    <div id="selectedCustomerPhone" style="font-size: 0.85rem; color: var(--slate-500);"></div>
                                </div>
                                <button type="button" onclick="clearSelectedCustomer()" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem;">✕</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Yeni Müşteri Bilgileri -->
                    <div id="newCustomerSection" style="display: none;">
                        <div style="margin-bottom: 1rem;">
                            <label style="font-weight: 600; font-size: 0.85rem; color: var(--slate-700); display: block; margin-bottom: 0.35rem;">
                                👤 Müşteri Adı *
                            </label>
                            <input type="text" id="manualCustomerName" class="form-input" placeholder="Ad Soyad" style="width: 100%;">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="font-weight: 600; font-size: 0.85rem; color: var(--slate-700); display: block; margin-bottom: 0.35rem;">
                                📱 Telefon *
                            </label>
                            <input type="tel" id="manualCustomerPhone" class="form-input" placeholder="5XX XXX XX XX" style="width: 100%;">
                        </div>
                    </div>
                    
                    <!-- Tarih ve Saat -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                        <div>
                            <label style="font-weight: 600; font-size: 0.85rem; color: var(--slate-700); display: block; margin-bottom: 0.35rem;">
                                📅 Tarih *
                            </label>
                            <input type="date" id="manualAppointmentDate" class="form-input" required style="width: 100%;">
                        </div>
                        <div>
                            <label style="font-weight: 600; font-size: 0.85rem; color: var(--slate-700); display: block; margin-bottom: 0.35rem;">
                                🕐 Saat *
                            </label>
                            <select id="manualAppointmentTime" class="form-input" required style="width: 100%;">
                                <option value="">Seçin</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Hizmet -->
                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--slate-700); display: block; margin-bottom: 0.35rem;">
                            ✂️ Hizmet *
                        </label>
                        <select id="manualServiceSelect" class="form-input" required style="width: 100%;" onchange="updateManualServicePrice()">
                            <option value="">Hizmet Seçin</option>
                        </select>
                        <div id="manualServicePrice" style="font-size: 0.8rem; color: var(--primary); margin-top: 0.25rem; font-weight: 600;"></div>
                    </div>
                    
                    <!-- Personel -->
                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--slate-700); display: block; margin-bottom: 0.35rem;">
                            👤 Personel
                        </label>
                        <select id="manualStaffSelect" class="form-input" style="width: 100%;">
                            <option value="">Personel Seçin (Opsiyonel)</option>
                        </select>
                    </div>
                    
                    <!-- Not -->
                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--slate-700); display: block; margin-bottom: 0.35rem;">
                            📝 Not (Opsiyonel)
                        </label>
                        <textarea id="manualAppointmentNote" class="form-input" placeholder="Randevu notu..." rows="2" style="width: 100%; resize: none;"></textarea>
                    </div>
                    
                    <!-- Durum -->
                    <div style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--slate-700); display: block; margin-bottom: 0.35rem;">
                            📌 Durum
                        </label>
                        <div style="display: flex; gap: 0.5rem;">
                            <label style="flex: 1; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(16, 185, 129, 0.1); border: 2px solid var(--success); border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="manualStatus" value="confirmed" checked>
                                <span style="font-size: 0.85rem; color: var(--success);">✅ Onaylı</span>
                            </label>
                            <label style="flex: 1; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(245, 158, 11, 0.1); border: 2px solid var(--warning); border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="manualStatus" value="pending">
                                <span style="font-size: 0.85rem; color: var(--warning);">⏳ Bekleyen</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Butonlar -->
                    <div style="display: flex; gap: 0.75rem;">
                        <button type="button" class="btn btn-outline" onclick="closeManualAppointmentModal()" style="flex: 1;">
                            İptal
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 2;">
                            ✅ Randevu Oluştur
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Notification Choice Modal -->
    <div id="notificationModal" class="modal-overlay">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header" id="notifyModalHeader" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: var(--radius-lg) var(--radius-lg) 0 0;">
                <h3 class="modal-title" id="notifyModalTitle">✅ Randevu Onaylandı</h3>
                <button class="modal-close" onclick="closeNotificationModal()" style="color: white;">×</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 2rem;">
                <div style="margin-bottom: 1.5rem;">
                    <div id="notifyModalIcon" style="width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 2rem; background: linear-gradient(135deg, #10b981, #059669); color: white;">✅</div>
                    <p id="notifyModalMessage" style="color: var(--slate-600); font-size: 0.95rem;">Müşteriye WhatsApp ile onay bildirimi göndermek ister misiniz?</p>
                </div>
                
                <div style="background: var(--slate-50); border-radius: var(--radius); padding: 1rem; text-align: left; margin-bottom: 1rem;">
                    <div style="font-weight: 600; color: var(--slate-800); margin-bottom: 0.25rem;" id="notifyCustomerName">-</div>
                    <div style="font-size: 0.85rem; color: var(--slate-500);" id="notifyCustomerPhone">-</div>
                    <div style="font-size: 0.85rem; color: var(--slate-500); margin-top: 0.25rem;" id="notifyAppointmentInfo">-</div>
                </div>
                
                <p style="font-size: 0.8rem; color: var(--warning); margin-bottom: 0; background: var(--warning-light); padding: 0.5rem; border-radius: 6px;">⚠️ Müşterinin haberi olması için bildirim göndermeniz önerilir.</p>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 1rem;">
                <button class="btn btn-success" id="notifySendBtn" onclick="sendWhatsAppFromModal()" style="display: flex; align-items: center; gap: 0.5rem;">
                    📱 Onay Mesajı Gönder
                </button>
                <button class="btn btn-outline" onclick="closeNotificationModal()">Hayır, Kapat</button>
            </div>
        </div>
    </div>
    
    <!-- Service Modal -->
    <div id="serviceModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="serviceModalTitle">Hizmet Ekle</h3>
                <button class="modal-close" onclick="closeServiceModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="serviceForm" onsubmit="saveService(event)">
                    <input type="hidden" id="serviceIndex">
                    <div class="form-group">
                        <label class="form-label">Hizmet Adı</label>
                        <input type="text" id="serviceName" class="form-input" required placeholder="Saç Kesimi">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Süre (dakika)</label>
                            <input type="number" id="serviceDuration" class="form-input" required placeholder="30" min="5" step="5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fiyat (₺)</label>
                            <input type="number" id="servicePrice" class="form-input" required placeholder="150" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">İkon (emoji)</label>
                        <input type="text" id="serviceIcon" class="form-input" placeholder="✂️">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeServiceModal()">İptal</button>
                <button class="btn btn-primary" onclick="document.getElementById('serviceForm').requestSubmit()">Kaydet</button>
            </div>
        </div>
    </div>
    
    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="modal-overlay">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: var(--radius-lg) var(--radius-lg) 0 0;">
                <h3 class="modal-title">⬆️ Paketi Yükselt</h3>
                <button class="modal-close" onclick="closeUpgradeModal()" style="color: white;">×</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">📈</div>
                    <p style="color: var(--slate-600);">Daha fazla personel eklemek için paketinizi yükseltmeniz gerekiyor.</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: var(--slate-100); border-radius: var(--radius); padding: 1rem; text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--slate-500); margin-bottom: 0.25rem;">Mevcut Paket</div>
                        <div style="font-weight: 700; color: var(--slate-700);" id="currentPackageName">-</div>
                        <div style="font-size: 0.85rem; color: var(--slate-500);" id="currentPackageLimit">-</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: var(--radius); padding: 1rem; text-align: center; border: 2px solid #f59e0b;">
                        <div style="font-size: 0.75rem; color: #92400e; margin-bottom: 0.25rem;">Önerilen</div>
                        <div style="font-weight: 700; color: #92400e;" id="suggestedPackageName">-</div>
                        <div style="font-size: 0.85rem; color: #b45309;" id="suggestedPackagePrice">-</div>
                    </div>
                </div>
                
                <div style="background: #f0fdf4; border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
                    <div style="font-weight: 600; color: #166534; margin-bottom: 0.5rem;">✨ Yükseltme ile:</div>
                    <ul style="color: #15803d; font-size: 0.9rem; margin: 0; padding-left: 1.25rem;">
                        <li>Daha fazla personel ekleyin</li>
                        <li>Gelişmiş raporlar</li>
                        <li>Öncelikli destek</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 1rem;">
                <button class="btn" onclick="sendUpgradeRequest()" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                    📩 Yükseltme Talebi Gönder
                </button>
                <button class="btn btn-outline" onclick="closeUpgradeModal()">Şimdilik Vazgeç</button>
            </div>
        </div>
    </div>
    
    <!-- Staff Modal -->
    <div id="staffModal" class="modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="staffModalTitle">Personel Ekle</h3>
                <button class="modal-close" onclick="closeStaffModal()">×</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="staffForm" onsubmit="saveStaff(event)">
                    <input type="hidden" id="staffIndex">
                    
                    <!-- Profil Fotoğrafı -->
                    <div class="form-group" style="text-align: center; margin-bottom: 1.5rem;">
                        <div id="staffPhotoPreview" style="width: 80px; height: 80px; border-radius: 50%; background: var(--slate-200); margin: 0 auto 0.75rem; display: flex; align-items: center; justify-content: center; font-size: 2rem; overflow: hidden; border: 3px solid var(--primary);">
                            👤
                        </div>
                        <input type="file" id="staffPhotoInput" accept="image/*" onchange="previewStaffPhoto(event)" style="display: none;">
                        <button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('staffPhotoInput').click()">
                            📷 Fotoğraf Ekle
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ad Soyad</label>
                        <input type="text" id="staffName" class="form-input" required placeholder="Ahmet Yılmaz">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ünvan</label>
                        <input type="text" id="staffTitle" class="form-input" placeholder="Usta">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefon <span style="color: var(--danger);">*</span></label>
                        <input type="tel" id="staffPhone" class="form-input" required placeholder="05XX XXX XX XX">
                        <p class="form-hint">Giriş ve WhatsApp bildirimleri için</p>
                    </div>
                    
                    <!-- Rol Seçimi -->
                    <div class="form-group">
                        <label class="form-label">Rol</label>
                        <select id="staffRole" class="form-input" onchange="toggleStaffRoleOptions()">
                            <option value="staff">👨‍💼 Personel (Berber/Kuaför)</option>
                            <option value="operator">📞 Operatör (Randevu Yönetimi)</option>
                        </select>
                        <p class="form-hint" id="staffRoleHint">Personel: Kendi randevularını tam yetki ile yönetebilir</p>
                    </div>
                    
                    <div class="form-group" id="staffPinGroup" style="display: none;">
                        <label class="form-label">Giriş PIN Kodu</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="password" id="staffPinInput" class="form-input" style="flex: 1; font-family: monospace; letter-spacing: 2px;" maxlength="6" placeholder="••••••">
                            <button type="button" class="btn btn-outline btn-sm" onclick="toggleStaffPinVisibility()" id="staffPinToggleBtn">👁️</button>
                            <button type="button" class="btn btn-outline btn-sm" onclick="generateNewStaffPin()" title="Yeni PIN Oluştur">🔄</button>
                        </div>
                        <p class="form-hint">6 haneli PIN kodu (giriş için gerekli)</p>
                    </div>
                    
                    <!-- Personel Çalışma Saatleri (sadece staff için görünür) -->
                    <div class="form-group" id="staffHoursSection" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--slate-200);">
                        <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                            🕐 Kişisel Çalışma Saatleri
                            <span style="font-size: 0.7rem; background: var(--slate-200); padding: 0.15rem 0.5rem; border-radius: 10px;">Opsiyonel</span>
                        </label>
                        <p class="form-hint" style="margin-bottom: 0.75rem;">Boş bırakılırsa salon saatleri kullanılır</p>
                        
                        <div id="staffWorkingHours" style="display: grid; gap: 0.5rem; font-size: 0.85rem;">
                            <!-- JavaScript ile doldurulacak -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeStaffModal()">İptal</button>
                <button class="btn btn-primary" onclick="document.getElementById('staffForm').requestSubmit()">Kaydet</button>
            </div>
        </div>
    </div>
    
    <!-- Personel Kapalı Gün/Saat Modal -->
    <div id="staffBlockModal" class="modal-overlay">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                <h3 class="modal-title">🚫 İzin / Kapalı Gün Ekle</h3>
                <button class="modal-close" onclick="closeStaffBlockModal()" style="color: white;">×</button>
            </div>
            <div class="modal-body">
                <form id="staffBlockForm" onsubmit="saveStaffBlock(event)">
                    <input type="hidden" id="blockStaffId">
                    <div class="form-group">
                        <label class="form-label">📅 Tarih *</label>
                        <input type="date" id="blockDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Blok Türü</label>
                        <select id="blockType" class="form-input" onchange="toggleBlockTimeInputs()">
                            <option value="full_day">🚫 Tüm Gün Kapalı</option>
                            <option value="time_range">🕐 Belirli Saatler</option>
                        </select>
                    </div>
                    <div id="blockTimeInputs" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div class="form-group">
                                <label class="form-label">Başlangıç</label>
                                <input type="time" id="blockStartTime" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bitiş</label>
                                <input type="time" id="blockEndTime" class="form-input">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">📝 Sebep (Opsiyonel)</label>
                        <input type="text" id="blockReason" class="form-input" placeholder="Örn: İzin, Hasta, Toplantı">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeStaffBlockModal()">İptal</button>
                <button class="btn btn-primary" onclick="document.getElementById('staffBlockForm').requestSubmit()">Kaydet</button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="toast"></div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js"></script>
    <script src="/config.js"></script>
    
    <script>
        let db;
        let salon = null;
        let appointments = [];
        let currentFilter = 'all';
        let currentStaffFilter = 'all';
        let currentView = 'list';
        let currentWeekStart = getWeekStart(new Date());
        
        const DAYS_TR = {
            mon: 'Pazartesi',
            tue: 'Salı',
            wed: 'Çarşamba',
            thu: 'Perşembe',
            fri: 'Cuma',
            sat: 'Cumartesi',
            sun: 'Pazar'
        };
        
        const DAYS_SHORT = ['Paz', 'Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt'];
        const DAY_KEYS = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        
        const MONTHS_TR = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
        
        // Paket Limitleri - Güncellenmiş 3'lü sistem
        // Paket 1: Ücretsiz (Başlangıç) - Freemium giriş
        // Paket 2: Pro (899₺/ay, yıllık 719₺/ay) - Ana ürün
        // Paket 3: Business (1.599₺/ay, yıllık 1.279₺/ay) - Kurumsal
        const PACKAGE_LIMITS = {
            free: { 
                name: 'Ücretsiz', 
                price: 0,
                yearlyPrice: 0,
                maxStaff: 1, 
                maxAppointments: 999999,
                features: { 
                    sms: false, 
                    whatsapp: true,
                    reports: false, 
                    customerManagement: false,
                    onlinePayment: false,
                    stockTracking: false,
                    webProfile: true
                } 
            },
            pro: { 
                name: 'Pro', 
                price: 899,
                yearlyPrice: 719,
                maxStaff: 5, 
                maxAppointments: 999999, 
                features: { 
                    sms: false, 
                    whatsapp: true,
                    reports: true, 
                    customerManagement: true,
                    onlinePayment: false,
                    stockTracking: true,
                    staffBonus: true,
                    webProfile: true
                } 
            },
            business: { 
                name: 'Business', 
                price: 1599,
                yearlyPrice: 1279,
                maxStaff: 999, 
                maxAppointments: 999999, 
                features: { 
                    sms: false, 
                    whatsapp: true, 
                    reports: true, 
                    customerManagement: true,
                    onlinePayment: true,
                    stockTracking: true,
                    staffBonus: true,
                    webProfile: true,
                    apiAccess: true,
                    whiteLabel: true,
                    dedicatedSupport: true,
                    biAnalytics: true,
                    multiBranch: true
                } 
            },
            // Backward compatibility aliases
            professional: null,
            enterprise: null
        };
        // Backward compat: professional -> pro, enterprise -> business
        PACKAGE_LIMITS.professional = PACKAGE_LIMITS.pro;
        PACKAGE_LIMITS.enterprise = PACKAGE_LIMITS.business;
        
        function getPackageLimit() {
            // Önce salon'daki packageLimits'i kontrol et (admin güncellemesi)
            if (salon?.packageLimits) {
                // packageLimits varsa en güncel bilgiyi oradan al
                const pkgName = PACKAGE_LIMITS[salon?.package]?.name || 
                                salon?.packageName || 
                                'Ücretsiz';
                return {
                    name: pkgName,
                    maxStaff: salon.packageLimits.staff === -1 ? 999 : (salon.packageLimits.staff || 1),
                    maxAppointments: salon.packageLimits.monthlyAppointments === -1 ? 999999 : (salon.packageLimits.monthlyAppointments || 30),
                    features: {
                        sms: false, // SMS kaldırıldı
                        whatsapp: salon.packageLimits.whatsappNotifications !== false,
                        reports: salon.packageLimits.reports || false,
                        customerManagement: salon.packageLimits.customerManagement || false
                    }
                };
            }
            // Fallback: lokal PACKAGE_LIMITS (backward compat: professional->pro, enterprise->business)
            const pkg = salon?.package || 'free';
            return PACKAGE_LIMITS[pkg] || PACKAGE_LIMITS.free;
        }
        
        function canAddStaff() {
            const limit = getPackageLimit();
            const currentStaff = (salon?.staff || []).length;
            return currentStaff < limit.maxStaff;
        }
        
        // Get slug from URL
        function getSlugFromUrl() {
            // Önce URL parametresinden slug'ı al (en güvenilir yol)
            const urlParams = new URLSearchParams(window.location.search);
            const slugParam = urlParams.get('slug');
            if (slugParam) return slugParam;
            
            // Path'den slug'ı al (tüm kategoriler için)
            const path = window.location.pathname;
            
            // /berber/slug/yonetim, /kuafor/slug/yonetim, /beauty/slug/yonetim formatlarını destekle
            // Ancak /berber/salon/yonetim gibi klasör yapılarını hariç tut
            const match = path.match(/\/(berber|kuafor|beauty)\/([^\/]+)\/yonetim/);
            
            if (match) {
                const potentialSlug = match[2];
                // "salon", "kuafor", "yonetim" gibi reserved kelimeler slug olamaz
                const reservedWords = ['salon', 'yonetim', 'kayit', 'index', 'admin'];
                if (reservedWords.includes(potentialSlug.toLowerCase())) {
                    return null;
                }
                return potentialSlug;
            }
            
            return null;
        }
        
        // Süper admin kontrolü
        function isSuperAdmin() {
            const adminSession = localStorage.getItem('zamanli_admin');
            if (adminSession) {
                try {
                    const data = JSON.parse(adminSession);
                    const expiry = data.expiry;
                    // Her iki format da kabul: { verified: true, expiry } veya { pin, expiry }
                    if (expiry && new Date(expiry) > new Date()) {
                        if (data.verified === true || data.pin) {
                            return true;
                        }
                    }
                } catch (e) {
                    return false;
                }
            }
            return false;
        }
        
        // Süper admin olarak salona giriş
        let isSuperAdminMode = false;
        
        // Rol enum sabitleri (STAFF_ROLES - config.js'deki ROLES ile çakışmamak için)
        const STAFF_ROLES = Object.freeze({
            OWNER: 'owner',
            OPERATOR: 'operator',
            STAFF: 'staff'
        });
        
        // Personel modu kontrolü
        let isStaffMode = false;
        let currentStaffId = null;
        let currentStaffName = null;
        let currentStaffRole = null; // STAFF_ROLES.STAFF, STAFF_ROLES.OPERATOR
        
        async function init() {
            console.log('[Init] Başlatılıyor...');
            
            // Firebase yüklenmesini bekle (max 5 saniye)
            let waitTime = 0;
            while (typeof firebase === 'undefined' && waitTime < 5000) {
                await new Promise(r => setTimeout(r, 100));
                waitTime += 100;
            }
            
            if (typeof firebase === 'undefined') {
                console.error('[Init] Firebase yüklenemedi!');
                document.getElementById('loadingOverlay').innerHTML = `
                    <div style="text-align:center;color:#64748b;">
                        <p style="font-size:1.2rem;margin-bottom:1rem;">❌ Bağlantı Hatası</p>
                        <p>Lütfen sayfayı yenileyin veya internet bağlantınızı kontrol edin.</p>
                        <button onclick="location.reload()" style="margin-top:1rem;padding:0.75rem 1.5rem;background:#10B981;color:white;border:none;border-radius:8px;cursor:pointer;">Yenile</button>
                    </div>
                `;
                return;
            }
            
            try {
                db = firebase.firestore();
                
                const urlParams = new URLSearchParams(window.location.search);
                const slug = getSlugFromUrl();
                
                console.log('[Init] Slug:', slug);
                
                // 1. Süper Admin kontrolü - admin=true parametresi ve geçerli admin session'ı varsa
                const adminParam = urlParams.get('admin');
                if (adminParam === 'true' && isSuperAdmin()) {
                    isSuperAdminMode = true;
                    console.log('[Init] Süper Admin modu aktif');
                    if (slug) {
                        await loadSalonData(slug);
                        if (salon) {
                            showDashboard();
                            return;
                        }
                    }
                }
                
                // 2. Personel modu kontrolü
                const staffParam = urlParams.get('staff');
                const staffNameParam = urlParams.get('staffName');
                
                // Önce localStorage'dan personel session'ı kontrol et (sayfa yenilemede kaybolmasın)
                const savedStaffSession = localStorage.getItem('staffSession');
                
                if (savedStaffSession) {
                    try {
                        const session = JSON.parse(savedStaffSession);
                        console.log('[Init] Kayıtlı staff session bulundu:', session);
                        
                        // Session süresi kontrolü (90 gün - PWA için uzun session)
                        if (session.expires && session.expires > Date.now()) {
                            // URL'de slug varsa kontrol et, yoksa session'dan al
                            const targetSlug = slug || session.salonSlug;
                            
                            if (targetSlug) {
                                isStaffMode = true;
                                currentStaffId = session.staffId;
                                currentStaffName = session.staffName;
                                currentStaffRole = session.staffRole || 'staff';
                                
                                console.log('[Init] Personel session geçerli, salon yükleniyor:', targetSlug, 'Rol:', currentStaffRole);
                                await loadSalonData(targetSlug);
                                
                                if (salon) {
                                    console.log('[Init] Personel dashboard gösteriliyor');
                                    showDashboard();
                                    
                                    // Role göre kısıtlamaları uygula (asistan modu kaldırıldı)
                                    if (currentStaffRole === 'assistant') currentStaffRole = 'operator';
                                    if (currentStaffRole === 'operator') {
                                        applyOperatorModeRestrictions();
                                    } else {
                                        applyStaffModeRestrictions();
                                    }
                                    return;
                                }
                            }
                        } else {
                            console.log('[Init] Staff session süresi dolmuş');
                            localStorage.removeItem('staffSession');
                        }
                    } catch (e) {
                        console.error('[Init] Staff session parse hatası:', e);
                        localStorage.removeItem('staffSession');
                    }
                }
                
                // URL'de staff parametresi varsa yeni session oluştur
                if (staffParam && slug && staffNameParam) {
                    console.log('[Init] URL parametrelerinden personel session oluşturuluyor');
                    
                    // Yeni session oluştur - localStorage'a kaydet (90 gün)
                    const newSession = {
                        staffId: decodeURIComponent(staffParam),
                        staffName: decodeURIComponent(staffNameParam),
                        salonSlug: slug,
                        expires: Date.now() + (30 * 24 * 60 * 60 * 1000) // 30 gün (PWA)
                    };
                    localStorage.setItem('staffSession', JSON.stringify(newSession));
                    
                    isStaffMode = true;
                    currentStaffId = newSession.staffId;
                    currentStaffName = newSession.staffName;
                    
                    await loadSalonData(slug);
                    if (salon) {
                        console.log('[Init] Personel dashboard gösteriliyor (URL params)');
                        showDashboard();
                        return;
                    }
                }
                
                // 3. Normal salon sahibi girişi
                const savedSession = localStorage.getItem('salonSession');
                console.log('[Init] === SESSION KONTROL ===');
                console.log('[Init] salonSession var mı:', savedSession ? 'EVET' : 'HAYIR');
                console.log('[Init] URL slug:', slug || 'YOK');
                console.log('[Init] localStorage keys:', Object.keys(localStorage));
                
                if (savedSession) {
                    try {
                        const session = JSON.parse(savedSession);
                        console.log('[Init] Session içerik:', JSON.stringify(session));
                        console.log('[Init] Session expires:', new Date(session.expires).toLocaleString());
                        console.log('[Init] Şu an:', new Date().toLocaleString());
                        console.log('[Init] Session geçerli mi:', session.expires > Date.now() ? 'EVET' : 'HAYIR');
                        
                        // Session süresi dolmamışsa
                        if (session.expires > Date.now()) {
                            // Session'daki slug'ı öncelikli kullan (PWA'da URL kayboluyor)
                            const targetSlug = session.slug || slug;
                            console.log('[Init] Hedef slug:', targetSlug);
                            
                            // URL'de farklı bir slug varsa yeni giriş iste
                            if (slug && slug !== session.slug) {
                                console.log('[Init] Farklı salon için giriş yapılıyor:', slug);
                                showLoginScreen();
                                return;
                            }
                            
                            if (targetSlug) {
                                console.log('[Init] Salon yükleniyor (session):', targetSlug);
                                await loadSalonData(targetSlug);
                                if (salon) {
                                    console.log('[Init] ✅ Dashboard gösteriliyor (salon sahibi)');
                                    showDashboard();
                                    return;
                                } else {
                                    console.log('[Init] ❌ Salon yüklenemedi, session temizleniyor');
                                    localStorage.removeItem('salonSession');
                                }
                            }
                        } else {
                            // Session süresi dolmuş, temizle
                            console.log('[Init] Session süresi dolmuş, temizleniyor');
                            localStorage.removeItem('salonSession');
                        }
                    } catch (e) {
                        console.error('[Init] Session parse hatası:', e);
                        localStorage.removeItem('salonSession');
                    }
                } else {
                    console.log('[Init] salonSession bulunamadı');
                }
                
                // 4. URL'de slug varsa direkt o salon için login ekranı göster
                if (slug) {
                    console.log('[Init] URL slug ile salon yükleniyor (login gerekli):', slug);
                    await loadSalonData(slug);
                }
                
                // Session yok veya geçersiz - login ekranı göster
                console.log('[Init] Login ekranı gösteriliyor');
                showLoginScreen();
            } catch (error) {
                console.error('[Init] Hata:', error);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div style="text-align:center;color:#64748b;">
                        <p style="font-size:1.2rem;margin-bottom:1rem;">❌ Bir hata oluştu</p>
                        <p>${error.message || 'Bilinmeyen hata'}</p>
                        <button onclick="location.reload()" style="margin-top:1rem;padding:0.75rem 1.5rem;background:#10B981;color:white;border:none;border-radius:8px;cursor:pointer;">Yenile</button>
                    </div>
                `;
            }
        }
        
        // Show Login Screen
        function showLoginScreen() {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
        }
        
        // Show Dashboard
        function showDashboard() {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            
            // Süper admin modu ise özel banner göster
            if (isSuperAdminMode) {
                document.getElementById('headerSalonName').textContent = salon.name + ' (Admin)';
                document.getElementById('headerAvatar').textContent = '👑';
                showSuperAdminBanner();
            }
            // Personel modu ise kısıtlı görünüm
            else if (isStaffMode) {
                // Asistan modu kaldırıldı - operator veya staff olarak davran
                if (currentStaffRole === 'assistant') currentStaffRole = 'operator';
                
                if (currentStaffRole === 'operator') {
                    document.getElementById('headerSalonName').textContent = currentStaffName + ' (Operatör)';
                    document.getElementById('headerAvatar').textContent = 'O';
                } else {
                    document.getElementById('headerSalonName').textContent = currentStaffName + ' (Personel)';
                    document.getElementById('headerAvatar').textContent = currentStaffName.charAt(0).toUpperCase();
                }
                
                // Role göre kısıtlamaları uygula
                if (currentStaffRole === 'operator') {
                    applyOperatorModeRestrictions();
                } else {
                    applyStaffModeRestrictions();
                }
                
                // Personel banner'ı göster
                showStaffBanner();
            } else {
                document.getElementById('headerSalonName').textContent = salon.name;
                document.getElementById('headerAvatar').textContent = salon.name.charAt(0).toUpperCase();
            }
            
            // Mobil menü bilgilerini güncelle
            updateMobileMenuInfo();
            
            document.getElementById('viewSalonBtn').href = `/berber/salon/?slug=${salon.slug}&view=public`;
            
            // Load data
            loadAppointments();
            renderServices();
            renderStaff();
            renderWorkingHours();
            loadSettings();
            
            // Setup tabs
            setupTabs();
            setupFilters();
            
            // Yeni layout için staff filter doldur
            populateStaffFiltersNew();
            
            // Randevular yüklendikten sonra yeni görünümü render et
            setTimeout(() => {
                renderWeeklyCalendarNew();
                renderPendingRequests();
                renderTodayAppointments();
                updateStats();
                loadReports();
                loadAdvancedSettings(); // Gelişmiş ayarları yükle
                loadCustomers(); // Müşterileri yükle
                renderPackageLimitBar(); // Free paket limit göstergesi
            }, 500);
        }
        
        // ========== FREE PAKET LİMİT PROGRESS BAR ==========
        function renderPackageLimitBar() {
            // Mevcut progress bar varsa kaldır
            const existing = document.getElementById('packageLimitBar');
            if (existing) existing.remove();
            
            if (!salon) return;
            
            const pkg = (salon.package || 'free').toLowerCase();
            
            // Sadece Free pakette göster
            if (pkg !== 'free') return;
            
            const maxAppointments = 30; // Free paket limiti
            
            // Bu aydaki randevu sayısını hesapla
            const thisMonth = new Date().toISOString().slice(0, 7);
            const monthlyCount = (appointments || []).filter(a => {
                return a.date && a.date.startsWith(thisMonth) && a.status !== 'cancelled';
            }).length;
            
            // Ya da monthlyStats verisi varsa onu kullan
            const appointmentCount = salon.monthlyStats?.appointmentCount || monthlyCount;
            
            const percentage = Math.min(100, Math.round((appointmentCount / maxAppointments) * 100));
            const isLimitReached = appointmentCount >= maxAppointments;
            const barColor = isLimitReached ? '#ef4444' : (percentage > 80 ? '#f59e0b' : '#10B981');
            
            const barHtml = `
                <div id="packageLimitBar" style="background:white;border-radius:12px;padding:1rem 1.25rem;margin-bottom:1rem;border:1px solid ${isLimitReached ? '#fecaca' : '#e2e8f0'};box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
                        <span style="font-weight:600;font-size:0.85rem;color:#334155;">
                            📊 Aylık Randevu Kullanımı (Ücretsiz Paket)
                        </span>
                        <span style="font-weight:700;font-size:0.85rem;color:${barColor};">
                            ${appointmentCount}/${maxAppointments}
                        </span>
                    </div>
                    <div style="background:#f1f5f9;border-radius:999px;height:10px;overflow:hidden;">
                        <div style="background:${barColor};height:100%;width:${percentage}%;border-radius:999px;transition:width 0.5s ease;"></div>
                    </div>
                    ${isLimitReached ? `
                        <div style="margin-top:0.75rem;padding:0.75rem;background:#fef2f2;border-radius:8px;border:1px solid #fecaca;">
                            <p style="font-size:0.8rem;color:#991b1b;margin:0 0 0.5rem 0;font-weight:600;">
                                Aylık randevu limitiniz doldu!
                            </p>
                            <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                                <a href="https://wa.me/905433838587?text=Merhaba, Pro pakete geçmek istiyorum" target="_blank" 
                                   style="display:inline-flex;align-items:center;gap:0.25rem;padding:0.4rem 0.75rem;background:#25d366;color:white;border-radius:6px;text-decoration:none;font-size:0.8rem;font-weight:600;">
                                    💬 WhatsApp ile İletişim
                                </a>
                                <a href="/fiyatlandirma/" target="_blank"
                                   style="display:inline-flex;align-items:center;gap:0.25rem;padding:0.4rem 0.75rem;background:#6366f1;color:white;border-radius:6px;text-decoration:none;font-size:0.8rem;font-weight:600;">
                                    🚀 Pro Pakete Geç
                                </a>
                            </div>
                        </div>
                    ` : percentage > 80 ? `
                        <p style="font-size:0.75rem;color:#92400e;margin-top:0.5rem;">
                            ⚠️ Limitinize yaklaşıyorsunuz. <a href="/fiyatlandirma/" target="_blank" style="color:#6366f1;font-weight:600;">Pro pakete geçerek</a> sınırsız randevu alabilirsiniz.
                        </p>
                    ` : ''}
                </div>
            `;
            
            // Dashboard'un başına ekle
            const dashboard = document.getElementById('dashboard');
            const firstCard = dashboard.querySelector('.tab-content, .dashboard-grid, .card');
            if (firstCard) {
                firstCard.insertAdjacentHTML('beforebegin', barHtml);
            } else {
                dashboard.insertAdjacentHTML('afterbegin', barHtml);
            }
        }
        
        // ===== MOBİL MENÜ FONKSİYONLARI =====
        function openMobileMenu() {
            document.getElementById('mobileSlideMenu').classList.add('active');
            document.getElementById('mobileMenuOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeMobileMenu() {
            document.getElementById('mobileSlideMenu').classList.remove('active');
            document.getElementById('mobileMenuOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function updateMobileMenuInfo() {
            const salonName = salon?.name || 'Salon';
            const avatar = salonName.charAt(0).toUpperCase();
            
            document.getElementById('mobileMenuSalonName').textContent = salonName;
            document.getElementById('mobileMenuAvatar').textContent = avatar;
            document.getElementById('mobileViewSalonBtn').href = `/berber/salon/?slug=${salon?.slug || ''}&view=public`;
        }
        
        function switchTabMobile(tabName) {
            // Desktop tab'ı da değiştir
            switchTab(tabName);
            
            // Mobil menüdeki aktif durumu güncelle
            const mobileLinks = document.querySelectorAll('.mobile-menu-nav a[data-tab]');
            mobileLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.tab === tabName) {
                    link.classList.add('active');
                }
            });
            
            // Menüyü kapat
            closeMobileMenu();
        }
        
        function switchTab(tabName) {
            // Tab butonlarını güncelle
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });
            
            // Tab içeriklerini güncelle
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetContent = document.getElementById('tab-' + tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // Eğer appointments sekmesine geçiliyorsa, staff filtrelerini doldur
            if (tabName === 'appointments') {
                setTimeout(() => {
                    populateStaffFilter('calendarStaffFilter');
                    populateStaffFilter('staffFilterSelect');
                    renderWeeklyCalendar();
                }, 100);
            }
        }
        
        // ===== YENİ LAYOUT FONKSİYONLARI =====
        
        // Ana görünümü göster (Takvim + Talepler)
        function showMainView() {
            document.querySelector('.main-split-view').style.display = 'grid';
            document.querySelector('.top-bar').style.display = 'flex';
            document.getElementById('hiddenTabs').style.display = 'none';
            
            // Mobil menü linklerini güncelle
            document.querySelectorAll('.mobile-menu-nav a').forEach(a => a.classList.remove('active'));
            document.querySelector('.mobile-menu-nav a:first-child').classList.add('active');
        }
        
        // Gizli sekmeleri göster
        function showHiddenTabs(tabName) {
            // Ana görünümü gizle
            document.querySelector('.main-split-view').style.display = 'none';
            document.querySelector('.top-bar').style.display = 'none';
            
            // Gizli sekmeleri göster
            document.getElementById('hiddenTabs').style.display = 'block';
            
            // İlgili tab'ı aktif et
            switchTab(tabName);
            
            // Mobil menüyü kapat
            closeMobileMenu();
            
            // Geri butonu ekle (yoksa)
            addBackButton();
        }
        
        // Geri butonu - artık kullanılmıyor, menüden navigasyon yapılıyor
        function addBackButton() {
            // Ana ekrana dön butonu kaldırıldı - kullanıcılar menüden navigasyon yapacak
            return;
        }
        
        // Süper Admin modu banner'ı
        function showSuperAdminBanner() {
            const banner = document.createElement('div');
            banner.className = 'staff-mode-banner';
            banner.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
            banner.innerHTML = `
                <span>👑 <strong>Süper Admin Modu</strong> - Tüm yetkilere sahipsiniz</span>
                <div style="margin-left: auto; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button onclick="openSuperAdminTools()" class="btn btn-sm btn-outline" style="background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.5);">🛠️ Admin Araçları</button>
                    <button onclick="window.location.href='/admin/'" class="btn btn-sm btn-outline" style="background: white; color: #d97706; border-color: white;">Admin Paneli</button>
                    <button onclick="logoutSuperAdmin()" class="btn btn-sm btn-outline" style="background: transparent; border-color: white; color: white;">Çıkış</button>
                </div>
            `;
            document.querySelector('.dashboard').insertBefore(banner, document.querySelector('.dashboard').firstChild);
        }
        
        // Süper Admin Araçları Modal
        function openSuperAdminTools() {
            let modal = document.getElementById('superAdminToolsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'superAdminToolsModal';
                modal.className = 'modal-overlay';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                        <h3 class="modal-title">👑 Süper Admin Araçları</h3>
                        <button class="modal-close" onclick="closeSuperAdminTools()" style="color: white;">×</button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="font-size: 0.9rem; color: var(--slate-600); margin-bottom: 0.75rem; text-transform: uppercase;">📊 Salon Bilgileri</h4>
                            <div style="background: var(--slate-50); padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                                <p><strong>Salon ID:</strong> ${salon.id}</p>
                                <p><strong>Slug:</strong> ${salon.slug}</p>
                                <p><strong>Durum:</strong> ${salon.active ? '✅ Aktif' : '❌ Pasif'}</p>
                                <p><strong>Oluşturulma:</strong> ${salon.createdAt ? new Date(salon.createdAt).toLocaleDateString('tr-TR') : '-'}</p>
                                <p><strong>Paket:</strong> ${salon.packageName || salon.package || 'Belirtilmemiş'}</p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="font-size: 0.9rem; color: var(--slate-600); margin-bottom: 0.75rem; text-transform: uppercase;">⚡ Hızlı İşlemler</h4>
                            <div style="display: grid; gap: 0.5rem;">
                                <button onclick="toggleSalonStatus()" class="btn ${salon.active ? 'btn-outline' : 'btn-success'}" style="justify-content: flex-start;">
                                    ${salon.active ? '⏸️ Salonu Pasife Al' : '▶️ Salonu Aktifleştir'}
                                </button>
                                <button onclick="clearAllAppointments()" class="btn btn-outline" style="justify-content: flex-start; color: var(--warning);">
                                    🧹 Tüm Randevuları Temizle (İptal edilmişler)
                                </button>
                                <button onclick="resetSalonPin()" class="btn btn-outline" style="justify-content: flex-start;">
                                    🔑 Salon PIN'ini Sıfırla
                                </button>
                                <button onclick="viewSalonLogs()" class="btn btn-outline" style="justify-content: flex-start;">
                                    📋 İşlem Loglarını Gör
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <h4 style="font-size: 0.9rem; color: var(--danger); margin-bottom: 0.75rem; text-transform: uppercase;">⚠️ Tehlikeli İşlemler</h4>
                            <div style="display: grid; gap: 0.5rem;">
                                <button onclick="deleteAllSalonData()" class="btn" style="background: #7f1d1d; color: white; justify-content: flex-start;">
                                    🗑️ Tüm Salon Verilerini Sil
                                </button>
                                <button onclick="deleteSalonCompletely()" class="btn" style="background: #450a0a; color: white; justify-content: flex-start;">
                                    💀 Salonu Tamamen Sil
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="closeSuperAdminTools()">Kapat</button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function closeSuperAdminTools() {
            const modal = document.getElementById('superAdminToolsModal');
            if (modal) modal.classList.remove('active');
        }
        
        // Salon durumunu değiştir (aktif/pasif)
        async function toggleSalonStatus() {
            if (!isSuperAdminMode) return;
            
            const newStatus = !salon.active;
            const action = newStatus ? 'aktifleştirmek' : 'pasife almak';
            
            if (!confirm(`Salonu ${action} istediğinize emin misiniz?`)) return;
            
            try {
                await db.collection('salons').doc(salon.id).update({
                    active: newStatus,
                    updatedAt: new Date().toISOString(),
                    updatedBy: 'super_admin'
                });
                
                salon.active = newStatus;
                showToast(`Salon ${newStatus ? 'aktifleştirildi' : 'pasife alındı'}`, 'success');
                closeSuperAdminTools();
                openSuperAdminTools(); // Refresh modal
                
            } catch (error) {
                console.error('Durum değiştirme hatası:', error);
                showToast('İşlem başarısız', 'error');
            }
        }
        
        // İptal edilmiş randevuları temizle
        async function clearAllAppointments() {
            if (!isSuperAdminMode) return;
            
            const cancelledCount = appointments.filter(a => a.status === 'cancelled').length;
            
            if (cancelledCount === 0) {
                showToast('Temizlenecek iptal edilmiş randevu yok', 'info');
                return;
            }
            
            if (!confirm(`${cancelledCount} adet iptal edilmiş randevuyu kalıcı olarak silmek istediğinize emin misiniz?`)) return;
            
            try {
                const batch = db.batch();
                const cancelledApts = appointments.filter(a => a.status === 'cancelled');
                
                cancelledApts.forEach(apt => {
                    const ref = db.collection('appointments').doc(apt.id);
                    batch.delete(ref);
                });
                
                await batch.commit();
                
                // Lokal listeden kaldır
                appointments = appointments.filter(a => a.status !== 'cancelled');
                
                refreshAllViews();
                showToast(`${cancelledCount} randevu silindi`, 'success');
                closeSuperAdminTools();
                
            } catch (error) {
                console.error('Toplu silme hatası:', error);
                showToast('İşlem başarısız', 'error');
            }
        }
        
        // Salon PIN'ini sıfırla
        async function resetSalonPin() {
            if (!isSuperAdminMode) return;
            
            const newPin = prompt('Yeni PIN girin (4-6 haneli):', '');
            if (!newPin || newPin.length < 4 || newPin.length > 6 || !/^\d+$/.test(newPin)) {
                showToast('Geçerli bir PIN girin (4-6 haneli rakam)', 'error');
                return;
            }
            
            if (!confirm(`Salon PIN'ini "${newPin}" olarak değiştirmek istediğinize emin misiniz?`)) return;
            
            try {
                await db.collection('salons').doc(salon.id).update({
                    pin: newPin,
                    updatedAt: new Date().toISOString(),
                    pinResetBy: 'super_admin',
                    pinResetAt: new Date().toISOString()
                });
                
                salon.pin = newPin;
                showToast(`PIN "${newPin}" olarak değiştirildi`, 'success');
                closeSuperAdminTools();
                
            } catch (error) {
                console.error('PIN değiştirme hatası:', error);
                showToast('İşlem başarısız', 'error');
            }
        }
        
        // İşlem loglarını görüntüle
        function viewSalonLogs() {
            showToast('Log sistemi henüz aktif değil', 'info');
            // İleride: Firestore'dan logları çek ve göster
        }
        
        // Tüm salon verilerini sil (randevular, müşteriler vb.)
        async function deleteAllSalonData() {
            if (!isSuperAdminMode) return;
            
            const confirmText = prompt(`⚠️ DİKKAT: Bu işlem geri alınamaz!\n\nTüm randevuları ve müşteri verilerini silmek için "SİL" yazın:`);
            if (confirmText !== 'SİL') {
                showToast('İşlem iptal edildi', 'info');
                return;
            }
            
            try {
                showToast('Veriler siliniyor...', 'info');
                
                // 1. Tüm randevuları sil
                const appointmentsSnapshot = await db.collection('appointments')
                    .where('salonId', '==', salon.id)
                    .get();
                
                const batch1 = db.batch();
                appointmentsSnapshot.docs.forEach(doc => {
                    batch1.delete(doc.ref);
                });
                await batch1.commit();
                
                // 2. Tüm müşterileri sil
                const customersSnapshot = await db.collection('salons').doc(salon.id)
                    .collection('customers').get();
                
                const batch2 = db.batch();
                customersSnapshot.docs.forEach(doc => {
                    batch2.delete(doc.ref);
                });
                await batch2.commit();
                
                // Lokal verileri temizle
                appointments = [];
                allCustomers = [];
                
                refreshAllViews();
                showToast('Tüm veriler silindi', 'success');
                closeSuperAdminTools();
                
            } catch (error) {
                console.error('Veri silme hatası:', error);
                showToast('İşlem başarısız: ' + error.message, 'error');
            }
        }
        
        // Salonu tamamen sil
        async function deleteSalonCompletely() {
            if (!isSuperAdminMode) return;
            
            const confirmText = prompt(`💀 UYARI: Bu işlem salonu tamamen silecek!\n\nSalon adı: ${salon.name}\nSlug: ${salon.slug}\n\nDevam etmek için salon slug'ını yazın:`);
            if (confirmText !== salon.slug) {
                showToast('İşlem iptal edildi', 'info');
                return;
            }
            
            try {
                showToast('Salon siliniyor...', 'info');
                
                // 1. Tüm randevuları sil
                const appointmentsSnapshot = await db.collection('appointments')
                    .where('salonId', '==', salon.id)
                    .get();
                
                for (const doc of appointmentsSnapshot.docs) {
                    await doc.ref.delete();
                }
                
                // 2. Tüm müşterileri sil
                const customersSnapshot = await db.collection('salons').doc(salon.id)
                    .collection('customers').get();
                
                for (const doc of customersSnapshot.docs) {
                    await doc.ref.delete();
                }
                
                // 3. Push token'ları sil
                const tokensSnapshot = await db.collection('push_tokens')
                    .where('salonId', '==', salon.id)
                    .get();
                
                for (const doc of tokensSnapshot.docs) {
                    await doc.ref.delete();
                }
                
                // 4. Salonu sil
                await db.collection('salons').doc(salon.id).delete();
                
                showToast('Salon tamamen silindi', 'success');
                
                // Admin paneline yönlendir
                setTimeout(() => {
                    window.location.href = '/admin/';
                }, 1500);
                
            } catch (error) {
                console.error('Salon silme hatası:', error);
                showToast('İşlem başarısız: ' + error.message, 'error');
            }
        }
        
        // Süper admin çıkışı
        function logoutSuperAdmin() {
            // Sadece bu salon'dan çık, admin session'ı koru
            window.location.href = '/admin/';
        }
        
        // ========== PERSONEL MODU KISITLAMALARI ==========
        function applyStaffModeRestrictions() {
            console.log('[Staff Mode] Kısıtlamalar uygulanıyor...');
            
            // 1. TAMAMEN GİZLENECEK/KALDIRILACAK SEKMELER (settings DAHİL - personel salon ayarlarına erişemez)
            const hiddenTabs = ['staff', 'services', 'hours', 'settings'];
            
            // Tab butonlarını gizle (masaüstü)
            document.querySelectorAll('.tab[data-tab]').forEach(btn => {
                const tabName = btn.dataset.tab;
                if (hiddenTabs.includes(tabName)) {
                    btn.style.display = 'none';
                }
            });
            
            // Tab içeriklerini tamamen kaldır (DOM'dan sil)
            hiddenTabs.forEach(tabName => {
                const tabContent = document.getElementById(`tab-${tabName}`);
                if (tabContent) tabContent.remove();
            });
            
            // 2. MOBİL MENÜ - Salon Ayarları gizle, Ayarlarım göster
            const menuSalonSettings = document.getElementById('menuSalonSettings');
            if (menuSalonSettings) {
                menuSalonSettings.style.display = 'none';
            }
            
            const menuMySettings = document.getElementById('menuMySettings');
            if (menuMySettings) {
                menuMySettings.style.display = 'flex';
            }
            
            // Profilim menüsünü gizle (sadece owner görebilir)
            const menuMyProfile = document.getElementById('menuMyProfile');
            if (menuMyProfile) menuMyProfile.style.display = 'none';
            
            // Diğer gizli menü öğeleri
            document.querySelectorAll('.mobile-menu-nav a[data-menu-tab]').forEach(link => {
                const tabName = link.getAttribute('data-menu-tab');
                if (hiddenTabs.includes(tabName)) {
                    link.style.display = 'none';
                }
            });
            
            // 3. RANDEVULAR - Başlığı değiştir
            const appointmentsTitle = document.querySelector('.appointments-title');
            if (appointmentsTitle) {
                appointmentsTitle.textContent = '📅 Randevularım';
            }
            
            // 4. MÜŞTERİLER - Başlık değiştir
            setTimeout(() => {
                const customersTab = document.getElementById('tab-customers');
                if (customersTab) {
                    const header = customersTab.querySelector('.card-header h3, .section-title, h3');
                    if (header) header.textContent = '👥 Müşterilerim';
                }
            }, 200);
            
            // 5. RAPORLAR - Başlık değiştir (personel kendi performansını görebilir)
            setTimeout(() => {
                const reportsTab = document.getElementById('tab-reports');
                if (reportsTab) {
                    const header = reportsTab.querySelector('.card-header h3, .section-title, h3');
                    if (header) header.textContent = '📊 Performansım';
                    // Personel performansı bölümünü gizle (sadece kendi verisi var)
                    const staffPerformanceSection = reportsTab.querySelector('#staffPerformance')?.closest('.card');
                    if (staffPerformanceSection) {
                        staffPerformanceSection.style.display = 'none';
                    }
                }
            }, 200);
            
            // 6. ÜST BAR - Hassas istatistikleri gizle (sadece bekleyen ve bugünkü göster)
            const topBarStats = document.querySelector('.top-bar-stats');
            if (topBarStats) {
                topBarStats.querySelectorAll('.mini-stat').forEach((stat, index) => {
                    // Sadece ilk 2 stat'ı göster (bekleyen ve bugünkü)
                    if (index > 1) {
                        stat.style.display = 'none';
                    }
                });
            }
            
            // 7. MANUEL RANDEVU EKLEME - Personel seçimi devre dışı
            setTimeout(() => {
                const manualStaffSelect = document.getElementById('manualStaff');
                if (manualStaffSelect) {
                    manualStaffSelect.value = currentStaffId || currentStaffName;
                    manualStaffSelect.disabled = true;
                    manualStaffSelect.style.opacity = '0.7';
                }
            }, 300);
            
            // 8. HEADER'da salon adını personel adıyla göster
            const headerSalonName = document.getElementById('headerSalonName');
            if (headerSalonName) {
                headerSalonName.textContent = currentStaffName + ' (Personel)';
            }
            const headerAvatar = document.getElementById('headerAvatar');
            if (headerAvatar) {
                headerAvatar.textContent = currentStaffName.charAt(0).toUpperCase();
            }
            
            // 9. MOBİL MENÜ HEADER
            const mobileMenuSalonName = document.getElementById('mobileMenuSalonName');
            if (mobileMenuSalonName) {
                mobileMenuSalonName.textContent = currentStaffName;
            }
            const mobileMenuAvatar = document.getElementById('mobileMenuAvatar');
            if (mobileMenuAvatar) {
                mobileMenuAvatar.textContent = currentStaffName.charAt(0).toUpperCase();
            }
            
            // 10. PERSONEL MODU BANNER (üstte)
            showStaffBanner();
            
            console.log('[Staff Mode] Kısıtlamalar uygulandı - Gizlenen sekmeler:', hiddenTabs.join(', '));
        }
        
        // ========== OPERATÖR MODU KISITLAMALARI ==========
        function applyOperatorModeRestrictions() {
            console.log('[Operator Mode] Kısıtlamalar uygulanıyor...');
            
            // Operatör: Tüm randevuları görebilir, düzenleyebilir, onaylayabilir, iptal edebilir
            // Manuel randevu ekleyebilir, müşterileri görebilir
            // AMA: Personel/hizmet/saat/ayarlar düzenleyemez
            // AMA: Fiyat/ciro/gelir hiçbir yerde GÖRÜNMEZ
            
            // 1. TAMAMEN GİZLENECEK SEKMELER (sadece admin sekmeler)
            const hiddenTabs = ['staff', 'services', 'hours', 'settings'];
            
            document.querySelectorAll('.tab[data-tab]').forEach(btn => {
                const tabName = btn.dataset.tab;
                if (hiddenTabs.includes(tabName)) {
                    btn.style.display = 'none';
                }
            });
            
            hiddenTabs.forEach(tabName => {
                const tabContent = document.getElementById(`tab-${tabName}`);
                if (tabContent) tabContent.remove();
            });
            
            // 2. MOBİL MENÜ - Salon ayarlarını ve Profilim'i gizle
            const menuSalonSettings = document.getElementById('menuSalonSettings');
            if (menuSalonSettings) menuSalonSettings.style.display = 'none';
            const menuMyProfile = document.getElementById('menuMyProfile');
            if (menuMyProfile) menuMyProfile.style.display = 'none';
            
            document.querySelectorAll('.mobile-menu-nav a[data-menu-tab]').forEach(link => {
                const tabName = link.getAttribute('data-menu-tab');
                if (hiddenTabs.includes(tabName)) {
                    link.style.display = 'none';
                }
            });
            
            // 3. HEADER GÜNCELLE
            const headerSalonName = document.getElementById('headerSalonName');
            if (headerSalonName) {
                headerSalonName.textContent = currentStaffName + ' (Operatör)';
            }
            const headerAvatar = document.getElementById('headerAvatar');
            if (headerAvatar) {
                headerAvatar.textContent = 'O';
            }
            
            // 4. OPERATÖR MODU BANNER
            showOperatorBanner();
            
            // 5. FİNANSAL VERİLERİ GİZLE (fiyat, ciro, gelir)
            setTimeout(() => {
                // Üst bar gelir mini stat
                const revenueMini = document.getElementById('statRevenueMini');
                if (revenueMini) revenueMini.closest('.mini-stat').style.display = 'none';
                
                // Dashboard gelir kartı
                const statRevenue = document.getElementById('statRevenue');
                if (statRevenue) statRevenue.closest('.stat-card, .mini-stat')?.style?.setProperty('display', 'none');
                
                // Rapor gelir kartı
                const reportRevenue = document.getElementById('reportTotalRevenue');
                if (reportRevenue) reportRevenue.closest('.report-card')?.style?.setProperty('display', 'none');
                
                // Tüm ₺ işareti içeren elementleri raporlarda gizle
                document.querySelectorAll('#tab-reports .report-card').forEach(card => {
                    const text = card.textContent || '';
                    if (text.includes('Gelir') || text.includes('Ciro') || text.includes('Ücret') || text.includes('₺')) {
                        card.style.display = 'none';
                    }
                });
                
                // Randevu listesinde fiyat sütununu gizle
                document.querySelectorAll('.appointment-price, .service-price, [data-field="price"], [data-field="servicePrice"]').forEach(el => {
                    el.style.display = 'none';
                });
            }, 500);
            
            // 6. FİNANSAL ALANLARI SÜREKLİ GİZLE (MutationObserver)
            const financialObserver = new MutationObserver(() => {
                // Gelir/ciro elementlerini sürekli gizle (yeni veriler yüklendiğinde)
                const revenueMini = document.getElementById('statRevenueMini');
                if (revenueMini && revenueMini.closest('.mini-stat')) revenueMini.closest('.mini-stat').style.display = 'none';
                
                const statRevenue = document.getElementById('statRevenue');
                if (statRevenue && statRevenue.closest('.stat-card, .mini-stat')) {
                    const parent = statRevenue.closest('.stat-card') || statRevenue.closest('.mini-stat');
                    if (parent) parent.style.display = 'none';
                }
            });
            financialObserver.observe(document.body, { childList: true, subtree: true, characterData: true });
            
            console.log('[Operator Mode] Kısıtlamalar uygulandı - Finansal veriler gizli, randevu yetkileri aktif');
        }
        
        function showOperatorBanner() {
            const existingBanner = document.querySelector('.staff-mode-banner');
            if (existingBanner) existingBanner.remove();
            
            const banner = document.createElement('div');
            banner.className = 'staff-mode-banner';
            banner.style.background = 'linear-gradient(135deg, #6366f1, #4f46e5)';
            banner.innerHTML = `
                <span><strong>OPERATÖR MODU</strong> - Randevuları görüntüleyebilir, düzenleyebilir ve yönetebilirsiniz</span>
                <button onclick="logoutStaff()" class="btn btn-sm btn-outline" style="margin-left: auto; background: transparent; border-color: white; color: white;">Çıkış</button>
            `;
            document.querySelector('.dashboard').insertBefore(banner, document.querySelector('.dashboard').firstChild);
        }
        
        // ========== ASİSTAN MODU KISITLAMALARI ==========
        function applyAssistantModeRestrictions() {
            console.log('[Assistant Mode] Kısıtlamalar uygulanıyor...');
            
            // Asistan: Sadece görüntüleme - hiçbir düzenleme yapamaz
            
            // 1. TAMAMEN GİZLENECEK SEKMELER
            const hiddenTabs = ['staff', 'services', 'hours', 'settings'];
            
            document.querySelectorAll('.tab[data-tab]').forEach(btn => {
                const tabName = btn.dataset.tab;
                if (hiddenTabs.includes(tabName)) {
                    btn.style.display = 'none';
                }
            });
            
            hiddenTabs.forEach(tabName => {
                const tabContent = document.getElementById(`tab-${tabName}`);
                if (tabContent) tabContent.remove();
            });
            
            // 2. TÜM DÜZENLEME BUTONLARINI GİZLE
            setTimeout(() => {
                // Manuel randevu ekleme butonu
                document.querySelectorAll('[onclick*="openManualAppointment"]').forEach(btn => {
                    btn.style.display = 'none';
                });
                // Düzenle butonları
                document.querySelectorAll('[onclick*="openEditAppointment"]').forEach(btn => {
                    btn.style.display = 'none';
                });
            }, 500);
            
            // 3. HEADER GÜNCELLE
            const headerSalonName = document.getElementById('headerSalonName');
            if (headerSalonName) {
                headerSalonName.textContent = currentStaffName + ' (Asistan)';
            }
            const headerAvatar = document.getElementById('headerAvatar');
            if (headerAvatar) {
                headerAvatar.textContent = 'A';
            }
            
            // 4. ASİSTAN MODU BANNER
            showAssistantBanner();
            
            console.log('[Assistant Mode] Kısıtlamalar uygulandı');
        }
        
        function showAssistantBanner() {
            const existingBanner = document.querySelector('.staff-mode-banner');
            if (existingBanner) existingBanner.remove();
            
            const banner = document.createElement('div');
            banner.className = 'staff-mode-banner';
            banner.style.background = 'linear-gradient(135deg, #64748b, #475569)';
            banner.innerHTML = `
                <span><strong>ASISTAN MODU</strong> - Sadece goruntuleme yetkisi</span>
                <button onclick="logoutStaff()" class="btn btn-sm btn-outline" style="margin-left: auto; background: transparent; border-color: white; color: white;">Cikis</button>
            `;
            document.querySelector('.dashboard').insertBefore(banner, document.querySelector('.dashboard').firstChild);
        }
        
        // Operatör yetki kontrolü
        function checkOperatorPermission(action) {
            if (isSuperAdminMode) return true;
            if (!isStaffMode) return true;
            if (currentStaffRole !== 'operator') return true;
            
            // Operatörün yapamayacağı işlemler
            const blockedActions = [
                'approveAppointment', 'confirmAppointment',
                'cancelAppointment', 'rejectAppointment',
                'addStaff', 'editStaff', 'deleteStaff',
                'editService', 'addService', 'deleteService',
                'editHours', 'saveHours',
                'editSalon', 'saveSalonSettings'
            ];
            
            if (blockedActions.includes(action)) {
                showToast('Bu işlem için yetkiniz yok. Randevu onay/iptal işlemleri için salon sahibine başvurun.', 'error');
                return false;
            }
            return true;
        }
        
        // Asistan yetki kontrolü
        function checkAssistantPermission(action) {
            if (isSuperAdminMode) return true;
            if (!isStaffMode) return true;
            if (currentStaffRole !== 'assistant') return true;
            
            // Asistan sadece görüntüleyebilir - tüm düzenleme işlemleri engelli
            showToast('Asistan olarak sadece görüntüleme yetkiniz var', 'error');
            return false;
        }
        
        // Personel modu yetki kontrolü - işlem öncesi çağrılacak
        function checkStaffPermission(action) {
            if (isSuperAdminMode) return true; // Süper admin her şeyi yapabilir
            if (!isStaffMode) return true; // Salon sahibi her şeyi yapabilir
            
            // Rol bazlı kontrol
            if (currentStaffRole === 'operator') {
                return checkOperatorPermission(action);
            }
            if (currentStaffRole === 'assistant') {
                return checkAssistantPermission(action);
            }
            
            const blockedActions = [
                'addStaff', 'editStaff', 'deleteStaff',
                'editService', 'addService', 'deleteService',
                'editHours', 'saveHours',
                'editSalon', 'saveSalonSettings'
            ];
            
            if (blockedActions.includes(action)) {
                showToast('Bu işlem için yetkiniz yok', 'error');
                return false;
            }
            return true;
        }
        
        // Personel modu banner'ı - artık küçük bir indicator olarak gösteriyoruz
        function showStaffBanner() {
            // Eski banner varsa kaldır
            const oldBanner = document.querySelector('.staff-mode-banner');
            if (oldBanner) oldBanner.remove();
            
            // Header'a küçük bir indicator ekle
            const header = document.querySelector('.header-left');
            if (header && !document.querySelector('.staff-indicator')) {
                const indicator = document.createElement('span');
                indicator.className = 'staff-indicator';
                indicator.innerHTML = '👤';
                indicator.title = 'Personel Modu';
                indicator.style.cssText = 'margin-left: 0.5rem; font-size: 0.9rem; opacity: 0.7;';
                header.appendChild(indicator);
            }
        }
        
        // ========== OWNER PROFİL MODAL ==========
        async function openOwnerProfileModal() {
            const userId = localStorage.getItem('zamanli_user_uid');
            let profileData = {};
            
            // Mevcut profil verilerini çek (varsa)
            try {
                if (userId) {
                    const userDoc = await db.collection('users').doc(userId).get();
                    if (userDoc.exists) profileData = userDoc.data();
                }
            } catch (e) {
                console.warn('[Profile] Profil çekilemedi:', e);
            }
            
            // Salon verisinden fallback
            if (!profileData.name && salon) {
                profileData.name = salon.ownerName || salon.name || '';
                profileData.phone = salon.phone || '';
                profileData.email = salon.ownerEmail || salon.email || '';
            }
            
            const modal = document.getElementById('modal');
            modal.innerHTML = `
                <div class="modal-overlay active" onclick="closeModal()" style="display:flex;">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width:500px;width:95%;margin:auto;">
                        <div class="modal-header">
                            <h3 class="modal-title">👤 Profilim</h3>
                            <button onclick="closeModal()" class="modal-close">✕</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group" style="margin-bottom:1rem;">
                                <label class="form-label">Ad Soyad</label>
                                <input type="text" id="profileName" class="form-input" value="${profileData.name || ''}" placeholder="Adınız Soyadınız">
                            </div>
                            <div class="form-group" style="margin-bottom:1rem;">
                                <label class="form-label">Telefon</label>
                                <input type="tel" id="profilePhone" class="form-input" value="${profileData.phone || ''}" placeholder="05XX XXX XX XX">
                            </div>
                            <div class="form-group" style="margin-bottom:1rem;">
                                <label class="form-label">E-posta</label>
                                <input type="email" id="profileEmail" class="form-input" value="${profileData.email || ''}" placeholder="mail@ornek.com">
                            </div>
                            <div class="form-group" style="margin-bottom:1rem;">
                                <label class="form-label">Profil Görseli (opsiyonel, max 2MB)</label>
                                <input type="file" id="profileImage" accept="image/*" class="form-input">
                                ${profileData.photoURL ? `<img src="${profileData.photoURL}" style="width:64px;height:64px;border-radius:50%;margin-top:0.5rem;object-fit:cover;">` : ''}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button onclick="closeModal()" class="btn btn-outline">İptal</button>
                            <button onclick="saveMyProfile()" class="btn btn-primary">Kaydet</button>
                        </div>
                    </div>
                </div>
            `;
            modal.style.display = 'block';
        }
        
        async function saveMyProfile() {
            const name = document.getElementById('profileName').value.trim();
            const phone = document.getElementById('profilePhone').value.replace(/\D/g, '');
            const email = document.getElementById('profileEmail').value.trim();
            
            if (!name) { showToast('Ad soyad gerekli', 'error'); return; }
            
            const userId = localStorage.getItem('zamanli_user_uid');
            
            try {
                // users/{uid} doc'una kaydet (userId varsa)
                if (userId) {
                    await db.collection('users').doc(userId).set({
                        name: name,
                        phone: phone,
                        email: email,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                }
                
                // Salon verisini de güncelle (ownerName, ownerEmail)
                if (salon && salon.id) {
                    await db.collection('salons').doc(salon.id).update({
                        ownerName: name,
                        ownerEmail: email,
                        ownerPhone: phone
                    });
                }
                
                // Profil görseli yükleme (Firebase Storage)
                const imageInput = document.getElementById('profileImage');
                if (imageInput && imageInput.files.length > 0) {
                    const file = imageInput.files[0];
                    if (file.size > 2 * 1024 * 1024) {
                        showToast('Profil görseli max 2MB olmalı', 'error');
                        return;
                    }
                    
                    if (!userId) {
                        showToast('Profil kaydedildi ama görsel için yeniden giriş gerekli', 'warning');
                        closeModal();
                        return;
                    }
                    
                    try {
                        const storage = firebase.storage();
                        const ext = file.name.split('.').pop() || 'jpg';
                        const ref = storage.ref(`users/${userId}/profile/avatar.${ext}`);
                        await ref.put(file);
                        const photoURL = await ref.getDownloadURL();
                        
                        await db.collection('users').doc(userId).update({ photoURL });
                        
                        // Salon'a da kaydet
                        if (salon && salon.id) {
                            await db.collection('salons').doc(salon.id).update({ ownerPhotoURL: photoURL });
                        }
                    } catch (uploadErr) {
                        console.warn('[Profile] Görsel yükleme hatası:', uploadErr);
                        showToast('Profil kaydedildi ama görsel yüklenemedi', 'warning');
                        closeModal();
                        return;
                    }
                }
                
                closeModal();
                showToast('Profil başarıyla kaydedildi!', 'success');
            } catch (error) {
                console.error('[Profile] Kaydetme hatası:', error);
                showToast('Profil kaydedilemedi: ' + error.message, 'error');
            }
        }
        
        // Personel ayarları modalı
        function openStaffSettingsModal() {
            if (!isStaffMode || !currentStaffId) {
                showToast('Bu özellik sadece personel modunda kullanılabilir', 'error');
                return;
            }
            
            // Mevcut personel bilgilerini bul
            const staff = (salon?.staff || []).find(s => s.id === currentStaffId || s.name === currentStaffName);
            if (!staff) {
                showToast('Personel bilgileri bulunamadı', 'error');
                return;
            }
            
            // Personelin çalışma saatleri
            const staffHours = staff.workingHours || salon?.workingHours || {};
            const days = [
                { key: 'mon', name: 'Pazartesi' },
                { key: 'tue', name: 'Salı' },
                { key: 'wed', name: 'Çarşamba' },
                { key: 'thu', name: 'Perşembe' },
                { key: 'fri', name: 'Cuma' },
                { key: 'sat', name: 'Cumartesi' },
                { key: 'sun', name: 'Pazar' }
            ];
            
            let hoursHtml = '';
            days.forEach(d => {
                const h = staffHours[d.key] || { open: '09:00', close: '19:00', closed: false };
                hoursHtml += `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: ${h.closed ? 'var(--slate-100)' : 'white'}; border-radius: 6px; margin-bottom: 0.5rem;">
                        <span style="width: 80px; font-size: 0.8rem; font-weight: 500;">${d.name}</span>
                        <input type="time" id="staffHour-${d.key}-open" value="${h.open || '09:00'}" style="padding: 0.25rem; font-size: 0.8rem; border: 1px solid var(--slate-200); border-radius: 4px;" ${h.closed ? 'disabled' : ''}>
                        <span>-</span>
                        <input type="time" id="staffHour-${d.key}-close" value="${h.close || '19:00'}" style="padding: 0.25rem; font-size: 0.8rem; border: 1px solid var(--slate-200); border-radius: 4px;" ${h.closed ? 'disabled' : ''}>
                        <label style="font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                            <input type="checkbox" id="staffHour-${d.key}-closed" ${h.closed ? 'checked' : ''} onchange="toggleStaffDayClosed('${d.key}')">
                            <span style="color: ${h.closed ? 'var(--danger)' : 'var(--slate-500)'};">Kapalı</span>
                        </label>
                    </div>
                `;
            });
            
            // Hizmetler listesi
            const services = salon?.services || [];
            let servicesHtml = '';
            services.forEach((svc, idx) => {
                servicesHtml += `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid var(--slate-200);">
                        <span style="flex: 1; font-size: 0.85rem;">${svc.icon || '✂️'} ${svc.name}</span>
                        <input type="number" id="staffSvcPrice-${idx}" value="${svc.price || 0}" min="0" style="width: 70px; padding: 0.25rem; font-size: 0.85rem; border: 1px solid var(--slate-200); border-radius: 4px; text-align: right;">
                        <span style="font-size: 0.8rem; color: var(--slate-500);">₺</span>
                    </div>
                `;
            });
            
            document.getElementById('staffSettingsModal').innerHTML = `
                <div class="modal-overlay active" onclick="closeStaffSettingsModal(event)">
                    <div class="modal-content staff-settings-modal-content" onclick="event.stopPropagation()" style="max-width: 600px; max-height: 90vh; overflow-y: auto; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 12px 12px 0 0;">
                            <h2 style="color: white;">⚙️ Ayarlarım</h2>
                            <button class="modal-close" onclick="closeStaffSettingsModal()" style="color: white;">×</button>
                        </div>
                        
                        <!-- Tabs -->
                        <div style="display: flex; border-bottom: 2px solid rgba(16, 185, 129, 0.3); background: rgba(255,255,255,0.7);">
                            <button type="button" id="staffSettingsTabProfile" class="staff-settings-tab active" onclick="switchStaffSettingsTab('profile')" style="flex: 1; padding: 0.75rem; font-size: 0.85rem; font-weight: 600; border: none; background: transparent; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px;">
                                👤 Profil
                            </button>
                            <button type="button" id="staffSettingsTabHours" class="staff-settings-tab" onclick="switchStaffSettingsTab('hours')" style="flex: 1; padding: 0.75rem; font-size: 0.85rem; font-weight: 600; border: none; background: transparent; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px;">
                                🕐 Çalışma Saatleri
                            </button>
                            <button type="button" id="staffSettingsTabServices" class="staff-settings-tab" onclick="switchStaffSettingsTab('services')" style="flex: 1; padding: 0.75rem; font-size: 0.85rem; font-weight: 600; border: none; background: transparent; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px;">
                                ✂️ Hizmetler
                            </button>
                        </div>
                        
                        <!-- Profil Tab -->
                        <div id="staffSettingsPanelProfile" class="staff-settings-panel">
                            <form onsubmit="saveStaffSettings(event)">
                                <div class="modal-body" style="background: transparent;">
                                    <div class="form-group" style="text-align: center; margin-bottom: 1.5rem;">
                                        <div class="staff-avatar-large" id="staffSettingsAvatar" style="width: 100px; height: 100px; border-radius: 50%; background: white; border: 3px solid var(--primary); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin: 0 auto 1rem; overflow: hidden; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);">
                                            ${staff.photo ? `<img src="${staff.photo}" style="width: 100%; height: 100%; object-fit: cover;">` : staff.name.charAt(0).toUpperCase()}
                                        </div>
                                        <label class="btn btn-outline btn-sm" style="cursor: pointer; background: white;">
                                            📷 Fotoğraf Değiştir
                                            <input type="file" accept="image/*" onchange="previewStaffSettingsPhoto(event)" style="display: none;">
                                        </label>
                                        <input type="hidden" id="staffSettingsPhotoData" value="${staff.photo || ''}">
                                    </div>
                                    
                                    <div class="form-group" style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                        <label class="form-label">Ad Soyad</label>
                                        <input type="text" id="staffSettingsName" class="form-input" value="${staff.name}" required>
                                    </div>
                                    
                                    <div class="form-group" style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                        <label class="form-label">Telefon</label>
                                        <input type="tel" id="staffSettingsPhone" class="form-input" value="${staff.phone || ''}" placeholder="5XX XXX XX XX">
                                        <small style="color: var(--slate-500);">WhatsApp bildirimleri için kullanılır</small>
                                    </div>
                                    
                                    <div class="form-group" style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                        <label class="form-label">Uzmanlık / Rol</label>
                                        <input type="text" id="staffSettingsRole" class="form-input" value="${staff.role || staff.title || ''}" placeholder="Örn: Berber, Kuaför">
                                    </div>
                                    
                                    <div class="form-group" style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                        <label class="form-label">PIN Değiştir</label>
                                        <input type="password" id="staffSettingsPin" class="form-input" placeholder="Yeni PIN (boş bırakırsan değişmez)" maxlength="6">
                                    </div>
                                </div>
                                <div class="modal-footer" style="background: rgba(255,255,255,0.7); border-top: 1px solid rgba(16, 185, 129, 0.2);">
                                    <button type="button" class="btn btn-outline" onclick="closeStaffSettingsModal()">İptal</button>
                                    <button type="submit" class="btn btn-primary">💾 Profili Kaydet</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Çalışma Saatleri Tab -->
                        <div id="staffSettingsPanelHours" class="staff-settings-panel" style="display: none;">
                            <div class="modal-body" style="background: transparent;">
                                <p style="font-size: 0.85rem; color: var(--slate-600); margin-bottom: 1rem; background: white; padding: 0.75rem; border-radius: 8px;">Kendi çalışma saatlerinizi belirleyebilirsiniz. Müşteriler sadece bu saatler içinde randevu alabilir.</p>
                                <div style="background: white; padding: 1rem; border-radius: 8px;">
                                ${hoursHtml}
                                </div>
                            </div>
                            <div class="modal-footer" style="background: rgba(255,255,255,0.7); border-top: 1px solid rgba(16, 185, 129, 0.2);">
                                <button type="button" class="btn btn-outline" onclick="closeStaffSettingsModal()">İptal</button>
                                <button type="button" class="btn btn-primary" onclick="saveStaffWorkingHours()">💾 Saatleri Kaydet</button>
                            </div>
                        </div>
                        
                        <!-- Hizmetler Tab -->
                        <div id="staffSettingsPanelServices" class="staff-settings-panel" style="display: none;">
                            <div class="modal-body" style="background: transparent;">
                                <p style="font-size: 0.85rem; color: var(--slate-600); margin-bottom: 1rem; background: #fef3c7; padding: 0.75rem; border-radius: 8px; border: 1px solid #f59e0b;">⚠️ Fiyat değişiklikleri salon sahibinin onayına tabidir. Değişiklik talepleri salon sahibine bildirilir.</p>
                                <div style="background: white; padding: 1rem; border-radius: 8px;">
                                ${services.length === 0 ? '<p style="text-align: center; color: var(--slate-400); padding: 2rem;">Henüz hizmet eklenmemiş</p>' : servicesHtml}
                                </div>
                            </div>
                            <div class="modal-footer" style="background: rgba(255,255,255,0.7); border-top: 1px solid rgba(16, 185, 129, 0.2);">
                                <button type="button" class="btn btn-outline" onclick="closeStaffSettingsModal()">İptal</button>
                                <button type="button" class="btn btn-primary" onclick="requestServicePriceChange()">📤 Fiyat Değişikliği Talep Et</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('staffSettingsModal').style.display = 'block';
        }
        
        function switchStaffSettingsTab(tab) {
            // Tüm tabları ve panelleri gizle
            document.querySelectorAll('.staff-settings-tab').forEach(t => {
                t.classList.remove('active');
                t.style.borderBottomColor = 'transparent';
                t.style.color = 'var(--slate-500)';
            });
            document.querySelectorAll('.staff-settings-panel').forEach(p => p.style.display = 'none');
            
            // Seçili tabı aktif et
            const tabBtn = document.getElementById('staffSettingsTab' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if (tabBtn) {
                tabBtn.classList.add('active');
                tabBtn.style.borderBottomColor = 'var(--primary)';
                tabBtn.style.color = 'var(--primary)';
            }
            
            // Paneli göster
            const panel = document.getElementById('staffSettingsPanel' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if (panel) panel.style.display = 'block';
        }
        
        function toggleStaffDayClosed(day) {
            const closed = document.getElementById('staffHour-' + day + '-closed').checked;
            document.getElementById('staffHour-' + day + '-open').disabled = closed;
            document.getElementById('staffHour-' + day + '-close').disabled = closed;
        }
        
        async function saveStaffWorkingHours() {
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const workingHours = {};
            
            days.forEach(day => {
                workingHours[day] = {
                    open: document.getElementById('staffHour-' + day + '-open').value || '09:00',
                    close: document.getElementById('staffHour-' + day + '-close').value || '19:00',
                    closed: document.getElementById('staffHour-' + day + '-closed').checked
                };
            });
            
            try {
                const staffList = [...(salon?.staff || [])];
                const staffIndex = staffList.findIndex(s => s.id === currentStaffId || s.name === currentStaffName);
                
                if (staffIndex >= 0) {
                    staffList[staffIndex] = {
                        ...staffList[staffIndex],
                        workingHours,
                        hoursUpdatedAt: new Date().toISOString()
                    };
                    
                    await db.collection('salons').doc(salon.id).update({ staff: staffList });
                    showToast('Çalışma saatleri kaydedildi!', 'success');
                    closeStaffSettingsModal();
                }
            } catch (err) {
                console.error('Staff hours save error:', err);
                showToast('Kaydetme hatası', 'error');
            }
        }
        
        async function requestServicePriceChange() {
            const services = salon?.services || [];
            const priceChanges = [];
            
            services.forEach((svc, idx) => {
                const newPrice = parseInt(document.getElementById('staffSvcPrice-' + idx)?.value) || 0;
                if (newPrice !== svc.price) {
                    priceChanges.push({
                        serviceId: svc.id,
                        serviceName: svc.name,
                        oldPrice: svc.price,
                        newPrice: newPrice,
                        requestedBy: currentStaffName,
                        requestedAt: new Date().toISOString()
                    });
                }
            });
            
            if (priceChanges.length === 0) {
                showToast('Fiyat değişikliği yapılmadı', 'info');
                return;
            }
            
            try {
                // Fiyat değişiklik taleplerini kaydet
                const currentRequests = salon?.priceChangeRequests || [];
                currentRequests.push(...priceChanges);
                
                await db.collection('salons').doc(salon.id).update({
                    priceChangeRequests: currentRequests,
                    lastPriceRequestAt: new Date().toISOString()
                });
                
                showToast(priceChanges.length + ' fiyat değişikliği talebi gönderildi!', 'success');
                closeStaffSettingsModal();
            } catch (err) {
                console.error('Price change request error:', err);
                showToast('Talep gönderilemedi', 'error');
            }
        }
        
        function closeStaffSettingsModal(e) {
            if (!e || e.target.classList.contains('modal-overlay')) {
                document.getElementById('staffSettingsModal').style.display = 'none';
            }
        }
        
        async function previewStaffSettingsPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 10MB limit
            if (file.size > 10 * 1024 * 1024) {
                showToast('Fotoğraf maksimum 10MB olmalı', 'error');
                return;
            }
            
            try {
                // Resmi sıkıştır
                const compressed = await compressImage(file, 800, 0.8);
                document.getElementById('staffSettingsPhotoData').value = compressed;
                document.getElementById('staffSettingsAvatar').innerHTML = `<img src="${compressed}" style="width: 100%; height: 100%; object-fit: cover;">`;
            } catch (err) {
                showToast('Fotoğraf yüklenirken hata', 'error');
            }
        }
        
        async function saveStaffSettings(e) {
            e.preventDefault();
            
            const name = document.getElementById('staffSettingsName').value.trim();
            const phone = document.getElementById('staffSettingsPhone').value.replace(/\D/g, '').slice(-10);
            const role = document.getElementById('staffSettingsRole').value.trim();
            const newPin = document.getElementById('staffSettingsPin').value.trim();
            const photo = document.getElementById('staffSettingsPhotoData').value;
            
            if (!name) {
                showToast('Ad soyad gerekli', 'error');
                return;
            }
            
            try {
                const staffList = [...(salon?.staff || [])];
                const staffIndex = staffList.findIndex(s => s.id === currentStaffId || s.name === currentStaffName);
                
                if (staffIndex >= 0) {
                    staffList[staffIndex] = {
                        ...staffList[staffIndex],
                        name,
                        phone,
                        role,
                        title: role,
                        photo,
                        ...(newPin ? { pin: newPin } : {}),
                        updatedAt: new Date().toISOString()
                    };
                    
                    await db.collection('salons').doc(salon.id).update({ staff: staffList });
                    
                    // Güncel ismi kaydet
                    currentStaffName = name;
                    document.getElementById('headerSalonName').textContent = name;
                    
                    showToast('Profiliniz güncellendi!', 'success');
                    closeStaffSettingsModal();
                }
            } catch (err) {
                console.error('Staff settings save error:', err);
                showToast('Kaydetme hatası', 'error');
            }
        }
        
        // Personel çıkışı
        function logoutStaff() {
            localStorage.removeItem('staffSession');
            window.location.href = '/berber/';
        }
        
        // Handle Login - Cloud Function ile güvenli auth
        async function handleLogin(e) {
            e.preventDefault();
            
            const phone = document.getElementById('loginPhone').value.trim();
            const pin = document.getElementById('loginPin').value.trim();
            const inputPhone = phone.replace(/\D/g, '').slice(-10);
            
            if (inputPhone.length < 10) {
                showLoginError('Geçerli bir telefon numarası girin');
                return;
            }
            
            if (!pin || pin.length < 4) {
                showLoginError('Geçerli bir PIN kodu girin');
                return;
            }
            
            // Loading göster
            const loginBtn = document.querySelector('#loginScreen button[type="submit"]');
            const originalBtnText = loginBtn.textContent;
            loginBtn.disabled = true;
            loginBtn.textContent = '⏳ Giriş yapılıyor...';
            
            try {
                console.log('[Login] Giriş denemesi, telefon:', inputPhone);
                
                // Önce client-side kontrol (backward compatibility için)
                const allSalonsSnapshot = await db.collection('salons')
                    .where('active', '==', true)
                    .get();
                
                let salonFound = null;
                let isOwner = false;
                let staffData = null;
                
                // Her salonda kontrol et
                for (const doc of allSalonsSnapshot.docs) {
                    const salonData = doc.data();
                    const salonId = doc.id;
                    
                    // 1. Salon sahibi kontrolü
                    const salonPhone = (salonData.phone || '').replace(/\D/g, '').slice(-10);
                    if (salonPhone === inputPhone) {
                        salonFound = { id: salonId, data: salonData };
                        isOwner = true;
                        
                        // Owner staff PIN kontrolü
                        if (salonData.staff) {
                            const owner = salonData.staff.find(s => s.isOwner === true);
                            if (owner) staffData = owner;
                        }
                        break;
                    }
                    
                    // 2. Personel kontrolü
                    const staffArray = salonData.staff || [];
                    const matchedStaff = staffArray.find(s => {
                        const staffPhone = (s.phone || '').replace(/\D/g, '').slice(-10);
                        return staffPhone === inputPhone;
                    });
                    
                    if (matchedStaff) {
                        salonFound = { id: salonId, data: salonData };
                        isOwner = matchedStaff.isOwner || false;
                        staffData = matchedStaff;
                        break;
                    }
                }
                
                if (!salonFound) {
                    showLoginError('Telefon numarası veya PIN hatalı');
                    loginBtn.disabled = false;
                    loginBtn.textContent = originalBtnText;
                    return;
                }
                
                // PIN doğrulaması - Her zaman Cloud Function (server-side bcrypt + rate-limit)
                // Düz metin PIN'ler Cloud Function'da lazy migrate edilir
                try {
                    const verifyPinFn = firebase.app().functions('europe-west1').httpsCallable('verifyPinAuth');
                    // Owner girişinde staffId gönderme (salon PIN kullanılır)
                    const effectiveStaffId = (!isOwner && staffData) ? (staffData.id || staffData.name || null) : null;
                    const result = await verifyPinFn({
                        salonId: salonFound.id,
                        pin: pin,
                        phone: inputPhone,
                        userType: isOwner ? 'owner' : 'staff',
                        staffId: effectiveStaffId
                    });
                    
                    if (result.data && result.data.success) {
                        console.log('[Login] PIN doğrulaması başarılı');
                        
                        // Firebase Auth Custom Token ile oturum aç
                        if (result.data.customToken) {
                            try {
                                const userCred = await firebase.auth().signInWithCustomToken(result.data.customToken);
                                console.log('[Login] Firebase Auth oturumu açıldı');
                                // UID kaydet (profil için)
                                if (result.data.userData && result.data.userData.uid) {
                                    localStorage.setItem('zamanli_user_uid', result.data.userData.uid);
                                } else if (userCred.user) {
                                    localStorage.setItem('zamanli_user_uid', userCred.user.uid);
                                }
                            } catch (authErr) {
                                console.warn('[Login] Custom token signIn hatası (devam ediliyor):', authErr);
                            }
                        }
                        
                        if (isOwner) {
                            loginAsOwner(salonFound.id, salonFound.data);
                        } else if (staffData) {
                            loginAsStaff(staffData, salonFound.id, salonFound.data);
                        }
                        return;
                    }
                } catch (pinError) {
                    console.error('[Login] PIN doğrulama hatası:', pinError);
                    showLoginError(pinError.message || 'Telefon numarası veya PIN hatalı');
                    return;
                }
                
                showLoginError('Telefon numarası veya PIN hatalı');
                
            } catch (error) {
                console.error('[Login] Hata:', error);
                showLoginError('Bir hata oluştu. Lütfen tekrar deneyin.');
            } finally {
                // Loading kaldır
                loginBtn.disabled = false;
                loginBtn.textContent = originalBtnText;
            }
        }
        
        // Salon sahibi olarak giriş yap
        function loginAsOwner(salonId, salonData) {
            const session = {
                type: 'owner',
                slug: salonData.slug,
                salonId: salonId,
                expires: Date.now() + (30 * 24 * 60 * 60 * 1000) // 30 gün (PWA)
            };
            localStorage.setItem('salonSession', JSON.stringify(session));
            
            // Personel modunu kapat
            isStaffMode = false;
            currentStaffId = null;
            currentStaffName = null;
            
            salon = { id: salonId, ...salonData };
            showDashboard();
            console.log('[Login] Salon sahibi girişi başarılı:', salonData.name);
        }
        
        // Personel olarak giriş yap
        function loginAsStaff(matchedStaff, salonId, salonData) {
            // Rol belirleme - varsayılan "staff", assistant -> operator'e map edilir
            let staffRole = matchedStaff.staffRole || matchedStaff.role || 'staff';
            // Asistan modu kaldırıldı - eski asistan'lar operatör olarak giriş yapar
            if (staffRole === 'assistant') staffRole = 'operator';
            
            const staffSession = {
                type: 'staff',
                staffId: matchedStaff.id || matchedStaff.name,
                staffName: matchedStaff.name,
                staffRole: staffRole, // staff, operator
                salonId: salonId,
                salonSlug: salonData.slug,
                expires: Date.now() + (30 * 24 * 60 * 60 * 1000) // 30 gün (PWA)
            };
            localStorage.setItem('staffSession', JSON.stringify(staffSession));
            localStorage.removeItem('salonSession'); // Eski owner session'ı temizle
            
            // Personel modunu aktif et
            isStaffMode = true;
            currentStaffId = staffSession.staffId;
            currentStaffName = staffSession.staffName;
            currentStaffRole = staffRole; // Global değişken
            
            salon = { id: salonId, ...salonData };
            showDashboard();
            
            // Role göre kısıtlamaları uygula (asistan modu kaldırıldı)
            if (staffRole === 'operator') {
                applyOperatorModeRestrictions();
            } else {
                applyStaffModeRestrictions();
            }
            
            console.log('[Login] Personel girişi başarılı:', matchedStaff.name, 'Rol:', staffRole, 'Salon:', salonData.name);
        }
        
        // Show Login Error
        function showLoginError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
        
        // Load Salon Data
        // Global salon listener referansı
        let salonListener = null;
        
        async function loadSalonData(slug) {
            try {
                // Önce mevcut listener'ı temizle
                if (salonListener) {
                    salonListener();
                    salonListener = null;
                }
                
                const snapshot = await db.collection('salons')
                    .where('slug', '==', slug)
                    .limit(1)
                    .get();
                
                if (!snapshot.empty) {
                    salon = {
                        id: snapshot.docs[0].id,
                        ...snapshot.docs[0].data()
                    };
                    
                    // Real-time salon dinleme başlat
                    startSalonListener(snapshot.docs[0].id);
                    
                    // Push notification banner'ı kontrol et
                    if (typeof checkAndShowPushBanner === 'function') {
                        checkAndShowPushBanner(salon.id);
                    }
                }
            } catch (error) {
                console.error('Error loading salon:', error);
            }
        }
        
        // Salon verilerini real-time dinle (admin güncellemeleri için)
        function startSalonListener(salonId) {
            if (salonListener) {
                salonListener();
            }
            
            console.log('[Salon Listener] Real-time dinleme başlatılıyor:', salonId);
            
            salonListener = db.collection('salons').doc(salonId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const oldSalon = { ...salon };
                        salon = { id: doc.id, ...doc.data() };
                        
                        // Değişiklik varsa UI'ı güncelle
                        const hasChanges = JSON.stringify(oldSalon) !== JSON.stringify(salon);
                        if (hasChanges) {
                            console.log('[Salon Listener] Salon güncellendi:', salon.name);
                            
                            // PAKET DEĞİŞİKLİĞİ KONTROLÜ
                            if (oldSalon.id && oldSalon.package !== salon.package) {
                                const pkgLimit = getPackageLimit();
                                showToast(`🎉 Paketiniz "${pkgLimit.name}" olarak güncellendi!`, 'success');
                                console.log('[Salon Listener] Paket değişti:', oldSalon.package, '->', salon.package);
                            }
                            
                            // PAKET LİMİTLERİ DEĞİŞİKLİĞİ
                            if (oldSalon.id && JSON.stringify(oldSalon.packageLimits) !== JSON.stringify(salon.packageLimits)) {
                                console.log('[Salon Listener] Paket limitleri güncellendi');
                                // Personel butonunu güncelle
                                if (typeof updateAddStaffButton === 'function') updateAddStaffButton();
                            }
                            
                            // Header'ı güncelle
                            updateSalonHeader();
                            
                            // Hizmetleri güncelle
                            if (typeof renderServices === 'function') renderServices();
                            
                            // Personelleri güncelle
                            if (typeof renderStaff === 'function') renderStaff();
                            
                            // Çalışma saatlerini güncelle
                            if (typeof renderWorkingHours === 'function') renderWorkingHours();
                            
                            // Ayarları güncelle
                            if (typeof loadSettings === 'function') loadSettings();
                            
                            // Bildirim göster (ilk yükleme değilse ve paket değişikliği değilse)
                            if (oldSalon.id && oldSalon.package === salon.package) {
                                showToast('Salon bilgileri güncellendi', 'info');
                            }
                        }
                    }
                }, (error) => {
                    console.error('[Salon Listener] Hata:', error);
                });
        }
        
        // Salon header'ını güncelle
        function updateSalonHeader() {
            const headerName = document.getElementById('headerSalonName');
            const headerAvatar = document.getElementById('headerAvatar');
            const mobileMenuSalonName = document.getElementById('mobileMenuSalonName');
            const mobileMenuAvatar = document.getElementById('mobileMenuAvatar');
            
            if (isSuperAdminMode) {
                if (headerName) headerName.textContent = salon.name + ' (Admin)';
                if (headerAvatar) headerAvatar.textContent = '👑';
            } else if (isStaffMode) {
                if (headerName) headerName.textContent = currentStaffName + ' (Personel)';
                if (headerAvatar) headerAvatar.textContent = currentStaffName.charAt(0).toUpperCase();
            } else {
                if (headerName) headerName.textContent = salon.name;
                if (headerAvatar) headerAvatar.textContent = salon.name.charAt(0).toUpperCase();
            }
            
            if (mobileMenuSalonName) mobileMenuSalonName.textContent = salon.name;
            if (mobileMenuAvatar) mobileMenuAvatar.textContent = salon.name.charAt(0).toUpperCase();
        }
        
        // Load Appointments
        // Global listener referansı
        let appointmentsListener = null;
        
        async function loadAppointments() {
            try {
                const snapshot = await db.collection('appointments')
                    .where('salonId', '==', salon.id)
                    .orderBy('date', 'desc')
                    .limit(100)
                    .get();
                
                appointments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Personel modunda sadece kendi randevularını göster
                if (isStaffMode && currentStaffId) {
                    appointments = appointments.filter(a => a.staffId === currentStaffId || a.staffName === currentStaffName);
                }
                
                refreshAllViews();
                
                // Hatırlatma kontrolünü başlat
                checkAppointmentReminders();
                
                // Real-time listener'ı başlat (ilk yüklemeden sonra)
                startAppointmentsListener();
                
            } catch (error) {
                console.error('Error loading appointments:', error);
                // Try without ordering (index might not exist)
                try {
                    const snapshot = await db.collection('appointments')
                        .where('salonId', '==', salon.id)
                        .get();
                    
                    appointments = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    })).sort((a, b) => {
                        const dateA = a.date || '';
                        const dateB = b.date || '';
                        if (dateB > dateA) return 1;
                        if (dateB < dateA) return -1;
                        return 0;
                    });
                    
                    // Personel modunda sadece kendi randevularını göster
                    if (isStaffMode && currentStaffId) {
                        appointments = appointments.filter(a => a.staffId === currentStaffId || a.staffName === currentStaffName);
                    }
                    
                    refreshAllViews();
                    checkAppointmentReminders();
                    startAppointmentsListener();
                } catch (e) {
                    console.error('Fallback also failed:', e);
                }
            }
        }
        
        // ========== HATIRLATMA SİSTEMİ ==========
        
        let reminderCheckInterval = null;
        let sentReminders = JSON.parse(localStorage.getItem('sentReminders') || '{}');
        
        function checkAppointmentReminders() {
            // Önceki interval varsa temizle
            if (reminderCheckInterval) {
                clearInterval(reminderCheckInterval);
            }
            
            // Hatırlatma ayarını kontrol et
            const reminderHours = parseFloat(salon?.advancedSettings?.reminderHours) || 0;
            if (reminderHours === 0) {
                console.log('[Reminder] Hatırlatma kapalı');
                return;
            }
            
            console.log('[Reminder] Hatırlatma aktif:', reminderHours, 'saat önce');
            
            // İlk kontrolü hemen yap
            doReminderCheck(reminderHours);
            
            // Her 5 dakikada bir kontrol et
            reminderCheckInterval = setInterval(() => {
                doReminderCheck(reminderHours);
            }, 5 * 60 * 1000);
        }
        
        function doReminderCheck(reminderHours) {
            const now = new Date();
            const reminderMinutes = reminderHours * 60;
            
            // Bugün ve yarın için kontrol et
            const today = now.toISOString().split('T')[0];
            const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            appointments.forEach(apt => {
                // Sadece onaylı veya bekleyen randevuları kontrol et
                if (!['pending', 'confirmed'].includes(apt.status)) return;
                
                // Sadece bugün veya yarın olan randevuları kontrol et
                if (apt.date !== today && apt.date !== tomorrow) return;
                
                // Bu randevu için zaten hatırlatma gönderildi mi?
                const reminderKey = `${apt.id}_${reminderHours}`;
                if (sentReminders[reminderKey]) return;
                
                // Randevu zamanını hesapla
                const [aptHour, aptMin] = apt.time.split(':').map(Number);
                const aptDate = new Date(apt.date + 'T' + apt.time + ':00');
                
                // Hatırlatma zamanı
                const reminderTime = new Date(aptDate.getTime() - reminderMinutes * 60 * 1000);
                
                // Şu an hatırlatma zamanı mı?
                const timeDiff = reminderTime.getTime() - now.getTime();
                
                // -5 dakika ile +5 dakika arasında ise hatırlatma göster
                if (timeDiff >= -5 * 60 * 1000 && timeDiff <= 5 * 60 * 1000) {
                    showReminderNotification(apt, reminderHours);
                    
                    // Gönderildi olarak işaretle
                    sentReminders[reminderKey] = Date.now();
                    localStorage.setItem('sentReminders', JSON.stringify(sentReminders));
                }
            });
            
            // Eski hatırlatmaları temizle (24 saatten eski)
            const cutoff = Date.now() - 24 * 60 * 60 * 1000;
            Object.keys(sentReminders).forEach(key => {
                if (sentReminders[key] < cutoff) {
                    delete sentReminders[key];
                }
            });
            localStorage.setItem('sentReminders', JSON.stringify(sentReminders));
        }
        
        function showReminderNotification(apt, hours) {
            const hoursText = hours < 1 ? `${hours * 60} dakika` : `${hours} saat`;
            
            // Personel modunda sadece kendi randevuları için bildirim
            if (isStaffMode) {
                if (apt.staffId !== currentStaffId && apt.staffName !== currentStaffName) {
                    return;
                }
            }
            
            // Toast göster
            showToast(`⏰ ${apt.customerName} - ${hoursText} sonra randevu var!`, 'warning');
            
            // Tarayıcı bildirimi göster
            if (Notification.permission === 'granted') {
                const notif = new Notification('⏰ Randevu Hatırlatması', {
                    body: `${apt.customerName} - ${apt.time}\nHatırlatma mesajı göndermek ister misiniz?`,
                    icon: '/icons/icon-192x192.png',
                    tag: 'reminder-' + apt.id,
                    requireInteraction: true,
                    actions: [
                        { action: 'send', title: '📱 WhatsApp Gönder' },
                        { action: 'dismiss', title: 'Kapat' }
                    ]
                });
                
                notif.onclick = () => {
                    window.focus();
                    openReminderModal(apt);
                    notif.close();
                };
            }
            
            // Uygulama içi hatırlatma modal'ı göster
            openReminderModal(apt);
        }
        
        function openReminderModal(apt) {
            // Mevcut modal varsa kapat
            const existingModal = document.getElementById('reminderModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const formattedDate = formatDate(apt.date);
            const salonLink = `https://zamanli.com/berber/salon/?slug=${salon.slug}`;
            const reminderMessage = `Merhaba ${apt.customerName},

RANDEVU HATIRLATMASI

${salon.name}
Tarih: ${formattedDate}
Saat: ${apt.time}
Hizmet: ${apt.service || 'Belirtilmedi'}
${apt.staffName ? `Personel: ${apt.staffName}` : ''}

Adres: ${salon.address || 'Salonumuzda'}
${salon.phone ? `Tel: ${salon.phone}` : ''}

Online Randevu: ${salonLink}

Sizi bekliyoruz!

${salon.name}`;
            
            const whatsappUrl = `https://wa.me/90${apt.customerPhone}?text=${encodeURIComponent(reminderMessage)}`;
            
            const modal = document.createElement('div');
            modal.id = 'reminderModal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: var(--radius-lg) var(--radius-lg) 0 0;">
                        <h3 class="modal-title">⏰ Hatırlatma Zamanı!</h3>
                        <button class="modal-close" onclick="closeReminderModal()" style="color: white;">×</button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="width: 60px; height: 60px; background: var(--warning); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto 1rem;">
                                ⏰
                            </div>
                            <h4 style="margin-bottom: 0.5rem;">${apt.customerName}</h4>
                            <p style="color: var(--slate-500);">${apt.time} - ${apt.service || 'Randevu'}</p>
                        </div>
                        
                        <div style="background: var(--slate-50); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; font-size: 0.85rem; white-space: pre-line; max-height: 150px; overflow-y: auto;">
${reminderMessage}
                        </div>
                        
                        <a href="${whatsappUrl}" target="_blank" 
                           onclick="closeReminderModal(); markReminderSent('${apt.id}');"
                           style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: #25D366; color: white; padding: 0.875rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600; margin-bottom: 0.75rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            WhatsApp ile Gönder
                        </a>
                        
                        <button onclick="closeReminderModal()" class="btn btn-outline" style="width: 100%;">
                            Şimdi Değil
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 30 saniye sonra otomatik kapat
            setTimeout(() => {
                if (document.getElementById('reminderModal')) {
                    closeReminderModal();
                }
            }, 30000);
        }
        
        function closeReminderModal() {
            const modal = document.getElementById('reminderModal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
        }
        
        function markReminderSent(aptId) {
            // Firebase'de işaretle
            db.collection('appointments').doc(aptId).update({
                reminderSentAt: new Date().toISOString(),
                reminderSentBy: isStaffMode ? currentStaffName : 'Salon Sahibi'
            }).catch(err => console.log('Reminder mark error:', err));
        }
        
        // ========== REAL-TIME SYNC SİSTEMİ ==========
        
        // Tüm görünümleri güncelle
        function refreshAllViews() {
            try {
                updateStats();
                renderAppointments();
                renderWeeklyCalendar();
                renderWeeklyCalendarNew();
                renderPendingRequests();
                renderTodayAppointments();
            } catch (e) {
                console.error('[Sync] Görünüm güncelleme hatası:', e);
            }
        }
        
        // Real-time listener başlat
        function startAppointmentsListener() {
            // Mevcut listener varsa kapat
            if (appointmentsListener) {
                appointmentsListener();
                appointmentsListener = null;
            }
            
            if (!salon?.id) {
                console.log('[Sync] Salon ID yok, listener başlatılamadı');
                return;
            }
            
            console.log('[Sync] Real-time listener başlatılıyor...');
            
            // Listener başlangıç zamanı
            const listenerStartTime = Date.now();
            
            // İLK SNAPSHOT'I ATLA - bu sayede mevcut randevular için bildirim gelmez
            let isFirstSnapshot = true;
            
            // Görülen randevu ID'lerini localStorage'da tut
            const seenAppointmentsKey = `seenAppointments_${salon.id}`;
            let seenAppointments = JSON.parse(localStorage.getItem(seenAppointmentsKey) || '[]');
            
            // Mevcut randevuları seen olarak işaretle
            appointments.forEach(apt => {
                if (apt.id && !seenAppointments.includes(apt.id)) {
                    seenAppointments.push(apt.id);
                }
            });
            if (seenAppointments.length > 500) {
                seenAppointments = seenAppointments.slice(-500);
            }
            localStorage.setItem(seenAppointmentsKey, JSON.stringify(seenAppointments));
            
            try {
                appointmentsListener = db.collection('appointments')
                    .where('salonId', '==', salon.id)
                    .onSnapshot(
                        (snapshot) => {
                            // İLK SNAPSHOT'I ATLA - mevcut veriler için bildirim gösterme
                            if (isFirstSnapshot) {
                                isFirstSnapshot = false;
                                console.log('[Sync] İlk snapshot atlandı, mevcut randevu sayısı:', snapshot.size);
                                
                                // İlk snapshot'taki tüm ID'leri seen olarak işaretle
                                snapshot.docs.forEach(doc => {
                                    if (!seenAppointments.includes(doc.id)) {
                                        seenAppointments.push(doc.id);
                                    }
                                });
                                localStorage.setItem(seenAppointmentsKey, JSON.stringify(seenAppointments));
                                return; // İlk snapshot için işlem yapma
                            }
                            
                            let hasChanges = false;
                            
                            snapshot.docChanges().forEach(change => {
                                const apt = { id: change.doc.id, ...change.doc.data() };
                                
                                if (change.type === 'added') {
                                    // Yeni randevu - listede yoksa ekle
                                    const exists = appointments.find(a => a.id === apt.id);
                                    if (!exists) {
                                        appointments.push(apt);
                                        hasChanges = true;
                                        console.log('[Sync] Yeni randevu eklendi:', apt.customerName);
                                        
                                        // BİLDİRİM KONTROLÜ
                                        const alreadySeen = seenAppointments.includes(apt.id);
                                        
                                        // Randevu oluşturulma zamanını kontrol et
                                        let createdAt = null;
                                        if (apt.createdAt) {
                                            if (apt.createdAt.toDate) {
                                                createdAt = apt.createdAt.toDate().getTime();
                                            } else if (apt.createdAt.seconds) {
                                                createdAt = apt.createdAt.seconds * 1000;
                                            } else {
                                                createdAt = new Date(apt.createdAt).getTime();
                                            }
                                        }
                                        
                                        // Son 30 saniye içinde oluşturulmuş mu?
                                        const isRecent = createdAt && (Date.now() - createdAt < 30 * 1000);
                                        
                                        console.log('[Sync] Bildirim kontrolü:', {
                                            alreadySeen,
                                            isRecent,
                                            status: apt.status,
                                            createdAt: createdAt ? new Date(createdAt).toISOString() : null
                                        });
                                        
                                        // SADECE yeni ve görülmemiş randevular için bildirim göster
                                        // Personel modunda sadece kendi randevuları için bildirim göster
                                        const shouldNotify = !alreadySeen && isRecent && apt.status === 'pending';
                                        const isMyAppointment = !isStaffMode || 
                                            apt.staffId === currentStaffId || 
                                            apt.staffName === currentStaffName ||
                                            (!apt.staffId && !apt.staffName); // Personel atanmamış randevular salon sahibine
                                        
                                        if (shouldNotify && isMyAppointment) {
                                            console.log('[Sync] 🔔 Bildirim gösteriliyor:', apt.customerName, isStaffMode ? '(Personel modu)' : '(Salon sahibi)');
                                            if (NotificationManager?.notifyNewAppointment) {
                                                NotificationManager.notifyNewAppointment(apt);
                                            }
                                            showToast(`🔔 Yeni randevu: ${apt.customerName}`, 'info');
                                        } else if (shouldNotify && !isMyAppointment) {
                                            console.log('[Sync] Bildirim atlandı - farklı personele ait:', apt.staffName || apt.staffId);
                                        }
                                        
                                        // Görülen randevulara ekle
                                        if (!alreadySeen) {
                                            seenAppointments.push(apt.id);
                                            if (seenAppointments.length > 500) {
                                                seenAppointments = seenAppointments.slice(-500);
                                            }
                                            localStorage.setItem(seenAppointmentsKey, JSON.stringify(seenAppointments));
                                        }
                                    }
                                } else if (change.type === 'modified') {
                                    // Randevu güncellendi
                                    const index = appointments.findIndex(a => a.id === apt.id);
                                    if (index !== -1) {
                                        const oldStatus = appointments[index].status;
                                        appointments[index] = apt;
                                        hasChanges = true;
                                        console.log('[Sync] Randevu güncellendi:', apt.customerName, oldStatus, '→', apt.status);
                                        
                                        // Durum değişikliği bildirimi
                                        if (oldStatus !== apt.status) {
                                            showStatusChangeToast(apt, oldStatus);
                                        }
                                    }
                                } else if (change.type === 'removed') {
                                    // Randevu silindi
                                    const index = appointments.findIndex(a => a.id === apt.id);
                                    if (index !== -1) {
                                        appointments.splice(index, 1);
                                        hasChanges = true;
                                        console.log('[Sync] Randevu silindi:', apt.customerName);
                                    }
                                }
                            });
                            
                            // Değişiklik varsa görünümleri güncelle
                            if (hasChanges) {
                                // Personel modunda filtreleme
                                if (isStaffMode && currentStaffId) {
                                    appointments = appointments.filter(a => 
                                        a.staffId === currentStaffId || a.staffName === currentStaffName
                                    );
                                }
                                
                                refreshAllViews();
                            }
                        },
                        (error) => {
                            console.error('[Sync] Listener hatası:', error);
                            // Hata durumunda 5 saniye sonra tekrar dene
                            setTimeout(() => {
                                console.log('[Sync] Listener yeniden başlatılıyor...');
                                startAppointmentsListener();
                            }, 5000);
                        }
                    );
                
                console.log('[Sync] Listener aktif');
            } catch (e) {
                console.error('[Sync] Listener başlatılamadı:', e);
            }
        }
        
        // Durum değişikliği bildirimi
        function showStatusChangeToast(apt, oldStatus) {
            const statusLabels = {
                pending: 'Bekliyor',
                confirmed: 'Onaylandı',
                cancelled: 'İptal Edildi',
                completed: 'Tamamlandı'
            };
            
            const message = `${apt.customerName}: ${statusLabels[oldStatus] || oldStatus} → ${statusLabels[apt.status] || apt.status}`;
            
            if (apt.status === 'cancelled') {
                showToast(message, 'error');
            } else if (apt.status === 'confirmed') {
                showToast(message, 'success');
            } else {
                showToast(message, 'info');
            }
        }
        
        // Sayfa kapatılırken listener'ı temizle
        window.addEventListener('beforeunload', () => {
            if (appointmentsListener) {
                appointmentsListener();
                appointmentsListener = null;
            }
        });
        
        // Update Stats
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const thisMonth = today.slice(0, 7);
            
            const todayAppointments = appointments.filter(a => a.date === today);
            const pendingAppointments = appointments.filter(a => a.status === 'pending');
            const confirmedAppointments = appointments.filter(a => a.status === 'confirmed');
            const monthRevenue = appointments
                .filter(a => a.date?.startsWith(thisMonth) && (a.status === 'confirmed' || a.status === 'completed'))
                .reduce((sum, a) => sum + (a.servicePrice || 0), 0);
            
            // Eski stat elementleri (varsa)
            const statToday = document.getElementById('statToday');
            const statPending = document.getElementById('statPending');
            const statConfirmed = document.getElementById('statConfirmed');
            const statRevenue = document.getElementById('statRevenue');
            
            if (statToday) statToday.textContent = todayAppointments.length;
            if (statPending) statPending.textContent = pendingAppointments.length;
            if (statConfirmed) statConfirmed.textContent = confirmedAppointments.length;
            if (statRevenue) statRevenue.textContent = `${monthRevenue.toLocaleString('tr-TR')} ₺`;
            
            // Yeni layout stat'larını da güncelle
            updateStatsNew();
        }
        
        // Render Appointments
        function renderAppointments() {
            const container = document.getElementById('appointmentList');
            if (!container) return;
            
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            
            let filtered = [...appointments];
            
            // GEÇMİŞ TARİHLERİ FİLTRELE (iptal ve tamamlanmış olanlar dahil)
            // Sadece bugün ve gelecekteki randevuları göster
            // Bekleyen randevular her zaman gösterilsin (geçmiş olsa bile aksiyon gerektirir)
            filtered = filtered.filter(a => {
                if (a.status === 'pending') return true; // Bekleyenler her zaman görünsün
                if (a.status === 'cancelled') return false; // İptal edilenler hiç görünmesin
                return a.date >= today; // Diğerleri sadece bugün ve sonrası
            });
            
            // Filtre uygula
            if (currentFilter === 'pending') {
                filtered = filtered.filter(a => a.status === 'pending');
            } else if (currentFilter === 'confirmed') {
                filtered = filtered.filter(a => a.status === 'confirmed');
            } else if (currentFilter === 'today') {
                filtered = filtered.filter(a => a.date === today);
            }
            
            // Personel filtresi
            if (currentStaffFilter && currentStaffFilter !== 'all') {
                filtered = filtered.filter(a => 
                    a.staffId === currentStaffFilter || a.staffName === currentStaffFilter
                );
            }
            
            // SIRALAMA: Bekleyenler önce, sonra tarihe göre (yakın olan önce)
            filtered.sort((a, b) => {
                // Önce bekleyenler
                if (a.status === 'pending' && b.status !== 'pending') return -1;
                if (a.status !== 'pending' && b.status === 'pending') return 1;
                
                // Sonra tarihe göre (yakın olan önce)
                const dateA = new Date(a.date + 'T' + (a.time || '00:00'));
                const dateB = new Date(b.date + 'T' + (b.time || '00:00'));
                return dateA - dateB;
            });
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 2rem; text-align: center;">
                        <div class="empty-icon" style="font-size: 2.5rem; margin-bottom: 0.5rem;">📅</div>
                        <h3 class="empty-title" style="font-size: 1rem; color: var(--slate-700);">Randevu Yok</h3>
                        <p class="empty-text" style="font-size: 0.85rem; color: var(--slate-500);">Yaklaşan randevu bulunamadı.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(apt => {
                const date = new Date(apt.date);
                const aptDateTime = new Date(apt.date + 'T' + (apt.time || '00:00'));
                const isPast = aptDateTime < now;
                const isToday = apt.date === today;
                
                const statusClass = `status-${apt.status}`;
                const statusText = {
                    pending: '⏳ Bekliyor',
                    confirmed: '✅ Onaylı',
                    cancelled: '❌ İptal',
                    completed: '✓ Tamamlandı'
                }[apt.status] || apt.status;
                
                const showActions = apt.status === 'pending';
                const borderColor = apt.status === 'pending' ? 'var(--warning)' : 
                                   apt.status === 'confirmed' ? 'var(--success)' : 
                                   apt.status === 'cancelled' ? 'var(--danger)' : 'var(--slate-300)';
                
                return `
                    <div class="appointment-card" style="border-left: 3px solid ${borderColor}; ${isPast && apt.status !== 'pending' ? 'opacity: 0.7;' : ''}">
                        <div class="appointment-date" style="${isToday ? 'background: var(--primary); color: white;' : ''}">
                            <div class="appointment-day">${date.getDate()}</div>
                            <div class="appointment-month">${MONTHS_TR[date.getMonth()].slice(0,3)}</div>
                            <div class="appointment-time" style="font-weight: 700;">${apt.time}</div>
                        </div>
                        <div class="appointment-info" onclick="showAppointmentDetail('${apt.id}')" style="cursor: pointer;">
                            <h4 style="font-size: 0.95rem;">${escapeHtml(apt.customerName)}</h4>
                            <div class="appointment-details" style="font-size: 0.8rem;">
                                <span>✂️ ${escapeHtml(apt.service)}</span>
                                <span>💰 ${apt.servicePrice || 0}₺</span>
                                ${apt.staffName ? `<span>👤 ${escapeHtml(apt.staffName)}</span>` : ''}
                            </div>
                            <span class="appointment-status ${statusClass}" style="font-size: 0.7rem;">${statusText}</span>
                        </div>
                        <div class="appointment-actions" style="display: flex; flex-direction: column; gap: 0.25rem;">
                            ${showActions ? `
                                <button class="btn btn-success btn-sm" onclick="quickApprove('${apt.id}')" style="padding: 0.3rem 0.5rem; font-size: 0.7rem;">
                                    ✓ Onayla
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="quickReject('${apt.id}')" style="padding: 0.3rem 0.5rem; font-size: 0.7rem;">
                                    ✗ İptal
                                </button>
                            ` : `
                                <button class="btn btn-outline btn-sm" onclick="showAppointmentDetail('${apt.id}')" style="padding: 0.3rem 0.5rem; font-size: 0.7rem;">
                                    📋 Detay
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update Appointment Status - Güvenilir versiyon
        async function updateAppointmentStatus(id, status) {
            // İşlem başladığını göster
            const loadingToast = showToast('İşleniyor...', 'info');
            
            try {
                // Firestore güncelle
                await db.collection('appointments').doc(id).update({ 
                    status: status,
                    updatedAt: new Date().toISOString(),
                    updatedBy: isStaffMode ? currentStaffName : 'salon_owner'
                });
                
                // Lokal veriyi güncelle (real-time listener da güncelleyecek ama hemen göster)
                const apt = appointments.find(a => a.id === id);
                if (apt) {
                    apt.status = status;
                    apt.updatedAt = new Date().toISOString();
                }
                
                // Görünümleri güncelle
                refreshAllViews();
                
                // Toast'u kapat
                if (loadingToast && loadingToast.remove) loadingToast.remove();
                
                // Onaylandıysa WhatsApp seçeneği sun
                if (status === 'confirmed' && apt) {
                    showNotificationModal(apt, 'confirmed');
                } else if (status === 'cancelled' && apt) {
                    // İptal için slot açma seçeneği ile birlikte modal göster
                    showCancelledSlotModal(apt);
                } else {
                    showToast('Randevu güncellendi ✓', 'success');
                }
                
            } catch (error) {
                console.error('Error updating appointment:', error);
                if (loadingToast && loadingToast.remove) loadingToast.remove();
                
                // Hata durumunda kullanıcıya bilgi ver
                if (error.code === 'permission-denied') {
                    showToast('Yetkiniz yok. Lütfen tekrar giriş yapın.', 'error');
                } else if (error.code === 'unavailable') {
                    showToast('İnternet bağlantınızı kontrol edin', 'error');
                } else {
                    showToast('Bir hata oluştu. Tekrar deneyin.', 'error');
                }
                
                // Veriyi yeniden yükle (tutarlılık için)
                setTimeout(() => loadAppointments(), 1000);
            }
        }
        
        // İptal edilen randevu için slot açma modal'ı
        function showCancelledSlotModal(apt) {
            // Modal var mı kontrol et, yoksa oluştur
            let modal = document.getElementById('cancelledSlotModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'cancelledSlotModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 450px;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border-radius: var(--radius-lg) var(--radius-lg) 0 0;">
                            <h3 class="modal-title">❌ Randevu İptal Edildi</h3>
                            <button class="modal-close" onclick="closeCancelledSlotModal(false)" style="color: white;">×</button>
                        </div>
                        <div class="modal-body" style="padding: 1.5rem;">
                            <div style="text-align: center; margin-bottom: 1.5rem;">
                                <div style="width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 2rem; background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">❌</div>
                            </div>
                            
                            <div style="background: var(--slate-50); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
                                <div style="font-weight: 600; color: var(--slate-800);" id="cancelledCustomerName">-</div>
                                <div style="font-size: 0.85rem; color: var(--slate-500);" id="cancelledAppointmentInfo">-</div>
                            </div>
                            
                            <!-- Slot Açma Seçeneği -->
                            <div style="background: #f0fdf4; border: 2px solid #a7f3d0; border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                    <span style="font-size: 1.5rem;">📅</span>
                                    <div>
                                        <strong style="color: #166534;">Bu saati yeni randevulara aç</strong>
                                        <p style="font-size: 0.85rem; color: #15803d; margin: 0;">İptal edilen saat başka müşteriler tarafından alınabilir.</p>
                                    </div>
                                </div>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: white; border-radius: 6px;">
                                    <input type="checkbox" id="reopenSlotCheckbox" checked style="width: 18px; height: 18px; accent-color: #10B981;">
                                    <span style="font-size: 0.9rem; color: var(--slate-700);">Evet, bu saati yeni randevulara aç</span>
                                </label>
                            </div>
                            
                            <p style="font-size: 0.85rem; color: var(--slate-500); text-align: center;">Müşteriye bildirim göndermek ister misiniz?</p>
                        </div>
                        <div class="modal-footer" style="justify-content: center; gap: 0.75rem; flex-wrap: wrap;">
                            <button class="btn btn-danger" id="cancelledSendBtn" onclick="sendCancelNotificationAndReopen()" style="display: flex; align-items: center; gap: 0.5rem;">
                                📱 İptal Mesajı Gönder
                            </button>
                            <button class="btn btn-outline" onclick="closeCancelledSlotModal(true)">Mesaj Gönderme</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Modal içeriğini güncelle
            document.getElementById('cancelledCustomerName').textContent = apt.customerName;
            document.getElementById('cancelledAppointmentInfo').textContent = `${formatDateDisplay(apt.date)} - ${apt.time} - ${apt.service}`;
            document.getElementById('reopenSlotCheckbox').checked = true;
            
            // Randevu bilgisini sakla
            modal.dataset.aptId = apt.id;
            modal.dataset.aptDate = apt.date;
            modal.dataset.aptTime = apt.time;
            modal.dataset.aptStaffId = apt.staffId || '';
            modal.dataset.aptDuration = apt.serviceDuration || 30;
            
            modal.classList.add('active');
        }
        
        // İptal mesajı gönder ve slot'u aç
        function sendCancelNotificationAndReopen() {
            const modal = document.getElementById('cancelledSlotModal');
            const aptId = modal.dataset.aptId;
            const apt = appointments.find(a => a.id === aptId);
            
            if (apt) {
                sendStatusNotification(apt, 'cancelled');
            }
            
            closeCancelledSlotModal(true);
        }
        
        // Modal'ı kapat ve slot işlemini yap
        function closeCancelledSlotModal(processSlot = false) {
            const modal = document.getElementById('cancelledSlotModal');
            const reopenSlot = document.getElementById('reopenSlotCheckbox')?.checked;
            
            if (processSlot && reopenSlot) {
                // Slot'u yeniden açmak için blockedSlots'tan kaldır (eğer varsa)
                const aptDate = modal.dataset.aptDate;
                const aptTime = modal.dataset.aptTime;
                const aptStaffId = modal.dataset.aptStaffId;
                
                // Firestore'dan blockedSlot varsa kaldır
                removeBlockedSlot(aptDate, aptTime, aptStaffId);
                
                showToast('Saat yeni randevulara açıldı ✓', 'success');
            } else if (processSlot) {
                showToast('Randevu iptal edildi', 'success');
            }
            
            modal.classList.remove('active');
        }
        
        // Bloklanmış slot'u kaldır (varsa)
        async function removeBlockedSlot(date, time, staffId) {
            try {
                // Salon'un blockedSlots array'inden kaldır
                if (salon.blockedSlots && Array.isArray(salon.blockedSlots)) {
                    const updatedBlocked = salon.blockedSlots.filter(slot => {
                        return !(slot.date === date && slot.time === time && 
                                (staffId ? slot.staffId === staffId : true));
                    });
                    
                    if (updatedBlocked.length !== salon.blockedSlots.length) {
                        await db.collection('salons').doc(salon.id).update({
                            blockedSlots: updatedBlocked
                        });
                        salon.blockedSlots = updatedBlocked;
                        console.log('[Slot] Bloklanmış saat kaldırıldı:', date, time);
                    }
                }
            } catch (error) {
                console.error('[Slot] Blok kaldırma hatası:', error);
            }
        }
        
        // Show notification choice modal
        function showNotificationModal(apt, status = 'confirmed') {
            const modal = document.getElementById('notificationModal');
            const customerName = document.getElementById('notifyCustomerName');
            const customerPhone = document.getElementById('notifyCustomerPhone');
            const appointmentInfo = document.getElementById('notifyAppointmentInfo');
            const modalTitle = document.getElementById('notifyModalTitle');
            const modalIcon = document.getElementById('notifyModalIcon');
            const modalMessage = document.getElementById('notifyModalMessage');
            const sendBtn = document.getElementById('notifySendBtn');
            
            customerName.textContent = apt.customerName;
            customerPhone.textContent = formatPhoneDisplay(apt.customerPhone);
            appointmentInfo.textContent = `${formatDateDisplay(apt.date)} - ${apt.time} - ${apt.service}`;
            
            // Status'a göre modal içeriğini değiştir
            const modalHeader = document.getElementById('notifyModalHeader');
            if (status === 'confirmed') {
                modalTitle.textContent = '✅ Randevu Onaylandı';
                modalHeader.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                modalIcon.innerHTML = '✅';
                modalIcon.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                modalMessage.textContent = 'Müşteriye WhatsApp ile onay bildirimi göndermek ister misiniz?';
                sendBtn.textContent = '📱 Onay Mesajı Gönder';
                sendBtn.className = 'btn btn-success';
            } else {
                modalTitle.textContent = '❌ Randevu İptal Edildi';
                modalHeader.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                modalIcon.innerHTML = '❌';
                modalIcon.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                modalMessage.textContent = 'Müşteriye WhatsApp ile iptal bildirimi göndermek ister misiniz?';
                sendBtn.textContent = '📱 İptal Mesajı Gönder';
                sendBtn.className = 'btn btn-danger';
            }
            
            // Store apt and status for later use
            modal.dataset.aptId = apt.id;
            modal.dataset.status = status;
            modal.classList.add('active');
        }
        
        function closeNotificationModal() {
            const modal = document.getElementById('notificationModal');
            const status = modal.dataset.status || 'confirmed';
            modal.classList.remove('active');
            showToast(status === 'confirmed' ? 'Randevu onaylandı' : 'Randevu iptal edildi', 'success');
        }
        
        function sendWhatsAppFromModal() {
            const modal = document.getElementById('notificationModal');
            const aptId = modal.dataset.aptId;
            const status = modal.dataset.status || 'confirmed';
            const apt = appointments.find(a => a.id === aptId);
            
            if (apt) {
                sendStatusNotification(apt, status);
            }
            
            modal.classList.remove('active');
            showToast(status === 'confirmed' ? 'Randevu onaylandı' : 'Randevu iptal edildi', 'success');
        }
        
        // Send Status Notification via WhatsApp
        function sendStatusNotification(apt, status) {
            const customerPhone = (apt.customerPhone || '').replace(/\D/g, '');
            if (!customerPhone) return;
            
            const salonLink = `https://zamanli.com/berber/salon/?slug=${salon.slug}`;
            
            let message;
            if (status === 'confirmed') {
                message = `RANDEVUNUZ ONAYLANDI

Merhaba ${apt.customerName},
${salon.name} randevunuz onaylanmistir.

Tarih: ${formatDateDisplay(apt.date)}
Saat: ${apt.time}
Hizmet: ${apt.service}
${apt.servicePrice ? `Ucret: ${apt.servicePrice} TL` : ''}

Adres: ${salon.address || `${salon.district}, ${salon.city}`}

Bizi tercih ettiginiz icin tesekkur ederiz!

Yeni randevu icin: ${salonLink}

${salon.name}`;
            } else {
                message = `RANDEVUNUZ IPTAL EDILDI

Merhaba ${apt.customerName},

${formatDateDisplay(apt.date)} ${apt.time} tarihli randevunuz iptal edilmistir.

Size daha iyi hizmet verebilmek icin yeni bir randevu olusturabilirsiniz.

Yeni randevu icin: ${salonLink}

Anlayisiniz icin tesekkur ederiz!

${salon.name}`;
            }
            
            const whatsappUrl = `https://wa.me/90${customerPhone}?text=${encodeURIComponent(message)}`;
            
            // iOS için farklı yönlendirme
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS) {
                window.location.href = whatsappUrl;
            } else {
                window.open(whatsappUrl, '_blank');
            }
        }
        
        // Format date for display
        function formatDateDisplay(dateStr) {
            const date = new Date(dateStr);
            const days = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            return `${date.getDate()} ${MONTHS_TR[date.getMonth()]} ${days[date.getDay()]}`;
        }
        
        // Open WhatsApp - iOS uyumlu
        function openWhatsApp(phone, name) {
            const cleanPhone = phone.replace(/\D/g, '');
            const url = `https://wa.me/90${cleanPhone}`;
            
            // iOS için farklı yönlendirme yöntemi
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS) {
                window.location.href = url;
            } else {
                window.open(url, '_blank');
            }
        }
        
        // Genel WhatsApp yönlendirme fonksiyonu - iOS uyumlu
        function openWhatsAppWithMessage(phone, message) {
            const cleanPhone = phone.replace(/\D/g, '');
            const url = `https://wa.me/90${cleanPhone}?text=${encodeURIComponent(message)}`;
            
            // iOS için farklı yönlendirme yöntemi
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS) {
                window.location.href = url;
            } else {
                window.open(url, '_blank');
            }
        }
        
        // Render Services
        function renderServices() {
            const services = salon.services || APP_CONFIG.categories.berber.services;
            const container = document.getElementById('serviceList');
            
            container.innerHTML = services.map((service, index) => `
                <div class="service-item">
                    <div class="service-left">
                        <div class="service-icon">${service.icon || '✂️'}</div>
                        <div>
                            <div class="service-name">${escapeHtml(service.name)}</div>
                            <div class="service-duration">${service.duration || 30} dakika</div>
                        </div>
                    </div>
                    <div class="service-right">
                        <div class="service-price">${service.price || 100} ₺</div>
                        <button class="btn btn-outline btn-icon" onclick="editService(${index})">✏️</button>
                        <button class="btn btn-outline btn-icon" onclick="deleteService(${index})">🗑️</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Service Modal
        function openServiceModal(index = null) {
            // PERSONEL MODU KONTROLÜ
            if (isStaffMode) {
                showToast('Hizmet ekleme/düzenleme yetkiniz yok', 'error');
                return;
            }
            
            document.getElementById('serviceModalTitle').textContent = index !== null ? 'Hizmet Düzenle' : 'Hizmet Ekle';
            document.getElementById('serviceIndex').value = index !== null ? index : '';
            
            if (index !== null) {
                const services = salon.services || APP_CONFIG.categories.berber.services;
                const service = services[index];
                document.getElementById('serviceName').value = service.name;
                document.getElementById('serviceDuration').value = service.duration || 30;
                document.getElementById('servicePrice').value = service.price || 100;
                document.getElementById('serviceIcon').value = service.icon || '';
            } else {
                document.getElementById('serviceForm').reset();
            }
            
            document.getElementById('serviceModal').classList.add('active');
        }
        
        function closeServiceModal() {
            document.getElementById('serviceModal').classList.remove('active');
        }
        
        function editService(index) {
            openServiceModal(index);
        }
        
        async function saveService(e) {
            e.preventDefault();
            
            // PERSONEL MODU KONTROLÜ
            if (isStaffMode) {
                showToast('Hizmet ekleme/düzenleme yetkiniz yok', 'error');
                closeServiceModal();
                return;
            }
            
            const index = document.getElementById('serviceIndex').value;
            const service = {
                id: document.getElementById('serviceName').value.toLowerCase().replace(/\s+/g, '-'),
                name: document.getElementById('serviceName').value,
                duration: parseInt(document.getElementById('serviceDuration').value),
                price: parseInt(document.getElementById('servicePrice').value),
                icon: document.getElementById('serviceIcon').value || '✂️'
            };
            
            let services = salon.services || [...APP_CONFIG.categories.berber.services];
            
            if (index !== '') {
                services[parseInt(index)] = service;
            } else {
                services.push(service);
            }
            
            try {
                await db.collection('salons').doc(salon.id).update({ services });
                salon.services = services;
                renderServices();
                closeServiceModal();
                showToast('Hizmet kaydedildi', 'success');
            } catch (error) {
                console.error('Error saving service:', error);
                showToast('Bir hata oluştu', 'error');
            }
        }
        
        async function deleteService(index) {
            // PERSONEL MODU KONTROLÜ
            if (isStaffMode) {
                showToast('Hizmet silme yetkiniz yok', 'error');
                return;
            }
            
            if (!confirm('Bu hizmeti silmek istediğinize emin misiniz?')) return;
            
            let services = salon.services || [...APP_CONFIG.categories.berber.services];
            services.splice(index, 1);
            
            try {
                await db.collection('salons').doc(salon.id).update({ services });
                salon.services = services;
                renderServices();
                showToast('Hizmet silindi', 'success');
            } catch (error) {
                console.error('Error deleting service:', error);
                showToast('Bir hata oluştu', 'error');
            }
        }
        
        // Render Staff
        function renderStaff() {
            const container = document.getElementById('staffList');
            const limit = getPackageLimit();
            const canAdd = canAddStaff();
            
            // Salon sahibi personel listesinde yoksa otomatik ekle
            let staff = salon.staff || [];
            
            // Salon sahibini kontrol et (telefon ile)
            const ownerPhone = salon.phone?.slice(-10);
            const ownerExists = staff.some(s => s.phone === ownerPhone);
            
            if (!ownerExists && ownerPhone) {
                // Salon sahibini ilk personel olarak ekle (kaydetmeden, sadece gösterim için)
                const ownerStaff = {
                    name: salon.ownerName || 'Salon Sahibi',
                    title: 'Salon Sahibi',
                    phone: ownerPhone,
                    pin: salon.pin, // Salon PIN'i ile aynı
                    isOwner: true,
                    staffRole: 'owner' // Salon sahibi rolü
                };
                staff = [ownerStaff, ...staff];
                
                // Veritabanına kaydet
                db.collection('salons').doc(salon.id).update({ staff }).then(() => {
                    salon.staff = staff;
                }).catch(err => console.error('Owner staff save error:', err));
            }
            
            // Rol badge'lerini oluştur
            const getRoleBadge = (person) => {
                if (person.isOwner) {
                    return '<span style="font-size:0.65rem;background:var(--primary);color:white;padding:2px 6px;border-radius:10px;margin-left:4px;">PATRON</span>';
                }
                const role = person.staffRole || 'staff';
                if (role === 'operator') {
                    return '<span style="font-size:0.65rem;background:#6366f1;color:white;padding:2px 6px;border-radius:10px;margin-left:4px;">OPERATOR</span>';
                }
                if (role === 'assistant') {
                    return '<span style="font-size:0.65rem;background:#64748b;color:white;padding:2px 6px;border-radius:10px;margin-left:4px;">ASISTAN</span>';
                }
                return '<span style="font-size:0.65rem;background:#10b981;color:white;padding:2px 6px;border-radius:10px;margin-left:4px;">PERSONEL</span>';
            };
            
            let html = staff.map((person, index) => `
                <div class="staff-card ${person.isOwner ? 'owner-card' : ''}">
                    <div class="staff-avatar">${person.isOwner ? 'P' : (person.staffRole === 'operator' ? 'O' : (person.name?.charAt(0) || 'P'))}</div>
                    <div class="staff-name">${escapeHtml(person.name)} ${getRoleBadge(person)}</div>
                    <div class="staff-title">${escapeHtml(person.title || 'Personel')}</div>
                    ${person.phone ? `
                        <div class="staff-pin-section">
                            <div style="font-size: 0.75rem; color: var(--slate-500); margin-bottom: 0.25rem;">Giris PIN</div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                                <input type="password" id="staffPin-${index}" value="${person.pin || '------'}" readonly style="width: 70px; text-align: center; border: 1px solid var(--slate-200); border-radius: 4px; padding: 0.25rem; font-family: monospace; font-size: 0.9rem;">
                                <button id="pinToggle-${index}" onclick="togglePinVisibility(${index})" class="btn-icon-sm">Goster</button>
                                ${!person.isOwner ? `<button onclick="resetStaffPin(${index})" class="btn-icon-sm" title="PIN Sifirla">Sifirla</button>` : ''}
                            </div>
                        </div>
                    ` : `<div style="font-size: 0.75rem; color: var(--warning); margin: 0.5rem 0;">⚠️ Telefon ekleyin</div>`}
                    <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 0.5rem;">
                        ${!person.isOwner ? `<button class="btn btn-outline btn-icon" onclick="editStaff(${index})">✏️</button>` : ''}
                        ${staff.length > 1 && !person.isOwner ? `<button class="btn btn-outline btn-icon" onclick="deleteStaff(${index})">🗑️</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
            
            // Personel Ekle butonunu güncelle
            updateAddStaffButton();
        }
        
        function updateAddStaffButton() {
            const limit = getPackageLimit();
            const currentStaff = (salon?.staff || []).length;
            const canAdd = currentStaff < limit.maxStaff;
            
            console.log('Package check:', { 
                package: salon?.package, 
                limit: limit.maxStaff, 
                currentStaff, 
                canAdd 
            });
            
            const btnContainer = document.getElementById('addStaffBtnContainer');
            if (!btnContainer) return;
            
            if (canAdd) {
                const remaining = limit.maxStaff - currentStaff;
                const remainingText = limit.maxStaff >= 999 ? 'Sınırsız' : `${remaining} hak kaldı`;
                btnContainer.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                        <span style="font-size: 0.8rem; color: var(--slate-400);">
                            ${limit.name} paketi • ${remainingText}
                        </span>
                        <button class="btn btn-primary btn-sm" onclick="openStaffModal()">
                            + Personel Ekle
                        </button>
                    </div>
                `;
            } else {
                btnContainer.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                        <span style="font-size: 0.85rem; color: var(--slate-500);">
                            📊 ${limit.name} paketi: ${limit.maxStaff} personel limiti (dolu)
                        </span>
                        <button class="btn btn-sm" onclick="openUpgradeModal()" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                            ⬆️ Paketi Yükselt
                        </button>
                    </div>
                `;
            }
        }
        
        // Staff Modal
        function openStaffModal(index = null) {
            // PERSONEL MODU KONTROLÜ - Süper admin hariç
            if (isStaffMode && !isSuperAdminMode) {
                showToast('Personel ekleme/düzenleme yetkiniz yok', 'error');
                return;
            }
            
            // Yeni personel ekleme kontrolü - Süper admin limitsiz
            if (index === null && !canAddStaff() && !isSuperAdminMode) {
                openUpgradeModal();
                return;
            }
            
            document.getElementById('staffModalTitle').textContent = index !== null ? 'Personel Düzenle' : 'Personel Ekle';
            document.getElementById('staffIndex').value = index !== null ? index : '';
            
            const pinGroup = document.getElementById('staffPinGroup');
            const pinInput = document.getElementById('staffPinInput');
            const staffRoleSelect = document.getElementById('staffRole');
            
            if (index !== null) {
                // Düzenleme modu
                const staff = salon.staff || [];
                const person = staff[index];
                document.getElementById('staffName').value = person.name;
                document.getElementById('staffTitle').value = person.title || '';
                document.getElementById('staffPhone').value = person.phone || '';
                
                // Rol seçimi - mevcut rolü seç
                if (staffRoleSelect) {
                    staffRoleSelect.value = person.staffRole || 'staff';
                    toggleStaffRoleOptions(); // Hint güncelle
                }
                
                // PIN alanını göster ve doldur
                pinGroup.style.display = 'block';
                pinInput.value = person.pin || '';
                pinInput.type = 'password'; // Başlangıçta gizli
                
                // Patron (isOwner) ise isim, ünvan ve telefon düzenlenemez
                if (person.isOwner) {
                    document.getElementById('staffName').disabled = true;
                    document.getElementById('staffTitle').disabled = true;
                    document.getElementById('staffPhone').disabled = true;
                    if (staffRoleSelect) staffRoleSelect.disabled = true;
                } else {
                    document.getElementById('staffName').disabled = false;
                    document.getElementById('staffTitle').disabled = false;
                    document.getElementById('staffPhone').disabled = false;
                    if (staffRoleSelect) staffRoleSelect.disabled = false;
                }
            } else {
                // Yeni personel modu
                document.getElementById('staffForm').reset();
                pinGroup.style.display = 'block';
                pinInput.value = generateStaffPin(); // Otomatik PIN oluştur
                pinInput.type = 'password';
                
                document.getElementById('staffName').disabled = false;
                document.getElementById('staffTitle').disabled = false;
                document.getElementById('staffPhone').disabled = false;
                
                // Rol seçimi varsayılanı "staff"
                if (staffRoleSelect) {
                    staffRoleSelect.value = 'staff';
                    staffRoleSelect.disabled = false;
                    toggleStaffRoleOptions(); // Hint ve çalışma saatleri görünümü güncelle
                }
            }
            
            document.getElementById('staffModal').classList.add('active');
        }
        
        // Staff PIN görünürlüğünü değiştir
        function toggleStaffPinVisibility() {
            const pinInput = document.getElementById('staffPinInput');
            const btn = document.getElementById('staffPinToggleBtn');
            
            if (pinInput.type === 'password') {
                pinInput.type = 'text';
                btn.textContent = '🙈';
            } else {
                pinInput.type = 'password';
                btn.textContent = '👁️';
            }
        }
        
        // Yeni PIN oluştur (modal içinde)
        function generateNewStaffPin() {
            const pinInput = document.getElementById('staffPinInput');
            pinInput.value = generateStaffPin();
            pinInput.type = 'text'; // Yeni PIN'i göster
            document.getElementById('staffPinToggleBtn').textContent = '🙈';
        }
        
        // Upgrade Modal
        function openUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('active');
            
            const limit = getPackageLimit();
            const currentPkg = salon?.package || 'starter';
            
            // Önerilen paketi belirle
            let suggestedPkg, suggestedName, suggestedPrice;
            if (currentPkg === 'starter' || currentPkg === 'free') {
                suggestedPkg = 'pro';
                suggestedName = 'Pro';
                suggestedPrice = '899 ₺/ay';
            } else {
                suggestedPkg = 'business';
                suggestedName = 'Business';
                suggestedPrice = '1.599 ₺/ay';
            }
            
            document.getElementById('currentPackageName').textContent = limit.name;
            document.getElementById('currentPackageLimit').textContent = `${limit.maxStaff} personel`;
            document.getElementById('suggestedPackageName').textContent = suggestedName;
            document.getElementById('suggestedPackagePrice').textContent = suggestedPrice;
        }
        
        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('active');
        }
        
        function sendUpgradeRequest() {
            const limit = getPackageLimit();
            const currentPkg = salon?.package || 'starter';
            const currentStaff = (salon?.staff || []).length;
            
            // Önerilen paketi belirle
            let suggestedPkg = currentPkg === 'starter' ? 'Profesyonel' : 'Premium';
            
            // EmailJS ile mail gönder
            if (typeof emailjs !== 'undefined' && typeof EMAILJS_CONFIG !== 'undefined') {
                emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateNewSalon, {
                    to_email: 'hello@feyzdigital.com',
                    salon_name: salon.name,
                    owner_name: salon.ownerName,
                    phone: salon.phone,
                    email: salon.email,
                    city: salon.city,
                    district: salon.district,
                    slug: salon.slug,
                    package_name: `PAKET YÜKSELTME TALEBİ: ${limit.name} → ${suggestedPkg}`,
                    package_price: `Mevcut personel: ${currentStaff}, Limit: ${limit.maxStaff}`,
                    setup_fee: '-',
                    created_at: new Date().toLocaleString('tr-TR'),
                    admin_url: window.location.origin + '/berber/salon/yonetim/?slug=' + salon.slug
                }).then(() => {
                    closeUpgradeModal();
                    showToast('Yükseltme talebiniz gönderildi! En kısa sürede dönüş yapacağız.', 'success');
                }).catch(err => {
                    console.error('Email error:', err);
                    showToast('Bir hata oluştu. Lütfen tekrar deneyin.', 'error');
                });
            } else {
                // EmailJS yoksa mailto kullan
                const subject = encodeURIComponent(`Paket Yükseltme Talebi - ${salon.name}`);
                const body = encodeURIComponent(`Salon: ${salon.name}
Yetkili: ${salon.ownerName}
Telefon: ${salon.phone}
E-posta: ${salon.email}
Konum: ${salon.district}, ${salon.city}

Mevcut Paket: ${limit.name}
Talep Edilen: ${suggestedPkg}
Mevcut Personel: ${currentStaff}
Personel Limiti: ${limit.maxStaff}

Panel: ${window.location.href}`);
                
                window.open(`mailto:hello@feyzdigital.com?subject=${subject}&body=${body}`, '_blank');
                closeUpgradeModal();
                showToast('E-posta uygulamanız açılıyor...', 'success');
            }
        }
        
        function closeStaffModal() {
            document.getElementById('staffModal').classList.remove('active');
        }
        
        function editStaff(index) {
            openStaffModal(index);
        }
        
        // Rastgele 6 haneli PIN oluştur
        function generateStaffPin() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        async function saveStaff(e) {
            e.preventDefault();
            
            // PERSONEL MODU KONTROLÜ - Süper admin hariç
            if (isStaffMode && !isSuperAdminMode) {
                showToast('Personel ekleme/düzenleme yetkiniz yok', 'error');
                closeStaffModal();
                return;
            }
            
            const index = document.getElementById('staffIndex').value;
            const phone = document.getElementById('staffPhone').value.replace(/\D/g, '');
            const pinFromModal = document.getElementById('staffPinInput').value;
            const staffRole = document.getElementById('staffRole').value; // staff, operator, assistant
            
            // Telefon zorunlu
            if (!phone || phone.length < 10) {
                showToast('Personel telefon numarası zorunludur', 'error');
                return;
            }
            
            // PIN zorunlu ve 6 haneli olmalı
            if (!pinFromModal || pinFromModal.length !== 6) {
                showToast('PIN kodu 6 haneli olmalıdır', 'error');
                return;
            }
            
            let staff = salon.staff || [];
            
            if (index !== '') {
                // Mevcut personeli güncelle
                const existingPerson = staff[parseInt(index)];
                
                // Patron ise sadece PIN değiştirilebilir
                if (existingPerson.isOwner) {
                    existingPerson.pin = pinFromModal;
                    // Ayrıca salon PIN'ini de güncelle
                    await db.collection('salons').doc(salon.id).update({ 
                        pin: pinFromModal,
                        staff: staff 
                    });
                    salon.pin = pinFromModal;
                } else {
                    staff[parseInt(index)] = {
                        name: document.getElementById('staffName').value,
                        title: document.getElementById('staffTitle').value || 'Personel',
                        phone: phone.slice(-10),
                        pin: pinFromModal,
                        staffRole: staffRole, // ÖNEMLİ: Rol kaydediliyor
                        isOwner: existingPerson.isOwner || false
                    };
                    await db.collection('salons').doc(salon.id).update({ staff });
                }
            } else {
                // Yeni personel ekle
                const person = {
                    name: document.getElementById('staffName').value,
                    title: document.getElementById('staffTitle').value || 'Personel',
                    phone: phone.slice(-10),
                    pin: pinFromModal,
                    staffRole: staffRole // ÖNEMLİ: Rol kaydediliyor
                };
                staff.push(person);
                await db.collection('salons').doc(salon.id).update({ staff });
            }
            
            salon.staff = staff;
            renderStaff();
            closeStaffModal();
            showToast('Personel kaydedildi', 'success');
        }
        
        // Personel PIN'ini sıfırla
        async function resetStaffPin(index) {
            if (!confirm('Bu personelin PIN kodunu sıfırlamak istediğinize emin misiniz?')) return;
            
            let staff = salon.staff || [];
            staff[index].pin = generateStaffPin();
            
            try {
                await db.collection('salons').doc(salon.id).update({ staff });
                salon.staff = staff;
                renderStaff();
                showToast('PIN kodu sıfırlandı: ' + staff[index].pin, 'success');
            } catch (error) {
                console.error('Error resetting PIN:', error);
                showToast('Bir hata oluştu', 'error');
            }
        }
        
        // PIN'i göster/gizle
        function togglePinVisibility(index) {
            const pinEl = document.getElementById(`staffPin-${index}`);
            const btnEl = document.getElementById(`pinToggle-${index}`);
            
            if (pinEl.type === 'password') {
                pinEl.type = 'text';
                btnEl.textContent = '🙈';
            } else {
                pinEl.type = 'password';
                btnEl.textContent = '👁️';
            }
        }
        
        async function deleteStaff(index) {
            // PERSONEL MODU KONTROLÜ
            if (isStaffMode) {
                showToast('Personel silme yetkiniz yok', 'error');
                return;
            }
            
            if (!confirm('Bu personeli silmek istediğinize emin misiniz?')) return;
            
            let staff = salon.staff || [];
            staff.splice(index, 1);
            
            try {
                await db.collection('salons').doc(salon.id).update({ staff });
                salon.staff = staff;
                renderStaff();
                showToast('Personel silindi', 'success');
            } catch (error) {
                console.error('Error deleting staff:', error);
                showToast('Bir hata oluştu', 'error');
            }
        }
        
        // Render Working Hours
        function renderWorkingHours() {
            const hours = salon.workingHours || APP_CONFIG.workingHours.default;
            const container = document.getElementById('hoursList');
            const dayOrder = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            
            container.innerHTML = dayOrder.map(day => {
                const h = hours[day] || { open: '09:00', close: '20:00', active: true };
                return `
                    <div class="hours-row">
                        <div class="hours-day">${DAYS_TR[day]}</div>
                        <div class="hours-inputs">
                            <input type="time" class="hours-input" id="hours-${day}-open" value="${h.open}" ${!h.active ? 'disabled' : ''}>
                            <span>-</span>
                            <input type="time" class="hours-input" id="hours-${day}-close" value="${h.close}" ${!h.active ? 'disabled' : ''}>
                        </div>
                        <div class="hours-toggle">
                            <label class="toggle">
                                <input type="checkbox" id="hours-${day}-active" ${h.active ? 'checked' : ''} onchange="toggleDay('${day}')">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>${h.active ? 'Açık' : 'Kapalı'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleDay(day) {
            const active = document.getElementById(`hours-${day}-active`).checked;
            document.getElementById(`hours-${day}-open`).disabled = !active;
            document.getElementById(`hours-${day}-close`).disabled = !active;
            
            // Update label
            const row = document.getElementById(`hours-${day}-active`).closest('.hours-row');
            row.querySelector('.hours-toggle span:last-child').textContent = active ? 'Açık' : 'Kapalı';
        }
        
        async function saveWorkingHours() {
            // PERSONEL MODU KONTROLÜ
            if (isStaffMode) {
                showToast('Çalışma saatleri düzenleme yetkiniz yok', 'error');
                return;
            }
            
            const dayOrder = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const workingHours = {};
            
            dayOrder.forEach(day => {
                workingHours[day] = {
                    open: document.getElementById(`hours-${day}-open`).value,
                    close: document.getElementById(`hours-${day}-close`).value,
                    active: document.getElementById(`hours-${day}-active`).checked
                };
            });
            
            try {
                await db.collection('salons').doc(salon.id).update({ workingHours });
                salon.workingHours = workingHours;
                showToast('Çalışma saatleri kaydedildi', 'success');
            } catch (error) {
                console.error('Error saving hours:', error);
                showToast('Bir hata oluştu', 'error');
            }
        }
        
        // Load Settings
        function loadSettings() {
            document.getElementById('settingName').value = salon.name || '';
            document.getElementById('settingCity').value = salon.city || '';
            document.getElementById('settingDistrict').value = salon.district || '';
            document.getElementById('settingAddress').value = salon.address || '';
            document.getElementById('settingPhone').value = salon.phone || '';
            document.getElementById('settingEmail').value = salon.email || '';
            document.getElementById('settingGoogleBusiness').value = salon.googleBusinessUrl || '';
            
            // Kategori seçimi yükle
            const category = salon.category || 'berber';
            const categoryRadio = document.querySelector(`input[name="settingCategory"][value="${category}"]`);
            if (categoryRadio) {
                categoryRadio.checked = true;
                updateSettingCategory(category);
            }
            
            // Salon Sahibi Profili yükle
            loadOwnerProfile();
            
            // Logo
            if (salon.logo) {
                document.getElementById('logoPreview').innerHTML = `<img src="${salon.logo}" alt="Logo">`;
                document.getElementById('removeLogoBtn').style.display = 'inline-flex';
            }
            
            // Galeri
            renderGallery();
            
            // QR Kod - Zamanli kurumsal renklerle
            // color: Emerald (#10B981), bgcolor: White
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&color=0B2B26&bgcolor=FFFFFF&data=${encodeURIComponent(location.origin + '/berber/salon/?slug=' + salon.slug)}`;
            document.getElementById('qrCodeDisplay').innerHTML = `<img src="${qrUrl}" alt="QR Kod" id="qrImage" style="width:180px;height:180px; border-radius: 8px;">`;
        }
        
        // Kategori seçim UI güncelleme
        function updateSettingCategory(category) {
            const colors = {
                berber: '#10B981',
                kuafor: '#ec4899',
                beauty: '#14b8a6'
            };
            
            ['berber', 'kuafor', 'beauty'].forEach(cat => {
                const opt = document.getElementById(`catOpt${cat.charAt(0).toUpperCase() + cat.slice(1)}`);
                if (opt) {
                    if (cat === category) {
                        opt.style.borderColor = colors[cat];
                        opt.style.background = `${colors[cat]}10`;
                    } else {
                        opt.style.borderColor = 'var(--slate-200)';
                        opt.style.background = 'white';
                    }
                }
            });
        }
        
        // QR Kod İndir - Basit versiyon
        function downloadQRCode() {
            const salonUrl = `${location.origin}/berber/salon/?slug=${salon.slug}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&format=png&color=0B2B26&bgcolor=FFFFFF&data=${encodeURIComponent(salonUrl)}`;
            
            // Fetch ile indirme
            fetch(qrUrl)
                .then(response => response.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${salon.slug}-qr-code.png`;
                    link.click();
                    URL.revokeObjectURL(url);
                })
                .catch(() => {
                    window.open(qrUrl, '_blank');
                });
        }
        
        // QR Kod İndir - Zamanli Branding ile
        async function downloadQRCodeWithBranding() {
            const salonUrl = `${location.origin}/berber/salon/?slug=${salon.slug}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&format=png&color=0B2B26&bgcolor=FFFFFF&data=${encodeURIComponent(salonUrl)}`;
            
            try {
                showToast('QR kod hazırlanıyor...', 'info');
                
                // Canvas oluştur
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Canvas boyutları
                canvas.width = 400;
                canvas.height = 520;
                
                // Arka plan
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // QR kodu yükle
                const qrImage = new Image();
                qrImage.crossOrigin = 'anonymous';
                
                await new Promise((resolve, reject) => {
                    qrImage.onload = resolve;
                    qrImage.onerror = reject;
                    qrImage.src = qrUrl;
                });
                
                // QR kodu çiz (ortala)
                const qrX = (canvas.width - 300) / 2;
                const qrY = 30;
                ctx.drawImage(qrImage, qrX, qrY, 300, 300);
                
                // QR etrafına çerçeve (Emerald)
                ctx.strokeStyle = '#10B981';
                ctx.lineWidth = 4;
                ctx.strokeRect(qrX - 12, qrY - 12, 324, 324);
                
                // Logo yükle
                const logoImage = new Image();
                logoImage.crossOrigin = 'anonymous';
                
                try {
                    await new Promise((resolve, reject) => {
                        logoImage.onload = resolve;
                        logoImage.onerror = reject;
                        logoImage.src = '/icons/logo.png';
                    });
                    
                    // Logo çiz (QR'ın altında ortada)
                    const logoSize = 40;
                    const logoX = (canvas.width - logoSize) / 2;
                    const logoY = qrY + 300 + 25;
                    ctx.drawImage(logoImage, logoX, logoY, logoSize, logoSize);
                    
                    // Alt yazılar (logo'nun yanında)
                    const textY = logoY + 20;
                    
                    // zamanli.com
                    ctx.fillStyle = '#0B2B26';
                    ctx.font = 'bold 22px Satoshi, Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('zamanli.com', canvas.width / 2, textY + 45);
                    
                    // Online Randevu Sistemi
                    ctx.fillStyle = '#64748b';
                    ctx.font = '13px Inter, sans-serif';
                    ctx.fillText('Online Randevu Sistemi', canvas.width / 2, textY + 68);
                    
                    // Salon adı
                    ctx.fillStyle = '#10B981';
                    ctx.font = 'bold 15px Inter, sans-serif';
                    ctx.fillText(salon.name, canvas.width / 2, textY + 92);
                    
                } catch (logoErr) {
                    console.log('Logo yüklenemedi, logosuz devam ediliyor');
                    
                    // Logosuz versiyon
                    const textY = qrY + 300 + 35;
                    
                    // zamanli.com
                    ctx.fillStyle = '#0B2B26';
                    ctx.font = 'bold 24px Satoshi, Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('zamanli.com', canvas.width / 2, textY);
                    
                    // Online Randevu Sistemi
                    ctx.fillStyle = '#64748b';
                    ctx.font = '14px Inter, sans-serif';
                    ctx.fillText('Online Randevu Sistemi', canvas.width / 2, textY + 25);
                    
                    // Salon adı
                    ctx.fillStyle = '#10B981';
                    ctx.font = 'bold 16px Inter, sans-serif';
                    ctx.fillText(salon.name, canvas.width / 2, textY + 52);
                }
                
                // İndir
                const link = document.createElement('a');
                link.download = `${salon.slug}-zamanli-qr.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast('QR kod indirildi!', 'success');
                
            } catch (error) {
                console.error('QR download error:', error);
                // Fallback: normal indir
                downloadQRCode();
            }
        }
        
        function printQRCode() {
            const salonUrl = `${location.origin}/berber/salon/?slug=${salon.slug}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(salonUrl)}`;
            window.open(qrUrl, '_blank');
        }
        
        // Logo Yükleme
        async function uploadLogo(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('Logo maksimum 5MB olmalı', 'error');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showToast('Sadece resim dosyaları kabul edilir', 'error');
                return;
            }
            
            showToast('Logo yükleniyor...', '');
            
            try {
                // Firebase Storage'a yükle
                const storage = firebase.storage();
                const ext = file.name.split('.').pop();
                const ref = storage.ref(`salons/${salon.id}/logo/logo.${ext}`);
                await ref.put(file);
                const logoURL = await ref.getDownloadURL();
                
                await db.collection('salons').doc(salon.id).update({ logo: logoURL, logoStorage: true });
                salon.logo = logoURL;
                document.getElementById('logoPreview').innerHTML = `<img src="${logoURL}" alt="Logo">`;
                document.getElementById('removeLogoBtn').style.display = 'inline-flex';
                showToast('Logo kaydedildi', 'success');
            } catch (error) {
                console.error('Logo upload error:', error);
                // Fallback: base64
                try {
                    const base64 = await fileToBase64(file);
                    await db.collection('salons').doc(salon.id).update({ logo: base64 });
                    salon.logo = base64;
                    document.getElementById('logoPreview').innerHTML = `<img src="${base64}" alt="Logo">`;
                    document.getElementById('removeLogoBtn').style.display = 'inline-flex';
                    showToast('Logo kaydedildi (fallback)', 'success');
                } catch (fbError) {
                    showToast('Logo yüklenirken hata oluştu', 'error');
                }
            }
        }
        
        async function removeLogo() {
            if (!confirm('Logoyu kaldırmak istediğinize emin misiniz?')) return;
            
            try {
                await db.collection('salons').doc(salon.id).update({ logo: null });
                salon.logo = null;
                document.getElementById('logoPreview').innerHTML = '<span>💈</span>';
                document.getElementById('removeLogoBtn').style.display = 'none';
                showToast('Logo kaldırıldı', 'success');
            } catch (error) {
                showToast('Hata oluştu', 'error');
            }
        }
        
        // Galeri Yükleme
        function renderGallery() {
            const gallery = salon.gallery || [];
            const container = document.getElementById('galleryGrid');
            
            container.innerHTML = gallery.map((img, idx) => `
                <div class="gallery-item-upload">
                    <img src="${img}" alt="Galeri ${idx + 1}">
                    <button class="remove-gallery-btn" onclick="removeGalleryImage(${idx})">✕</button>
                </div>
            `).join('');
            
            // Gallery counter + limit
            const countEl = document.createElement('p');
            countEl.style.cssText = 'font-size:0.75rem;color:var(--slate-500);margin-top:0.25rem;';
            countEl.textContent = `${gallery.length}/10 görsel yüklendi`;
            container.parentElement?.querySelector('.gallery-count')?.remove();
            countEl.className = 'gallery-count';
            container.after(countEl);
            
            // 10'dan az varsa ekleme butonunu göster
            document.getElementById('addGalleryBtn').style.display = gallery.length >= 10 ? 'none' : 'inline-flex';
        }
        
        async function uploadGalleryImages(event) {
            const files = Array.from(event.target.files);
            const gallery = salon.gallery || [];
            
            if (gallery.length + files.length > 10) {
                showToast(`Maksimum 10 görsel ekleyebilirsiniz (${gallery.length}/10 dolu)`, 'error');
                return;
            }
            
            showToast('Görseller yükleniyor...', '');
            
            try {
                const storage = firebase.storage();
                
                for (const file of files) {
                    if (file.size > 5 * 1024 * 1024) {
                        showToast(`${file.name} çok büyük (max 5MB)`, 'error');
                        continue;
                    }
                    if (!file.type.startsWith('image/')) {
                        showToast(`${file.name} resim dosyası değil`, 'error');
                        continue;
                    }
                    
                    // Firebase Storage'a yükle
                    try {
                        const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                        const ref = storage.ref(`salons/${salon.id}/gallery/${fileName}`);
                        await ref.put(file);
                        const url = await ref.getDownloadURL();
                        gallery.push(url);
                    } catch (storageErr) {
                        // Fallback: base64
                        console.warn('Storage fallback:', storageErr);
                        const base64 = await fileToBase64(file);
                        gallery.push(base64);
                    }
                }
                
                await db.collection('salons').doc(salon.id).update({ gallery });
                salon.gallery = gallery;
                renderGallery();
                showToast('Görseller kaydedildi', 'success');
            } catch (error) {
                console.error('Gallery upload error:', error);
                showToast('Görseller yüklenirken hata oluştu', 'error');
            }
            
            event.target.value = '';
        }
        
        async function removeGalleryImage(index) {
            if (!confirm('Bu görseli kaldırmak istediğinize emin misiniz?')) return;
            
            try {
                const gallery = salon.gallery || [];
                gallery.splice(index, 1);
                await db.collection('salons').doc(salon.id).update({ gallery });
                salon.gallery = gallery;
                renderGallery();
                showToast('Görsel kaldırıldı', 'success');
            } catch (error) {
                showToast('Hata oluştu', 'error');
            }
        }
        
        // Base64 dönüştürme
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // Google Business Link Kaydet
        async function saveGoogleBusinessLink() {
            const url = document.getElementById('settingGoogleBusiness').value.trim();
            
            try {
                await db.collection('salons').doc(salon.id).update({ googleBusinessUrl: url });
                salon.googleBusinessUrl = url;
                showToast('Google Business linki kaydedildi', 'success');
            } catch (error) {
                showToast('Hata oluştu', 'error');
            }
        }
        
        // Müşteri Geçmişi
        let allCustomers = [];
        
        async function loadCustomers() {
            try {
                const customerMap = {};
                
                // 0. Önce silinen müşterileri al (blacklist)
                const deletedSet = new Set();
                try {
                    const deletedSnap = await db.collection('salons').doc(salon.id).collection('deletedCustomers').get();
                    deletedSnap.docs.forEach(doc => deletedSet.add(doc.id));
                    console.log('[Customers] Blacklist:', deletedSet.size, 'müşteri');
                } catch (e) {}
                
                // 1. Önce manuel eklenen müşterileri yükle (customers collection'dan)
                try {
                    const customersSnap = await db.collection('salons').doc(salon.id).collection('customers').get();
                    customersSnap.docs.forEach(doc => {
                        const cust = doc.data();
                        const phone = cust.phone?.replace(/\D/g, '').slice(-10);
                        if (phone && !deletedSet.has(phone)) {
                            customerMap[phone] = {
                                id: doc.id,
                                name: cust.name || 'İsimsiz',
                                phone: phone,
                                email: cust.email || '',
                                appointments: [],
                                totalSpent: 0,
                                note: cust.note || '',
                                isManual: true,
                                createdAt: cust.createdAt || ''
                            };
                        }
                    });
                } catch (e) {
                    console.log('No manual customers collection yet');
                }
                
                // 2. Randevulardan müşterileri topla (silinmemiş olanları)
                const snap = await db.collection('appointments')
                    .where('salonId', '==', salon.id)
                    .get();
                
                snap.docs.forEach(doc => {
                    const apt = doc.data();
                    const phone = apt.customerPhone?.replace(/\D/g, '').slice(-10);
                    if (!phone || deletedSet.has(phone)) return;
                    
                    // PERSONEL MODU: Sadece kendi müşterilerini göster
                    if (isStaffMode && currentStaffId) {
                        if (apt.staffId !== currentStaffId && apt.staffName !== currentStaffName) {
                            return;
                        }
                    }
                    
                    if (!customerMap[phone]) {
                        customerMap[phone] = {
                            name: apt.customerName,
                            phone: phone,
                            appointments: [],
                            totalSpent: 0,
                            note: ''
                        };
                    } else if (!customerMap[phone].name || customerMap[phone].name === 'İsimsiz') {
                        // İsim güncellemesi (randevudan daha güncel isim alınabilir)
                        customerMap[phone].name = apt.customerName || customerMap[phone].name;
                    }
                    
                    customerMap[phone].appointments.push({
                        date: apt.date,
                        time: apt.time,
                        service: apt.service,
                        price: apt.servicePrice || 0,
                        status: apt.status
                    });
                    
                    if (apt.status === 'completed') {
                        customerMap[phone].totalSpent += (apt.servicePrice || 0);
                    }
                });
                
                // 3. Müşteri notlarını yükle
                try {
                    const notesSnap = await db.collection('salons').doc(salon.id).collection('customerNotes').get();
                    notesSnap.docs.forEach(doc => {
                        const phone = doc.id;
                        if (customerMap[phone]) {
                            customerMap[phone].note = doc.data().note || '';
                        }
                    });
                } catch (e) {
                    console.log('No customer notes yet');
                }
                
                allCustomers = Object.values(customerMap);
                
                // Eklenme zamanına göre sırala (en yeni en üstte)
                allCustomers.sort((a, b) => {
                    let dateA = a.createdAt || a.appointments?.[a.appointments.length - 1]?.date || '';
                    let dateB = b.createdAt || b.appointments?.[b.appointments.length - 1]?.date || '';
                    
                    // Timestamp objesi ise string'e çevir
                    try {
                        if (dateA && typeof dateA === 'object') {
                            if (dateA.toDate) dateA = dateA.toDate().toISOString();
                            else if (dateA.seconds) dateA = new Date(dateA.seconds * 1000).toISOString();
                        }
                        if (dateB && typeof dateB === 'object') {
                            if (dateB.toDate) dateB = dateB.toDate().toISOString();
                            else if (dateB.seconds) dateB = new Date(dateB.seconds * 1000).toISOString();
                        }
                    } catch (e) {}
                    
                    dateA = String(dateA || '0000-00-00');
                    dateB = String(dateB || '0000-00-00');
                    
                    if (dateB > dateA) return 1;
                    if (dateB < dateA) return -1;
                    return 0;
                });
                
                console.log('[Customers] Toplam müşteri:', allCustomers.length);
                renderCustomers();
                
            } catch (error) {
                console.error('Error loading customers:', error);
                const container = document.getElementById('customerList');
                if (container) {
                    container.innerHTML = '<p class="empty-text" style="color: var(--danger);">Müşteriler yüklenirken hata oluştu</p>';
                }
            }
        }
        
        function renderCustomers() {
            const container = document.getElementById('customerList');
            if (!container) return;
            
            if (allCustomers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">👥</div>
                        <p class="empty-text">Henüz müşteri kaydı yok</p>
                        <p style="font-size: 0.85rem; color: var(--slate-500); margin-top: 0.5rem;">
                            Randevu alan müşteriler otomatik olarak eklenecek veya<br>
                            yukarıdaki butonu kullanarak manuel müşteri ekleyebilirsiniz.
                        </p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allCustomers.map((customer, idx) => {
                const lastApt = customer.appointments?.[customer.appointments.length - 1];
                const totalAppointments = customer.appointments?.length || 0;
                const completedCount = customer.appointments?.filter(a => a.status === 'completed').length || 0;
                const hasAppointments = totalAppointments > 0;
                
                return `
                    <div class="customer-card ${customer.isManual && !hasAppointments ? 'manual-customer' : ''}">
                        <div class="customer-header">
                            <div class="customer-info">
                                <h4>${escapeHtml(customer.name)} ${customer.isManual && !hasAppointments ? '<span style="font-size:0.65rem;background:var(--slate-200);color:var(--slate-600);padding:2px 6px;border-radius:10px;margin-left:4px;">Manuel</span>' : ''}</h4>
                                <p>📞 0${customer.phone}</p>
                                ${customer.email ? `<p style="font-size: 0.75rem; color: var(--slate-400);">✉️ ${customer.email}</p>` : ''}
                            </div>
                            <div class="customer-stats">
                                <div class="customer-stat">
                                    <strong>${totalAppointments}</strong>
                                    Randevu
                                </div>
                                <div class="customer-stat">
                                    <strong>${customer.totalSpent || 0} ₺</strong>
                                    Toplam
                                </div>
                            </div>
                        </div>
                        
                        ${hasAppointments ? `
                            <div class="customer-history">
                                <h5>Son Randevular</h5>
                                ${customer.appointments.slice(-3).reverse().map(apt => `
                                    <div class="history-item">
                                        <span>${apt.date} ${apt.time}</span>
                                        <span>${apt.service || '-'}</span>
                                        <span>${apt.price || 0} ₺</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="padding: 0.75rem; background: var(--slate-50); border-radius: 8px; text-align: center; font-size: 0.85rem; color: var(--slate-500);">
                                Henüz randevu kaydı yok
                            </div>
                        `}
                        
                        <div class="customer-note">
                            <textarea placeholder="Müşteri notu ekleyin..." 
                                      onchange="saveCustomerNote('${customer.phone}', this.value)">${customer.note || ''}</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                            <button class="btn btn-outline btn-sm" onclick="createAppointmentForCustomer('${escapeHtml(customer.name)}', '${customer.phone}')" style="flex: 1;">
                                📅 Randevu Oluştur
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="openWhatsApp('${customer.phone}', '${escapeHtml(customer.name)}')" style="padding: 0.5rem;">
                                💬
                            </button>
                            ${customer.isManual && !hasAppointments ? `
                                <button class="btn btn-outline btn-sm" onclick="deleteManualCustomer('${customer.id}')" style="padding: 0.5rem; color: var(--danger);">
                                    🗑️
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Müşteri için randevu oluştur
        function createAppointmentForCustomer(name, phone) {
            // Manuel randevu modalını aç ve müşteri bilgilerini doldur
            openManualAppointmentModal();
            setTimeout(() => {
                selectCustomerForAppointment(name, phone);
            }, 100);
        }
        
        // Manuel müşteri ekleme modal fonksiyonları - tanım sayfa sonunda (duplicate önleme)
        
        async function deleteManualCustomer(customerId) {
            if (!confirm('Bu müşteriyi silmek istediğinize emin misiniz?')) return;
            
            try {
                // Müşteriyi bul ve telefonunu al
                const customer = allCustomers.find(c => c.id === customerId || c.phone === customerId);
                const phone = customer?.phone || customerId;
                const cleanPhone = phone.replace(/\D/g, '').slice(-10);
                
                // 1. Müşteriyi sil
                await db.collection('salons').doc(salon.id).collection('customers').doc(customerId).delete();
                
                // 2. Blacklist'e ekle (tekrar gelmemesi için)
                if (cleanPhone && cleanPhone.length === 10) {
                    await db.collection('salons').doc(salon.id).collection('deletedCustomers').doc(cleanPhone).set({
                        phone: cleanPhone,
                        deletedAt: new Date().toISOString(),
                        deletedBy: isStaffMode ? currentStaffName : 'salon_owner'
                    });
                }
                
                showToast('Müşteri silindi', 'success');
                await loadCustomers();
            } catch (error) {
                console.error('Error deleting customer:', error);
                showToast('Silme işlemi başarısız', 'error');
            }
        }
        
        function searchCustomers() {
            const query = document.getElementById('customerSearch').value.toLowerCase();
            const filtered = allCustomers.filter(c => 
                c.name.toLowerCase().includes(query) || 
                c.phone.includes(query)
            );
            
            // Geçici olarak filtrelenmiş listeyi göster
            const container = document.getElementById('customerList');
            if (filtered.length === 0) {
                container.innerHTML = '<p class="empty-text">Sonuç bulunamadı</p>';
                return;
            }
            
            // renderCustomers'ı filtered ile çağır
            const originalCustomers = allCustomers;
            allCustomers = filtered;
            renderCustomers();
            allCustomers = originalCustomers;
        }
        
        async function saveCustomerNote(phone, note) {
            // Müşteri notlarını ayrı bir collection'da sakla
            try {
                await db.collection('salons').doc(salon.id).collection('customerNotes').doc(phone).set({
                    note: note,
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                
                // Local update
                const customer = allCustomers.find(c => c.phone === phone);
                if (customer) customer.note = note;
                
            } catch (error) {
                console.error('Error saving note:', error);
            }
        }
        
        // Save Settings
        async function saveSettings(e) {
            e.preventDefault();
            
            // Seçili kategoriyi al
            const selectedCategory = document.querySelector('input[name="settingCategory"]:checked');
            
            const updates = {
                name: document.getElementById('settingName').value,
                city: document.getElementById('settingCity').value,
                district: document.getElementById('settingDistrict').value,
                address: document.getElementById('settingAddress').value,
                phone: document.getElementById('settingPhone').value,
                email: document.getElementById('settingEmail').value,
                category: selectedCategory ? selectedCategory.value : (salon.category || 'berber'),
                updatedAt: new Date().toISOString()
            };
            
            try {
                await db.collection('salons').doc(salon.id).update(updates);
                Object.assign(salon, updates);
                document.getElementById('headerSalonName').textContent = salon.name;
                
                // Kategori değiştiyse header'ı da güncelle
                const catIcons = { berber: '💈', kuafor: '💇‍♀️', beauty: '💆' };
                const headerType = document.getElementById('headerSalonType');
                if (headerType) {
                    headerType.textContent = catIcons[updates.category] || '💈';
                }
                
                showToast('Ayarlar kaydedildi', 'success');
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('Bir hata oluştu', 'error');
            }
        }
        
        // Salon Sahibi Profil Yükleme
        function loadOwnerProfile() {
            const staff = salon.staff || [];
            const owner = staff.find(s => s.isOwner);
            
            if (owner) {
                document.getElementById('ownerName').value = owner.name || salon.ownerName || '';
                document.getElementById('ownerTitle').value = owner.title || 'Salon Sahibi';
            } else {
                document.getElementById('ownerName').value = salon.ownerName || '';
                document.getElementById('ownerTitle').value = 'Salon Sahibi';
            }
            
            document.getElementById('ownerPhone').value = salon.phone || '';
        }
        
        // Salon Sahibi Profil Kaydetme
        async function saveOwnerProfile(e) {
            e.preventDefault();
            
            const ownerName = document.getElementById('ownerName').value.trim();
            const ownerTitle = document.getElementById('ownerTitle').value.trim() || 'Salon Sahibi';
            
            if (!ownerName) {
                showToast('Ad Soyad gerekli', 'error');
                return;
            }
            
            try {
                // Staff listesinde owner'ı güncelle
                const staff = [...(salon.staff || [])];
                const ownerIndex = staff.findIndex(s => s.isOwner);
                
                if (ownerIndex >= 0) {
                    staff[ownerIndex] = {
                        ...staff[ownerIndex],
                        name: ownerName,
                        title: ownerTitle
                    };
                } else {
                    // Owner yoksa ekle
                    const ownerPhone = salon.phone?.slice(-10);
                    staff.unshift({
                        name: ownerName,
                        title: ownerTitle,
                        phone: ownerPhone,
                        pin: salon.pin,
                        isOwner: true
                    });
                }
                
                await db.collection('salons').doc(salon.id).update({ 
                    staff: staff,
                    ownerName: ownerName
                });
                
                salon.staff = staff;
                salon.ownerName = ownerName;
                
                // UI güncelle
                if (typeof renderStaff === 'function') renderStaff();
                
                showToast('Profil güncellendi', 'success');
            } catch (error) {
                console.error('Error saving owner profile:', error);
                showToast('Bir hata oluştu', 'error');
            }
        }
        
        // Change PIN
        async function changePin(e) {
            e.preventDefault();
            
            const currentPin = document.getElementById('currentPin').value;
            const newPin = document.getElementById('newPin').value;
            
            if (salon.pin !== currentPin) {
                showToast('Mevcut PIN yanlış', 'error');
                return;
            }
            
            if (newPin.length < 4) {
                showToast('PIN en az 4 karakter olmalı', 'error');
                return;
            }
            
            try {
                await db.collection('salons').doc(salon.id).update({ pin: newPin });
                salon.pin = newPin;
                document.getElementById('currentPin').value = '';
                document.getElementById('newPin').value = '';
                showToast('PIN değiştirildi', 'success');
            } catch (error) {
                console.error('Error changing PIN:', error);
                showToast('Bir hata oluştu', 'error');
            }
        }
        
        // ========== GELİŞMİŞ AYARLAR ==========
        
        // Gelişmiş ayarları yükle
        function loadAdvancedSettings() {
            const settings = salon?.advancedSettings || {};
            
            // Otomatik onay
            const autoApprove = document.getElementById('settingAutoApprove');
            if (autoApprove) autoApprove.checked = settings.autoApprove || false;
            
            // Minimum iptal süresi
            const minCancelHours = document.getElementById('settingMinCancelHours');
            if (minCancelHours) minCancelHours.value = settings.minCancelHours || '0';
            
            // Randevu aralığı
            const slotInterval = document.getElementById('settingSlotInterval');
            if (slotInterval) slotInterval.value = settings.slotInterval || '30';
            
            // Maksimum ileri tarih
            const maxAdvanceDays = document.getElementById('settingMaxAdvanceDays');
            if (maxAdvanceDays) maxAdvanceDays.value = settings.maxAdvanceDays || '30';
            
            // Hatırlatma
            const reminderHours = document.getElementById('settingReminderHours');
            if (reminderHours) reminderHours.value = settings.reminderHours || '0';
        }
        
        // Gelişmiş ayar kaydet
        async function saveAdvancedSetting(key, value) {
            try {
                const currentSettings = salon?.advancedSettings || {};
                currentSettings[key] = value;
                
                await db.collection('salons').doc(salon.id).update({
                    advancedSettings: currentSettings
                });
                
                salon.advancedSettings = currentSettings;
                showToast('Ayar kaydedildi ✓', 'success');
                
                console.log('[Settings] Gelişmiş ayar kaydedildi:', key, value);
            } catch (error) {
                console.error('Gelişmiş ayar kaydetme hatası:', error);
                showToast('Ayar kaydedilemedi', 'error');
            }
        }
        
        // Setup Tabs
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                    
                    // Müşteriler sekmesine geçildiğinde verileri yükle
                    if (tab.dataset.tab === 'customers' && allCustomers.length === 0) {
                        loadCustomers();
                    }
                });
            });
        }
        
        // Setup Filters
        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderAppointments();
                });
            });
        }
        
        // ==================== HAFTALIK TAKVİM ====================
        
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }
        
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            
            const calendarView = document.getElementById('calendarView');
            const listView = document.getElementById('listView');
            
            if (view === 'calendar') {
                calendarView.style.display = 'block';
                calendarView.classList.add('active');
                listView.style.display = 'none';
                listView.classList.remove('active');
                populateStaffFilter('calendarStaffFilter');
                renderWeeklyCalendar();
            } else {
                calendarView.style.display = 'none';
                calendarView.classList.remove('active');
                listView.style.display = 'block';
                listView.classList.add('active');
                populateStaffFilter('staffFilterSelect');
                renderAppointments();
            }
        }
        
        function populateStaffFilter(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const staff = salon?.staff || [];
            
            // Personel modunda sadece kendi adı gösterilsin, Tüm Personel seçeneği olmasın
            if (isStaffMode) {
                select.innerHTML = '';
                const currentStaff = staff.find(s => s.id === currentStaffId || s.name === currentStaffName);
                if (currentStaff) {
                    select.innerHTML = `<option value="${currentStaff.id || currentStaff.name}" selected>${escapeHtml(currentStaff.name)}</option>`;
                }
                select.disabled = true;
                select.style.opacity = '0.7';
            } else {
                // Salon sahibi için Tüm Personel seçeneği
                select.innerHTML = '<option value="all">Tüm Personel</option>';
                staff.forEach(s => {
                    select.innerHTML += `<option value="${s.id || s.name}">${escapeHtml(s.name)}</option>`;
                });
                select.disabled = false;
                select.style.opacity = '1';
            }
        }
        
        function filterByStaff() {
            currentStaffFilter = document.getElementById('staffFilterSelect')?.value || 'all';
            renderAppointments();
        }
        
        function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            renderWeeklyCalendar();
            renderWeeklyCalendarNew();
        }
        
        function goToToday() {
            currentWeekStart = getWeekStart(new Date());
            renderWeeklyCalendar();
            renderWeeklyCalendarNew();
        }
        
        function renderWeeklyCalendar() {
            const container = document.getElementById('weeklyCalendar');
            const weekRange = document.getElementById('weekRange');
            if (!container) return;
            
            const staffFilter = document.getElementById('calendarStaffFilter')?.value || 'all';
            
            // Hafta tarihleri
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(currentWeekStart.getDate() + i);
                weekDays.push(d);
            }
            
            // Başlık güncelle
            const startStr = `${weekDays[0].getDate()} ${MONTHS_TR[weekDays[0].getMonth()]}`;
            const endStr = `${weekDays[6].getDate()} ${MONTHS_TR[weekDays[6].getMonth()]}`;
            weekRange.textContent = `${startStr} - ${endStr}`;
            
            // Çalışma saatleri
            const defaultHours = { open: '09:00', close: '19:00' };
            const hours = salon?.workingHours || {};
            
            // En erken ve en geç saatleri bul
            let earliestHour = 9, latestHour = 19;
            Object.values(hours).forEach(h => {
                if (!h.closed && h.open) {
                    const openH = parseInt(h.open.split(':')[0]);
                    const closeH = parseInt(h.close.split(':')[0]);
                    if (openH < earliestHour) earliestHour = openH;
                    if (closeH > latestHour) latestHour = closeH;
                }
            });
            
            // Grid oluştur
            const today = new Date().toISOString().split('T')[0];
            
            let html = '';
            
            // Header row
            html += '<div class="cal-time-header"></div>';
            weekDays.forEach(d => {
                const dateStr = d.toISOString().split('T')[0];
                const isToday = dateStr === today;
                html += `
                    <div class="cal-header ${isToday ? 'today' : ''}">
                        <div class="cal-header-day">${DAYS_SHORT[d.getDay()]}</div>
                        <div class="cal-header-date">${d.getDate()}</div>
                    </div>
                `;
            });
            
            // Time rows
            for (let hour = earliestHour; hour < latestHour; hour++) {
                const timeStr = `${hour.toString().padStart(2, '0')}:00`;
                html += `<div class="cal-time-slot">${hour}</div>`;
                
                weekDays.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayKey = DAY_KEYS[d.getDay()];
                    const dayHours = hours[dayKey] || defaultHours;
                    const isClosed = dayHours.closed || dayHours.active === false;
                    const isPast = dateStr < today;
                    
                    // Bu saat için randevular - TAKVİMDE TÜMÜNÜ GÖSTER
                    const cellAppointments = appointments.filter(apt => {
                        if (apt.date !== dateStr) return false;
                        // Süper admin: tüm durumları göster, diğerleri: cancelled hariç
                        if (!isSuperAdminMode && !['pending', 'confirmed', 'completed'].includes(apt.status)) return false;
                        
                        const aptHour = parseInt(apt.time?.split(':')[0] || '0');
                        if (aptHour !== hour) return false;
                        
                        // Personel filtresi
                        if (staffFilter !== 'all' && apt.staffName !== staffFilter && apt.staffId !== staffFilter) {
                            return false;
                        }
                        
                        return true;
                    });
                    
                    html += `
                        <div class="cal-cell ${isPast || isClosed ? 'past' : ''}" 
                             data-date="${dateStr}" 
                             data-time="${timeStr}"
                             onclick="handleCellClick(event, '${dateStr}', '${timeStr}')"
                             ondrop="handleDrop(event)" 
                             ondragover="handleDragOver(event)"
                             ondragleave="handleDragLeave(event)">
                    `;
                    
                    cellAppointments.forEach(apt => {
                        const shortName = apt.customerName?.split(' ')[0] || 'Müşteri';
                        const mins = apt.time?.slice(3,5) || '00';
                        const timeLabel = mins !== '00' ? `:${mins}` : '';
                        // Tamamlanmış randevular için farklı stil
                        const completedStyle = apt.status === 'completed' ? 'opacity: 0.6; text-decoration: line-through;' : '';
                        html += `
                            <div class="cal-appointment ${apt.status}" 
                                 draggable="${apt.status === 'completed' ? 'false' : 'true'}"
                                 ondragstart="handleDragStart(event, '${apt.id}')"
                                 onclick="event.stopPropagation(); showAppointmentDetail('${apt.id}')"
                                 title="${escapeHtml(apt.customerName)} - ${apt.service} - ${apt.time}"
                                 style="${completedStyle}">
                                ${escapeHtml(shortName)}${timeLabel}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                });
            }
            
            container.innerHTML = html;
        }
        
        // Sürükle-Bırak Fonksiyonları
        let draggedAppointmentId = null;
        
        // Takvim hücresine tıklama - boş yere tıklayınca randevu ekleme popup'ı
        function handleCellClick(event, date, time) {
            // Eğer randevu kartına tıklandıysa işlem yapma
            if (event.target.classList.contains('cal-appointment')) {
                return;
            }
            
            // Geçmiş tarihlere tıklamayı engelle
            const today = new Date().toISOString().split('T')[0];
            if (date < today) {
                showToast('Geçmiş tarihlere randevu eklenemez', 'info');
                return;
            }
            
            // Direkt modal aç (tarih ve saat ile)
            openManualAppointmentWithDate(date, time);
        }
        
        // Hızlı randevu ekleme popup'ı
        function showQuickAddPopup(event, date, time) {
            // Mevcut popup varsa kaldır
            const existingPopup = document.getElementById('quickAddPopup');
            if (existingPopup) existingPopup.remove();
            
            // Tarih formatla
            const dateObj = new Date(date);
            const dayName = DAYS_TR[DAY_KEYS[dateObj.getDay()]];
            const formattedDate = `${dateObj.getDate()} ${MONTHS_TR[dateObj.getMonth()]}`;
            
            // Popup oluştur
            const popup = document.createElement('div');
            popup.id = 'quickAddPopup';
            popup.className = 'quick-add-popup';
            popup.innerHTML = `
                <div class="quick-add-content">
                    <div class="quick-add-header">
                        <span>📅 ${dayName}, ${formattedDate}</span>
                        <span>🕐 ${time}</span>
                    </div>
                    <button class="quick-add-btn" onclick="openManualAppointmentWithDate('${date}', '${time}')">
                        ➕ Randevu Ekle
                    </button>
                    <button class="quick-add-close" onclick="closeQuickAddPopup()">✕</button>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Pozisyonu ayarla
            const rect = event.target.getBoundingClientRect();
            const popupRect = popup.getBoundingClientRect();
            
            let left = rect.left + rect.width / 2 - popupRect.width / 2;
            let top = rect.bottom + 5;
            
            // Ekran dışına taşmasını engelle
            if (left < 10) left = 10;
            if (left + popupRect.width > window.innerWidth - 10) {
                left = window.innerWidth - popupRect.width - 10;
            }
            if (top + popupRect.height > window.innerHeight - 10) {
                top = rect.top - popupRect.height - 5;
            }
            
            popup.style.left = `${left}px`;
            popup.style.top = `${top}px`;
            popup.classList.add('show');
            
            // Dışına tıklayınca kapat
            setTimeout(() => {
                document.addEventListener('click', closeQuickAddOnOutsideClick);
            }, 100);
        }
        
        function closeQuickAddPopup() {
            const popup = document.getElementById('quickAddPopup');
            if (popup) {
                popup.classList.remove('show');
                setTimeout(() => popup.remove(), 200);
            }
            document.removeEventListener('click', closeQuickAddOnOutsideClick);
        }
        
        function closeQuickAddOnOutsideClick(e) {
            const popup = document.getElementById('quickAddPopup');
            if (popup && !popup.contains(e.target) && !e.target.classList.contains('cal-cell')) {
                closeQuickAddPopup();
            }
        }
        
        // Tarih ve saat ile manuel randevu modal'ını aç
        function openManualAppointmentWithDate(date, time) {
            closeQuickAddPopup();
            // Tarihi ve saati direkt parametre olarak geçir
            openManualAppointmentModal(date, time);
        }
        
        function handleDragStart(event, appointmentId) {
            draggedAppointmentId = appointmentId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        async function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if (!draggedAppointmentId) return;
            
            const newDate = event.currentTarget.dataset.date;
            const newTime = event.currentTarget.dataset.time;
            
            if (!newDate || !newTime) return;
            
            // Geçmiş tarihe taşınamaz
            const today = new Date().toISOString().split('T')[0];
            if (newDate < today) {
                showToast('Geçmiş tarihe randevu taşınamaz', 'error');
                return;
            }
            
            const apt = appointments.find(a => a.id === draggedAppointmentId);
            if (!apt) return;
            
            const oldDate = apt.date;
            const oldTime = apt.time;
            
            if (confirm(`Randevuyu taşımak istiyor musunuz?\n\n${apt.customerName}\n${oldDate} ${oldTime} → ${newDate} ${newTime}`)) {
                try {
                    await db.collection('appointments').doc(apt.id).update({
                        date: newDate,
                        time: newTime,
                        updatedAt: new Date().toISOString(),
                        rescheduledFrom: { date: oldDate, time: oldTime }
                    });
                    
                    // Lokal güncelle
                    apt.date = newDate;
                    apt.time = newTime;
                    
                    showToast('Randevu taşındı!', 'success');
                    renderWeeklyCalendar();
                    
                    // WhatsApp bildirim linki göster
                    const customerPhone = apt.customerPhone?.replace(/\D/g, '');
                    if (customerPhone) {
                        const msg = `Merhaba ${apt.customerName},\n\nRandevunuz değiştirildi:\n\n📅 Yeni Tarih: ${formatDateTR(newDate)}\n⏰ Yeni Saat: ${newTime}\n\nBizi tercih ettiğiniz için teşekkürler!`;
                        
                        if (confirm('Müşteriye WhatsApp ile bildirim göndermek ister misiniz?')) {
                            openWhatsAppWithMessage(customerPhone, msg);
                        }
                    }
                } catch (e) {
                    console.error(e);
                    showToast('Hata oluştu', 'error');
                }
            }
            
            draggedAppointmentId = null;
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
        }
        
        function formatDateTR(dateStr) {
            const d = new Date(dateStr);
            return `${d.getDate()} ${MONTHS_TR[d.getMonth()]} ${d.getFullYear()}`;
        }
        
        function showAppointmentDetail(appointmentId) {
            const apt = appointments.find(a => a.id === appointmentId);
            if (!apt) return;
            
            // Modal oluştur
            let modal = document.getElementById('appointmentDetailModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'appointmentDetailModal';
                modal.className = 'modal-overlay';
                document.body.appendChild(modal);
            }
            
            const statusLabels = {
                'pending': '⏳ Bekliyor',
                'confirmed': '✅ Onaylı',
                'cancelled': '❌ İptal',
                'completed': '✓ Tamamlandı'
            };
            
            const paidAmount = apt.paidAmount || 0;
            const servicePrice = apt.servicePrice || 0;
            const remaining = servicePrice - paidAmount;
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 480px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white;">
                        <h3 class="modal-title">📋 Randevu Detayı</h3>
                        <button class="modal-close" onclick="closeAppointmentDetailModal()" style="color: white;">×</button>
                    </div>
                    <div class="modal-body" style="padding: 1.25rem;">
                        <!-- Müşteri Bilgisi -->
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--slate-200);">
                            <div style="width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: 700;">
                                ${(apt.customerName || 'M').charAt(0).toUpperCase()}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 1.1rem;">${escapeHtml(apt.customerName)}</div>
                                <div style="color: var(--slate-500); font-size: 0.9rem;">📞 ${formatPhoneDisplay(apt.customerPhone)}</div>
                            </div>
                            <span style="padding: 0.3rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; background: ${apt.status === 'confirmed' ? 'var(--success-light)' : apt.status === 'pending' ? 'var(--warning-light)' : 'var(--slate-200)'}; color: ${apt.status === 'confirmed' ? '#047857' : apt.status === 'pending' ? '#b45309' : 'var(--slate-600)'};">
                                ${statusLabels[apt.status] || apt.status}
                            </span>
                        </div>
                        
                        <!-- Randevu Bilgileri -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                            <div style="background: var(--slate-50); padding: 0.75rem; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: var(--slate-500); text-transform: uppercase;">Tarih</div>
                                <div style="font-weight: 600;">${formatDateTR(apt.date)}</div>
                            </div>
                            <div style="background: var(--slate-50); padding: 0.75rem; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: var(--slate-500); text-transform: uppercase;">Saat</div>
                                <div style="font-weight: 600;">${apt.time}</div>
                            </div>
                            <div style="background: var(--slate-50); padding: 0.75rem; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: var(--slate-500); text-transform: uppercase;">Hizmet</div>
                                <div style="font-weight: 600;">${escapeHtml(apt.service)}</div>
                            </div>
                            <div style="background: var(--slate-50); padding: 0.75rem; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: var(--slate-500); text-transform: uppercase;">Personel</div>
                                <div style="font-weight: 600;">${escapeHtml(apt.staffName || 'Belirtilmemiş')}</div>
                            </div>
                        </div>
                        
                        <!-- Ödeme Takibi -->
                        <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 2px solid #a7f3d0; border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.25rem;">💰</span>
                                <span style="font-weight: 700; color: #166534;">Ödeme Takibi</span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center; margin-bottom: 0.75rem;">
                                <div>
                                    <div style="font-size: 0.7rem; color: #166534;">Hizmet Ücreti</div>
                                    <div style="font-weight: 700; font-size: 1.1rem; color: #166534;">${servicePrice} ₺</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.7rem; color: #166534;">Alınan</div>
                                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--success);">${paidAmount} ₺</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.7rem; color: #166534;">Kalan</div>
                                    <div style="font-weight: 700; font-size: 1.1rem; color: ${remaining > 0 ? 'var(--warning)' : 'var(--success)'};">${remaining} ₺</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: nowrap;">
                                <input type="number" id="paymentAmountInput" 
                                       placeholder="Tutar" 
                                       value="${remaining > 0 ? remaining : ''}"
                                       style="flex: 1; min-width: 80px; padding: 0.5rem 0.6rem; border: 2px solid #a7f3d0; border-radius: 8px; font-size: 1rem; font-weight: 600;">
                                <span style="color: #166534; font-weight: 600;">₺</span>
                                <button onclick="savePayment('${apt.id}')" 
                                        style="padding: 0.5rem 0.75rem; background: var(--success); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap; font-size: 0.85rem;">
                                    💾 Kaydet
                                </button>
                            </div>
                            
                            ${apt.paymentHistory && apt.paymentHistory.length > 0 ? `
                                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed #a7f3d0;">
                                    <div style="font-size: 0.75rem; color: #166534; margin-bottom: 0.5rem;">Ödeme Geçmişi:</div>
                                    ${apt.paymentHistory.map(p => `
                                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #15803d;">
                                            <span>${new Date(p.date).toLocaleDateString('tr-TR')} ${p.note ? '- ' + p.note : ''}</span>
                                            <span style="font-weight: 600;">+${p.amount} ₺</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Not Ekleme -->
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.8rem; color: var(--slate-600); margin-bottom: 0.35rem;">📝 Not</label>
                            <textarea id="appointmentNoteInput" 
                                      placeholder="Randevu notu ekleyin..."
                                      style="width: 100%; padding: 0.6rem; border: 1px solid var(--slate-200); border-radius: 8px; font-size: 0.9rem; resize: none; height: 60px;">${apt.note || ''}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer" style="flex-wrap: wrap; gap: 0.5rem;">
                        <button class="btn btn-outline btn-sm" onclick="openWhatsApp('${apt.customerPhone}', '${apt.customerName}')">
                            📱 WhatsApp
                        </button>
                        ${apt.status !== 'cancelled' && apt.status !== 'completed' ? `
                            <button class="btn btn-outline btn-sm" onclick="openEditAppointmentModal('${apt.id}')" style="color: var(--primary);">
                                ✏️ Düzenle
                            </button>
                        ` : ''}
                        ${apt.status === 'pending' ? `
                            <button class="btn btn-success btn-sm" onclick="updateAppointmentStatus('${apt.id}', 'confirmed'); closeAppointmentDetailModal();">
                                ✅ Onayla
                            </button>
                        ` : ''}
                        ${apt.status !== 'cancelled' && apt.status !== 'completed' ? `
                            <button class="btn btn-sm" onclick="markAsCompleted('${apt.id}')" style="background: var(--slate-600); color: white;">
                                ✓ Tamamlandı
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="updateAppointmentStatus('${apt.id}', 'cancelled'); closeAppointmentDetailModal();">
                                ❌ İptal
                            </button>
                        ` : ''}
                        ${isSuperAdminMode ? `
                            <button class="btn btn-sm" onclick="deleteAppointmentPermanently('${apt.id}')" style="background: #7f1d1d; color: white;" title="Kalıcı olarak sil (Süper Admin)">
                                🗑️ Sil
                            </button>
                        ` : ''}
                        <button class="btn btn-outline btn-sm" onclick="closeAppointmentDetailModal()">Kapat</button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        // Süper Admin: Randevuyu kalıcı olarak sil
        async function deleteAppointmentPermanently(appointmentId) {
            if (!isSuperAdminMode) {
                showToast('Bu işlem için süper admin yetkisi gerekli', 'error');
                return;
            }
            
            const apt = appointments.find(a => a.id === appointmentId);
            if (!apt) return;
            
            if (!confirm(`⚠️ DİKKAT: Bu randevuyu kalıcı olarak silmek istediğinize emin misiniz?\n\nMüşteri: ${apt.customerName}\nTarih: ${apt.date} ${apt.time}\n\nBu işlem geri alınamaz!`)) {
                return;
            }
            
            try {
                await db.collection('appointments').doc(appointmentId).delete();
                
                // Lokal listeden kaldır
                const index = appointments.findIndex(a => a.id === appointmentId);
                if (index !== -1) {
                    appointments.splice(index, 1);
                }
                
                closeAppointmentDetailModal();
                refreshAllViews();
                showToast('Randevu kalıcı olarak silindi', 'success');
                
            } catch (error) {
                console.error('Randevu silme hatası:', error);
                showToast('Silme işlemi başarısız', 'error');
            }
        }

        function closeAppointmentDetailModal() {
            const modal = document.getElementById('appointmentDetailModal');
            if (modal) modal.classList.remove('active');
        }
        
        // ========== RANDEVU DÜZENLEME ==========
        
        function openEditAppointmentModal(appointmentId) {
            const apt = appointments.find(a => a.id === appointmentId);
            if (!apt) return;
            
            closeAppointmentDetailModal();
            
            let modal = document.getElementById('editAppointmentModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'editAppointmentModal';
                modal.className = 'modal-overlay';
                document.body.appendChild(modal);
            }
            
            // Hizmetler ve personel seçenekleri
            const services = salon?.services || [];
            const staff = salon?.staff || [];
            
            const serviceOptions = services.map((s, i) => {
                const name = typeof s === 'string' ? s : s.name;
                const price = typeof s === 'object' ? s.price : 0;
                const selected = name === apt.service ? 'selected' : '';
                return `<option value="${i}" data-name="${name}" data-price="${price}" ${selected}>${name} - ${price}₺</option>`;
            }).join('');
            
            const staffOptions = staff.map(s => {
                const selected = (s.name === apt.staffName || s.id === apt.staffId) ? 'selected' : '';
                return `<option value="${s.id}" data-name="${s.name}" ${selected}>${s.name}</option>`;
            }).join('');
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 420px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white;">
                        <h3 class="modal-title">✏️ Randevu Düzenle</h3>
                        <button class="modal-close" onclick="closeEditAppointmentModal()" style="color: white;">×</button>
                    </div>
                    <div class="modal-body" style="padding: 1.25rem;">
                        <form id="editAppointmentForm" onsubmit="saveEditedAppointment(event, '${apt.id}')">
                            <!-- Uyarı -->
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                                <div style="font-size: 0.8rem; color: #92400e;">
                                    ⚠️ <strong>Dikkat:</strong> Değişiklikler müşteriye otomatik bildirilmez. Gerekirse WhatsApp ile bilgilendirin.
                                </div>
                            </div>
                            
                            <!-- Müşteri Bilgisi (sadece görüntüleme) -->
                            <div style="background: var(--slate-50); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                                <div style="font-weight: 600;">${escapeHtml(apt.customerName)}</div>
                                <div style="font-size: 0.85rem; color: var(--slate-500);">📞 ${formatPhoneDisplay(apt.customerPhone)}</div>
                            </div>
                            
                            <!-- Tarih ve Saat -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="font-weight: 600; font-size: 0.85rem; color: var(--slate-700); display: block; margin-bottom: 0.35rem;">📅 Tarih</label>
                                    <input type="date" id="editDate" class="form-input" value="${apt.date}" required style="width: 100%;">
                                </div>
                                <div>
                                    <label style="font-weight: 600; font-size: 0.85rem; color: var(--slate-700); display: block; margin-bottom: 0.35rem;">🕐 Saat</label>
                                    <input type="time" id="editTime" class="form-input" value="${apt.time}" required style="width: 100%;">
                                </div>
                            </div>
                            
                            <!-- Hizmet -->
                            <div style="margin-bottom: 1rem;">
                                <label style="font-weight: 600; font-size: 0.85rem; color: var(--slate-700); display: block; margin-bottom: 0.35rem;">✂️ Hizmet</label>
                                <select id="editService" class="form-input" required style="width: 100%;">
                                    ${serviceOptions}
                                </select>
                            </div>
                            
                            <!-- Personel -->
                            <div style="margin-bottom: 1rem;">
                                <label style="font-weight: 600; font-size: 0.85rem; color: var(--slate-700); display: block; margin-bottom: 0.35rem;">👤 Personel</label>
                                <select id="editStaff" class="form-input" style="width: 100%;">
                                    <option value="">Belirtilmemiş</option>
                                    ${staffOptions}
                                </select>
                            </div>
                            
                            <!-- Butonlar -->
                            <div style="display: flex; gap: 0.75rem; margin-top: 1.25rem;">
                                <button type="button" class="btn btn-outline" onclick="closeEditAppointmentModal()" style="flex: 1;">
                                    İptal
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 2;">
                                    💾 Değişiklikleri Kaydet
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function closeEditAppointmentModal() {
            const modal = document.getElementById('editAppointmentModal');
            if (modal) modal.classList.remove('active');
        }
        
        async function saveEditedAppointment(event, appointmentId) {
            event.preventDefault();
            
            const apt = appointments.find(a => a.id === appointmentId);
            if (!apt) return;
            
            const newDate = document.getElementById('editDate').value;
            const newTime = document.getElementById('editTime').value;
            const serviceSelect = document.getElementById('editService');
            const staffSelect = document.getElementById('editStaff');
            
            const serviceOption = serviceSelect.selectedOptions[0];
            const serviceName = serviceOption?.dataset?.name || apt.service;
            const servicePrice = parseInt(serviceOption?.dataset?.price) || apt.servicePrice;
            
            const staffOption = staffSelect.selectedOptions[0];
            const staffId = staffSelect.value || null;
            const staffName = staffOption?.dataset?.name || null;
            
            // Değişiklik var mı kontrol et
            const hasChanges = newDate !== apt.date || 
                              newTime !== apt.time || 
                              serviceName !== apt.service ||
                              staffName !== apt.staffName;
            
            if (!hasChanges) {
                showToast('Değişiklik yapılmadı', 'info');
                closeEditAppointmentModal();
                return;
            }
            
            const loadingToast = showToast('Kaydediliyor...', 'info');
            
            try {
                const updates = {
                    date: newDate,
                    time: newTime,
                    service: serviceName,
                    serviceName: serviceName,
                    servicePrice: servicePrice,
                    staffId: staffId,
                    staffName: staffName,
                    updatedAt: new Date().toISOString(),
                    editedBy: isStaffMode ? currentStaffName : 'salon_owner',
                    editHistory: firebase.firestore.FieldValue.arrayUnion({
                        date: new Date().toISOString(),
                        changes: {
                            oldDate: apt.date,
                            newDate: newDate,
                            oldTime: apt.time,
                            newTime: newTime,
                            oldService: apt.service,
                            newService: serviceName
                        },
                        editedBy: isStaffMode ? currentStaffName : 'salon_owner'
                    })
                };
                
                await db.collection('appointments').doc(appointmentId).update(updates);
                
                // Lokal güncelle
                Object.assign(apt, {
                    date: newDate,
                    time: newTime,
                    service: serviceName,
                    serviceName: serviceName,
                    servicePrice: servicePrice,
                    staffId: staffId,
                    staffName: staffName,
                    updatedAt: new Date().toISOString()
                });
                
                if (loadingToast && loadingToast.remove) loadingToast.remove();
                
                refreshAllViews();
                closeEditAppointmentModal();
                showToast('Randevu güncellendi ✓', 'success');
                
                // WhatsApp ile bilgilendirme öner
                setTimeout(() => {
                    if (confirm('Müşteriye değişiklik hakkında WhatsApp mesajı göndermek ister misiniz?')) {
                        const msg = `Merhaba ${apt.customerName}, randevunuz güncellendi: ${formatDateTR(newDate)} ${newTime}. ${salon.name}`;
                        openWhatsAppWithMessage(apt.customerPhone, msg);
                    }
                }, 500);
                
            } catch (error) {
                console.error('Randevu düzenleme hatası:', error);
                if (loadingToast && loadingToast.remove) loadingToast.remove();
                showToast('Kaydetme hatası. Tekrar deneyin.', 'error');
            }
        }
        
        // Ödeme kaydet
        async function savePayment(appointmentId) {
            const apt = appointments.find(a => a.id === appointmentId);
            if (!apt) return;
            
            const amountInput = document.getElementById('paymentAmountInput');
            const amount = parseFloat(amountInput.value);
            
            if (!amount || amount <= 0) {
                showToast('Geçerli bir tutar girin', 'error');
                return;
            }
            
            const noteInput = document.getElementById('appointmentNoteInput');
            const note = noteInput?.value || '';
            
            try {
                const currentPaid = apt.paidAmount || 0;
                const newPaid = currentPaid + amount;
                
                const paymentEntry = {
                    amount: amount,
                    date: new Date().toISOString(),
                    note: note || `${amount} ₺ ödeme alındı`
                };
                
                const paymentHistory = apt.paymentHistory || [];
                paymentHistory.push(paymentEntry);
                
                await db.collection('appointments').doc(appointmentId).update({
                    paidAmount: newPaid,
                    paymentHistory: paymentHistory,
                    note: note,
                    updatedAt: new Date().toISOString()
                });
                
                // Lokal güncelle
                apt.paidAmount = newPaid;
                apt.paymentHistory = paymentHistory;
                apt.note = note;
                
                showToast(`${amount} ₺ ödeme kaydedildi!`, 'success');
                closeAppointmentDetailModal();
                
                // Listeyi güncelle
                renderAppointments();
                renderPendingRequests();
                updateStatsNew();
                
            } catch (error) {
                console.error('Payment save error:', error);
                showToast('Ödeme kaydedilemedi', 'error');
            }
        }
        
        // Randevuyu tamamlandı olarak işaretle
        async function markAsCompleted(appointmentId) {
            const apt = appointments.find(a => a.id === appointmentId);
            if (!apt) return;
            
            // Ödeme kontrolü
            const noteInput = document.getElementById('appointmentNoteInput');
            const note = noteInput?.value || apt.note || '';
            
            try {
                await db.collection('appointments').doc(appointmentId).update({
                    status: 'completed',
                    note: note,
                    completedAt: new Date().toISOString()
                });
                
                apt.status = 'completed';
                apt.note = note;
                
                showToast('Randevu tamamlandı!', 'success');
                closeAppointmentDetailModal();
                
                renderAppointments();
                renderWeeklyCalendarNew();
                renderPendingRequests();
                updateStatsNew();
                
            } catch (error) {
                console.error('Complete error:', error);
                showToast('Hata oluştu', 'error');
            }
        }
        
        // ==================== YENİ RENDER FONKSİYONLARI ====================
        
        // Yeni istatistikleri güncelle
        function updateStatsNew() {
            const today = new Date().toISOString().split('T')[0];
            const thisMonth = today.substring(0, 7);
            
            const todayApts = appointments.filter(a => a.date === today && ['pending', 'confirmed'].includes(a.status)).length;
            const pendingApts = appointments.filter(a => a.status === 'pending').length;
            
            // Bu ayki gelir (ödenen tutarlar)
            const monthlyRevenue = appointments
                .filter(a => a.date?.startsWith(thisMonth) && a.paidAmount > 0)
                .reduce((sum, a) => sum + (a.paidAmount || 0), 0);
            
            // Mini stats
            const statTodayMini = document.getElementById('statTodayMini');
            const statPendingMini = document.getElementById('statPendingMini');
            const statRevenueMini = document.getElementById('statRevenueMini');
            
            if (statTodayMini) statTodayMini.textContent = todayApts;
            if (statPendingMini) statPendingMini.textContent = pendingApts;
            if (statRevenueMini) statRevenueMini.textContent = monthlyRevenue.toLocaleString('tr-TR') + '₺';
            
            // Bekleyen badge
            const pendingCount = document.getElementById('pendingCount');
            if (pendingCount) pendingCount.textContent = pendingApts;
            
            // Eski stats da güncelle
            const statToday = document.getElementById('statToday');
            const statPending = document.getElementById('statPending');
            const statRevenue = document.getElementById('statRevenue');
            
            if (statToday) statToday.textContent = todayApts;
            if (statPending) statPending.textContent = pendingApts;
            if (statRevenue) statRevenue.textContent = monthlyRevenue.toLocaleString('tr-TR') + ' ₺';
        }
        
        // Bekleyen talepleri render et
        function renderPendingRequests() {
            const container = document.getElementById('pendingRequestsList');
            if (!container) return;
            
            const pendingApts = appointments
                .filter(a => a.status === 'pending')
                .sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
            
            // Badge güncelle
            const pendingCount = document.getElementById('pendingCount');
            if (pendingCount) pendingCount.textContent = pendingApts.length;
            
            if (pendingApts.length === 0) {
                container.innerHTML = `
                    <div class="empty-requests">
                        <div class="empty-icon">✅</div>
                        <p>Bekleyen talep yok</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = pendingApts.map(apt => `
                <div class="request-card">
                    <div class="request-header">
                        <div class="customer-name">${escapeHtml(apt.customerName)}</div>
                        <div class="request-time">${apt.time}</div>
                    </div>
                    <div class="request-details">
                        <span>📅 ${formatDateTR(apt.date)}</span>
                        <span>✂️ ${escapeHtml(apt.service)} - ${apt.servicePrice || 0}₺</span>
                        ${apt.staffName ? `<span>👤 ${escapeHtml(apt.staffName)}</span>` : ''}
                    </div>
                    <div class="request-actions">
                        <button class="btn-approve" onclick="quickApprove('${apt.id}')">✅ Onayla</button>
                        <button class="btn-reject" onclick="quickReject('${apt.id}')">❌</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Bugünkü randevuları render et
        function renderTodayAppointments() {
            const container = document.getElementById('todayAppointmentsList');
            if (!container) return;
            
            const today = new Date().toISOString().split('T')[0];
            const todayApts = appointments
                .filter(a => a.date === today && ['pending', 'confirmed'].includes(a.status))
                .sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            
            // Badge güncelle
            const todayCount = document.getElementById('todayCount');
            if (todayCount) todayCount.textContent = todayApts.length;
            
            if (todayApts.length === 0) {
                container.innerHTML = `
                    <div class="empty-requests">
                        <div class="empty-icon">📅</div>
                        <p>Bugün randevu yok</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = todayApts.map(apt => `
                <div class="request-card" style="border-left-color: ${apt.status === 'confirmed' ? 'var(--success)' : 'var(--warning)'};">
                    <div class="request-header">
                        <div class="customer-name">${escapeHtml(apt.customerName)}</div>
                        <div class="request-time" style="color: ${apt.status === 'confirmed' ? 'var(--success)' : 'var(--warning)'};">${apt.time}</div>
                    </div>
                    <div class="request-details">
                        <span>✂️ ${escapeHtml(apt.service)}</span>
                        <span>💰 ${apt.servicePrice || 0}₺ ${apt.paidAmount ? `(${apt.paidAmount}₺ alındı)` : ''}</span>
                        ${apt.staffName ? `<span>👤 ${escapeHtml(apt.staffName)}</span>` : ''}
                    </div>
                    <div class="request-actions">
                        <button class="btn-approve" onclick="showAppointmentDetail('${apt.id}')" style="background: var(--slate-600);">
                            📋 Detay
                        </button>
                        ${apt.status === 'pending' ? `
                            <button class="btn-approve" onclick="quickApprove('${apt.id}')" style="flex: none; padding: 0.4rem 0.6rem;">✅</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Side panel sekme değiştirme
        function switchSideTab(tabName) {
            // Sekme butonlarını güncelle
            document.querySelectorAll('.side-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // İçerikleri göster/gizle
            const pendingList = document.getElementById('pendingRequestsList');
            const todayList = document.getElementById('todayAppointmentsList');
            
            if (tabName === 'pending') {
                pendingList.style.display = 'block';
                todayList.style.display = 'none';
            } else {
                pendingList.style.display = 'none';
                todayList.style.display = 'block';
                renderTodayAppointments();
            }
        }
        
        // Hızlı onaylama
        async function quickApprove(appointmentId) {
            // Operatör kontrolü
            if (currentStaffRole === 'operator') {
                showToast('Operatör olarak randevu onaylama yetkiniz yok. Salon sahibine başvurun.', 'error');
                return;
            }
            // Asistan kontrolü
            if (currentStaffRole === 'assistant') {
                showToast('Asistan olarak sadece görüntüleme yetkiniz var', 'error');
                return;
            }
            
            const loadingToast = showToast('Onaylanıyor...', 'info');
            
            try {
                await db.collection('appointments').doc(appointmentId).update({ 
                    status: 'confirmed',
                    updatedAt: new Date().toISOString(),
                    confirmedAt: new Date().toISOString(),
                    confirmedBy: isStaffMode ? currentStaffName : 'salon_owner'
                });
                
                const apt = appointments.find(a => a.id === appointmentId);
                if (apt) {
                    apt.status = 'confirmed';
                    apt.confirmedAt = new Date().toISOString();
                }
                
                if (loadingToast && loadingToast.remove) loadingToast.remove();
                
                // Tüm görünümleri güncelle
                refreshAllViews();
                
                // WhatsApp bildirimi seçeneği
                if (apt) {
                    showNotificationModal(apt, 'confirmed');
                }
                
            } catch (error) {
                console.error('Quick approve error:', error);
                if (loadingToast && loadingToast.remove) loadingToast.remove();
                showToast('Hata oluştu. Tekrar deneyin.', 'error');
                // Veriyi yeniden yükle
                setTimeout(() => loadAppointments(), 1000);
            }
        }
        
        // Hızlı reddetme
        async function quickReject(appointmentId) {
            // Operatör kontrolü
            if (currentStaffRole === 'operator') {
                showToast('Operatör olarak randevu iptal etme yetkiniz yok. Salon sahibine başvurun.', 'error');
                return;
            }
            // Asistan kontrolü
            if (currentStaffRole === 'assistant') {
                showToast('Asistan olarak sadece görüntüleme yetkiniz var', 'error');
                return;
            }
            
            if (!confirm('Bu randevuyu iptal etmek istediğinize emin misiniz?')) return;
            
            const loadingToast = showToast('İptal ediliyor...', 'info');
            
            try {
                await db.collection('appointments').doc(appointmentId).update({ 
                    status: 'cancelled',
                    updatedAt: new Date().toISOString(),
                    cancelledAt: new Date().toISOString(),
                    cancelledBy: isStaffMode ? currentStaffName : 'salon_owner'
                });
                
                const apt = appointments.find(a => a.id === appointmentId);
                if (apt) {
                    apt.status = 'cancelled';
                    apt.cancelledAt = new Date().toISOString();
                }
                
                if (loadingToast && loadingToast.remove) loadingToast.remove();
                
                // Tüm görünümleri güncelle
                refreshAllViews();
                
                // Slot açma modal'ı
                if (apt) {
                    showCancelledSlotModal(apt);
                }
                
            } catch (error) {
                console.error('Quick reject error:', error);
                if (loadingToast && loadingToast.remove) loadingToast.remove();
                showToast('Hata oluştu. Tekrar deneyin.', 'error');
                // Veriyi yeniden yükle
                setTimeout(() => loadAppointments(), 1000);
            }
        }
        
        // Yeni haftalık takvim render
        function renderWeeklyCalendarNew() {
            const container = document.getElementById('weeklyCalendarNew');
            const weekRange = document.getElementById('weekRangeNew');
            if (!container) return;
            
            const staffFilter = document.getElementById('calendarStaffFilterNew')?.value || 'all';
            
            // Hafta tarihleri
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(currentWeekStart.getDate() + i);
                weekDays.push(d);
            }
            
            // Başlık güncelle
            if (weekRange) {
                const startStr = `${weekDays[0].getDate()} ${MONTHS_TR[weekDays[0].getMonth()]}`;
                const endStr = `${weekDays[6].getDate()} ${MONTHS_TR[weekDays[6].getMonth()]}`;
                weekRange.textContent = `${startStr} - ${endStr}`;
            }
            
            // Eski weekRange da güncelle
            const oldWeekRange = document.getElementById('weekRange');
            if (oldWeekRange) {
                const startStr = `${weekDays[0].getDate()} ${MONTHS_TR[weekDays[0].getMonth()]}`;
                const endStr = `${weekDays[6].getDate()} ${MONTHS_TR[weekDays[6].getMonth()]}`;
                oldWeekRange.textContent = `${startStr} - ${endStr}`;
            }
            
            // Çalışma saatleri
            const defaultHours = { open: '09:00', close: '19:00' };
            const hours = salon?.workingHours || {};
            
            // En erken ve en geç saatleri bul
            let earliestHour = 9, latestHour = 20;
            Object.values(hours).forEach(h => {
                if (!h.closed && h.open) {
                    const openH = parseInt(h.open.split(':')[0]);
                    const closeH = parseInt(h.close.split(':')[0]);
                    if (openH < earliestHour) earliestHour = openH;
                    if (closeH > latestHour) latestHour = closeH;
                }
            });
            
            const today = new Date().toISOString().split('T')[0];
            
            let html = '';
            
            // Header row
            html += '<div class="cal-time-header"></div>';
            weekDays.forEach(d => {
                const dateStr = d.toISOString().split('T')[0];
                const isToday = dateStr === today;
                html += `
                    <div class="cal-header ${isToday ? 'today' : ''}">
                        <div class="cal-header-day">${DAYS_SHORT[d.getDay()]}</div>
                        <div class="cal-header-date">${d.getDate()}</div>
                    </div>
                `;
            });
            
            // Time rows
            for (let hour = earliestHour; hour < latestHour; hour++) {
                const timeStr = `${hour.toString().padStart(2, '0')}:00`;
                html += `<div class="cal-time-slot">${hour}</div>`;
                
                weekDays.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayKey = DAY_KEYS[d.getDay()];
                    const dayHours = hours[dayKey] || defaultHours;
                    const isClosed = dayHours.closed || dayHours.active === false;
                    const isPast = dateStr < today;
                    
                    // Bu saat için randevular - TAKVİMDE TÜMÜNÜ GÖSTER
                    const cellAppointments = appointments.filter(apt => {
                        if (apt.date !== dateStr) return false;
                        // Süper admin: tüm durumları göster, diğerleri: cancelled hariç
                        if (!isSuperAdminMode && !['pending', 'confirmed', 'completed'].includes(apt.status)) return false;
                        
                        const aptHour = parseInt(apt.time?.split(':')[0] || '0');
                        if (aptHour !== hour) return false;
                        
                        // Personel filtresi
                        if (staffFilter !== 'all' && apt.staffName !== staffFilter && apt.staffId !== staffFilter) {
                            return false;
                        }
                        
                        return true;
                    });
                    
                    html += `
                        <div class="cal-cell ${isPast || isClosed ? 'past' : ''}" 
                             data-date="${dateStr}" 
                             data-time="${timeStr}"
                             onclick="handleCellClick(event, '${dateStr}', '${timeStr}')"
                             ondrop="handleDropNew(event)" 
                             ondragover="handleDragOver(event)"
                             ondragleave="handleDragLeave(event)">
                    `;
                    
                    cellAppointments.forEach(apt => {
                        const shortName = apt.customerName?.split(' ')[0] || 'Müşteri';
                        const mins = apt.time?.slice(3,5) || '00';
                        const timeLabel = mins !== '00' ? `:${mins}` : '';
                        // Tamamlanmış randevular için farklı stil
                        const completedStyle = apt.status === 'completed' ? 'opacity: 0.6; text-decoration: line-through;' : '';
                        html += `
                            <div class="cal-appointment ${apt.status}" 
                                 draggable="${apt.status === 'completed' ? 'false' : 'true'}"
                                 ondragstart="handleDragStart(event, '${apt.id}')"
                                 onclick="event.stopPropagation(); showAppointmentDetail('${apt.id}')"
                                 title="${escapeHtml(apt.customerName)} - ${apt.service} - ${apt.time}"
                                 style="${completedStyle}">
                                ${escapeHtml(shortName)}${timeLabel}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                });
            }
            
            container.innerHTML = html;
            
            // Eski takvimi de güncelle
            const oldContainer = document.getElementById('weeklyCalendar');
            if (oldContainer) {
                oldContainer.innerHTML = html;
            }
        }
        
        // Yeni drop handler (mobil dostu)
        async function handleDropNew(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if (!draggedAppointmentId) return;
            
            const newDate = event.currentTarget.dataset.date;
            const newTime = event.currentTarget.dataset.time;
            
            if (!newDate || !newTime) return;
            
            // Geçmiş tarihe taşınamaz
            const today = new Date().toISOString().split('T')[0];
            if (newDate < today) {
                showToast('Geçmiş tarihe randevu taşınamaz', 'error');
                return;
            }
            
            const apt = appointments.find(a => a.id === draggedAppointmentId);
            if (!apt) return;
            
            const oldDate = apt.date;
            const oldTime = apt.time;
            
            if (confirm(`Randevuyu taşımak istiyor musunuz?\n\n${apt.customerName}\n${formatDateTR(oldDate)} ${oldTime} → ${formatDateTR(newDate)} ${newTime}`)) {
                try {
                    await db.collection('appointments').doc(apt.id).update({
                        date: newDate,
                        time: newTime,
                        updatedAt: new Date().toISOString(),
                        rescheduledFrom: { date: oldDate, time: oldTime }
                    });
                    
                    // Lokal güncelle
                    apt.date = newDate;
                    apt.time = newTime;
                    
                    showToast('Randevu taşındı!', 'success');
                    renderWeeklyCalendarNew();
                    renderAppointments();
                    
                    // WhatsApp bildirim linki göster
                    const customerPhone = apt.customerPhone?.replace(/\D/g, '');
                    if (customerPhone) {
                        const msg = `Merhaba ${apt.customerName},\n\nRandevunuz değiştirildi:\n\n📅 Yeni Tarih: ${formatDateTR(newDate)}\n⏰ Yeni Saat: ${newTime}\n\nBizi tercih ettiğiniz için teşekkürler!`;
                        
                        if (confirm('Müşteriye WhatsApp ile bildirim göndermek ister misiniz?')) {
                            openWhatsAppWithMessage(customerPhone, msg);
                        }
                    }
                } catch (e) {
                    console.error(e);
                    showToast('Hata oluştu', 'error');
                }
            }
            
            draggedAppointmentId = null;
        }
        
        // Staff filter'ı yeni takvim için de doldur
        function populateStaffFiltersNew() {
            const staff = salon?.staff || [];
            
            const filterNew = document.getElementById('calendarStaffFilterNew');
            if (filterNew) {
                // Personel modunda sadece kendi adı gösterilsin
                if (isStaffMode) {
                    filterNew.innerHTML = '';
                    const currentStaff = staff.find(s => s.id === currentStaffId || s.name === currentStaffName);
                    if (currentStaff) {
                        filterNew.innerHTML = `<option value="${currentStaff.id || currentStaff.name}" selected>${escapeHtml(currentStaff.name)}</option>`;
                    }
                    filterNew.disabled = true;
                    filterNew.style.opacity = '0.7';
                } else {
                    // Salon sahibi için Tüm Personel seçeneği
                    filterNew.innerHTML = '<option value="all">Tüm Personel</option>';
                    staff.forEach(s => {
                        filterNew.innerHTML += `<option value="${s.id || s.name}">${escapeHtml(s.name)}</option>`;
                    });
                    filterNew.disabled = false;
                    filterNew.style.opacity = '1';
                }
            }
        }
        
        // ==================== HAFTALIK TAKVİM SON ====================
        
        // Logout
        function logout() {
            // Tüm oturum verilerini temizle
            localStorage.removeItem('salonSession');
            localStorage.removeItem('staffSession');
            localStorage.removeItem('zamanli_admin');
            sessionStorage.clear();
            
            // Ana sayfaya yönlendir
            window.location.href = window.location.pathname;
        }
        
        // Show Toast
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} active`;
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }
        
        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        // Telefon numarasını doğru formatta göster (05XX XXX XX XX)
        function formatPhoneDisplay(phone) {
            if (!phone) return '-';
            // Sadece rakamları al
            let digits = phone.toString().replace(/\D/g, '');
            // Son 10 haneyi al
            digits = digits.slice(-10);
            // Başına 0 ekle
            if (digits.length === 10 && !digits.startsWith('0')) {
                return '0' + digits;
            }
            return digits;
        }
        
        // ==================== GOOGLE TAKVİM EXPORT ====================
        function exportToGoogleCalendar() {
            // Bugünden itibaren onaylı/bekleyen randevuları al
            const today = new Date().toISOString().split('T')[0];
            const futureApts = appointments.filter(apt => 
                apt.date >= today && 
                (apt.status === 'confirmed' || apt.status === 'pending')
            );
            
            if (futureApts.length === 0) {
                showToast('Aktarılacak randevu yok', 'error');
                return;
            }
            
            // ICS dosyası oluştur
            let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Zamanli//TR
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:${salon.name} Randevuları
`;
            
            futureApts.forEach(apt => {
                const startDate = new Date(apt.date + 'T' + apt.time + ':00');
                const endDate = new Date(startDate.getTime() + (apt.serviceDuration || 30) * 60000);
                
                const formatICSDate = (d) => {
                    return d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                };
                
                const uid = apt.id + '@zamanli.com';
                const summary = `${apt.customerName} - ${apt.service}`;
                const description = `Müşteri: ${apt.customerName}\\nTelefon: ${apt.customerPhone}\\nHizmet: ${apt.service}\\nTutar: ${apt.servicePrice || '-'} TL`;
                
                icsContent += `BEGIN:VEVENT
UID:${uid}
DTSTAMP:${formatICSDate(new Date())}
DTSTART:${formatICSDate(startDate)}
DTEND:${formatICSDate(endDate)}
SUMMARY:${summary}
DESCRIPTION:${description}
STATUS:${apt.status === 'confirmed' ? 'CONFIRMED' : 'TENTATIVE'}
END:VEVENT
`;
            });
            
            icsContent += 'END:VCALENDAR';
            
            // İndir
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${salon.slug}-randevular.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast(`${futureApts.length} randevu aktarıldı`, 'success');
        }
        
        // Tek randevuyu Google Takvime ekle
        function addSingleToGoogleCalendar(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt) return;
            
            const startDate = new Date(apt.date + 'T' + apt.time + ':00');
            const endDate = new Date(startDate.getTime() + (apt.serviceDuration || 30) * 60000);
            
            const formatGoogleDate = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            
            const title = encodeURIComponent(`${apt.customerName} - ${apt.service}`);
            const details = encodeURIComponent(`Müşteri: ${apt.customerName}\nTelefon: ${apt.customerPhone}\nHizmet: ${apt.service}\nTutar: ${apt.servicePrice || '-'} TL`);
            const location = encodeURIComponent(salon.address || `${salon.district}, ${salon.city}`);
            const dates = `${formatGoogleDate(startDate)}/${formatGoogleDate(endDate)}`;
            
            const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dates}&details=${details}&location=${location}`;
            window.open(url, '_blank');
        }
        
        // PWA Install
        let deferredPrompt;
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Sadece bir kere göster - 3 saniye sonra
            if (shouldShowPWABanner()) {
                setTimeout(() => {
                    if (deferredPrompt) {
                        document.getElementById('pwaBanner').classList.add('show');
                    }
                }, 3000);
            }
        });
        
        // iOS için: beforeinstallprompt olmayacak, manuel göster
        if (isIOS && !isStandalone && shouldShowPWABanner()) {
            setTimeout(() => {
                document.getElementById('pwaBanner').classList.add('show');
            }, 3000);
        }
        
        function installPWA() {
            if (isIOS) {
                // iOS için kurulum rehberi göster
                showIOSInstallGuide();
                return;
            }
            
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => {
                deferredPrompt = null;
                document.getElementById('pwaBanner').classList.remove('show');
                // Bir daha gösterme
                localStorage.setItem('pwa-panel-installed', 'true');
            });
        }
        
        function showIOSInstallGuide() {
            // Mevcut modal varsa kaldır
            const existingModal = document.getElementById('iosInstallModal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'iosInstallModal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;padding:1rem;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div style="background:white;border-radius:20px;max-width:360px;width:100%;overflow:hidden;box-shadow:0 25px 50px rgba(0,0,0,0.25);">
                    <div style="background:linear-gradient(135deg,#6366f1,#4f46e5);padding:1.25rem;display:flex;align-items:center;justify-content:space-between;">
                        <div style="display:flex;align-items:center;gap:0.75rem;">
                            <span style="font-size:1.5rem;">📲</span>
                            <h3 style="margin:0;color:white;font-size:1.1rem;">iPhone'a Yükle</h3>
                        </div>
                        <button onclick="this.closest('#iosInstallModal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:1.25rem;cursor:pointer;">×</button>
                    </div>
                    <div style="padding:1.25rem;">
                        ${!isSafari ? '<div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:10px;padding:0.75rem;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;"><span>⚠️</span><p style="margin:0;font-size:0.85rem;">PWA yüklemek için <strong>Safari</strong> kullanın</p></div>' : ''}
                        
                        <div style="display:flex;flex-direction:column;gap:1rem;">
                            <div style="display:flex;align-items:flex-start;gap:0.75rem;">
                                <div style="width:28px;height:28px;background:linear-gradient(135deg,#10B981,#059669);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:0.85rem;flex-shrink:0;">1</div>
                                <div>
                                    <p style="margin:0;font-size:0.9rem;">Ekranın altındaki <strong>Paylaş</strong> butonuna dokunun</p>
                                    <div style="margin-top:0.5rem;background:#f1f5f9;border-radius:8px;padding:0.5rem 0.75rem;display:inline-flex;align-items:center;gap:0.35rem;">
                                        <svg width="18" height="22" viewBox="0 0 22 28" fill="none"><rect x="1" y="8" width="20" height="18" rx="2" stroke="#10B981" stroke-width="2"/><path d="M11 2v14M6 7l5-5 5 5" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display:flex;align-items:flex-start;gap:0.75rem;">
                                <div style="width:28px;height:28px;background:linear-gradient(135deg,#10B981,#059669);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:0.85rem;flex-shrink:0;">2</div>
                                <div>
                                    <p style="margin:0;font-size:0.9rem;">Listede <strong>"Ana Ekrana Ekle"</strong> seçin</p>
                                    <div style="margin-top:0.5rem;background:#f1f5f9;border-radius:8px;padding:0.5rem 0.75rem;display:inline-flex;align-items:center;gap:0.35rem;font-size:0.85rem;">
                                        <span>➕</span> Ana Ekrana Ekle
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display:flex;align-items:flex-start;gap:0.75rem;">
                                <div style="width:28px;height:28px;background:linear-gradient(135deg,#10B981,#059669);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:0.85rem;flex-shrink:0;">3</div>
                                <div>
                                    <p style="margin:0;font-size:0.9rem;">Sağ üstteki <strong>"Ekle"</strong> butonuna dokunun</p>
                                    <div style="margin-top:0.5rem;background:#3b82f6;color:white;border-radius:8px;padding:0.35rem 0.75rem;display:inline-block;font-size:0.85rem;font-weight:600;">Ekle</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top:1rem;background:#ecfdf5;border-radius:10px;padding:0.75rem;display:flex;align-items:center;gap:0.5rem;">
                            <span>✨</span>
                            <p style="margin:0;font-size:0.8rem;color:#065f46;">Kurulumdan sonra Zamanli ana ekranınızda bir uygulama gibi görünecek!</p>
                        </div>
                    </div>
                    <div style="padding:1rem 1.25rem;border-top:1px solid #e2e8f0;">
                        <button onclick="this.closest('#iosInstallModal').remove(); closePWABanner();" style="width:100%;padding:0.75rem;background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;border:none;border-radius:10px;font-weight:600;font-size:0.95rem;cursor:pointer;">Anladım</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closePWABanner() {
            document.getElementById('pwaBanner').classList.remove('show');
            // Bir daha gösterme (kullanıcı kapattıysa)
            localStorage.setItem('pwa-panel-dismissed', 'true');
        }
        
        // PWA banner'ı gösterme kontrolü
        function shouldShowPWABanner() {
            // Zaten yüklendiyse veya reddedildiyse gösterme
            if (localStorage.getItem('pwa-panel-installed') === 'true') return false;
            if (localStorage.getItem('pwa-panel-dismissed') === 'true') return false;
            // Standalone modda çalışıyorsa gösterme (zaten yüklü)
            if (window.matchMedia('(display-mode: standalone)').matches) return false;
            if (window.navigator.standalone === true) return false;
            return true;
        }
        
        // ========== SERVICE WORKER - PUSH BİLDİRİMLER İÇİN AKTİF ==========
        // Push notification için SW gerekli, sadece cache/update mesajlarını yoksay
        (function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                // SW'yi kaydet (push notification için gerekli)
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log('[Panel] SW registered for push notifications');
                        
                        // NotificationManager'a registration'ı bildir
                        if (typeof NotificationManager !== 'undefined') {
                            NotificationManager.swRegistration = reg;
                        }
                    })
                    .catch(err => console.log('[Panel] SW registration error:', err));
                
                // SW mesajlarını dinle
                navigator.serviceWorker.addEventListener('message', (e) => {
                    // Güncelleme mesajlarını yoksay (sayfa yenilemesini engelle)
                    if (e.data?.type === 'SW_UPDATED') {
                        console.log('[Panel] SW update message ignored');
                        return;
                    }
                    
                    // Ses çalma mesajı gelirse
                    if (e.data?.type === 'PLAY_NOTIFICATION_SOUND') {
                        console.log('[Panel] Playing notification sound from SW');
                        if (typeof NotificationManager !== 'undefined') {
                            NotificationManager.playSound();
                        }
                    }
                });
                
                // Controller change event'ini yoksay (auto-reload engelle)
                let controllerChangeIgnored = false;
                navigator.serviceWorker.addEventListener('controllerchange', (e) => {
                    if (!controllerChangeIgnored) {
                        controllerChangeIgnored = true;
                        console.log('[Panel] Controller change - NOT reloading');
                    }
                });
            }
        })();
        
        // ========== RAPORLAR FONKSİYONLARI ==========
        let currentReportPeriod = 'week';
        
        // ========== EXPORT FONKSİYONLARI ==========
        function exportAppointmentsCSV() {
            const pkg = (salon?.package || 'free').toLowerCase();
            if (pkg === 'free') {
                showToast('CSV export Pro pakette kullanılabilir. Paket yükseltmek için Fiyatlandırma sayfasını ziyaret edin.', 'warning');
                return;
            }
            
            try {
                const thisMonth = new Date().toISOString().slice(0, 7);
                const data = (appointments || []).filter(a => a.date && a.date >= (new Date(Date.now() - 365 * 24 * 3600 * 1000)).toISOString().split('T')[0]);
                
                if (data.length === 0) { showToast('Dışa aktarılacak randevu yok', 'warning'); return; }
                
                // CSV Header
                const headers = ['Tarih', 'Saat', 'Müşteri', 'Telefon', 'Hizmet', 'Personel', 'Durum', 'Fiyat'];
                const statusMap = { pending: 'Bekliyor', confirmed: 'Onaylı', completed: 'Tamamlandı', cancelled: 'İptal' };
                
                const rows = data.map(a => [
                    a.date || '',
                    a.time || '',
                    (a.customerName || '').replace(/,/g, ' '),
                    (a.customerPhone || '').replace(/,/g, ' '),
                    (a.serviceName || '').replace(/,/g, ' '),
                    (a.staffName || '').replace(/,/g, ' '),
                    statusMap[a.status] || a.status || '',
                    a.servicePrice || 0
                ]);
                
                // BOM + CSV
                const csvContent = '\uFEFF' + [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `zamanli_randevular_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                URL.revokeObjectURL(url);
                
                showToast('CSV dosyası indiriliyor...', 'success');
            } catch (e) {
                showToast('Export hatası: ' + e.message, 'error');
            }
        }
        
        function exportCustomersCSV() {
            const pkg = (salon?.package || 'free').toLowerCase();
            if (pkg === 'free') {
                showToast('CSV export Pro pakette kullanılabilir', 'warning');
                return;
            }
            
            try {
                const customers = allCustomers || [];
                if (customers.length === 0) { showToast('Dışa aktarılacak müşteri yok', 'warning'); return; }
                
                const headers = ['İsim', 'Telefon', 'Randevu Sayısı', 'Son Randevu'];
                const rows = customers.map(c => [
                    (c.name || 'İsimsiz').replace(/,/g, ' '),
                    c.phone || '',
                    c.appointmentCount || 0,
                    c.lastAppointment || ''
                ]);
                
                const csvContent = '\uFEFF' + [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `zamanli_musteriler_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                URL.revokeObjectURL(url);
                
                showToast('Müşteri CSV indiriliyor...', 'success');
            } catch (e) {
                showToast('Export hatası: ' + e.message, 'error');
            }
        }
        
        function exportReportPDF() {
            const pkg = (salon?.package || 'free').toLowerCase();
            if (pkg === 'free') {
                showToast('PDF export Business pakette kullanılabilir', 'warning');
                return;
            }
            if (pkg === 'pro') {
                showToast('PDF export Business pakette kullanılabilir. CSV export kullanabilirsiniz.', 'warning');
                return;
            }
            
            try {
                // HTML to print
                const reportsContainer = document.querySelector('.reports-container');
                if (!reportsContainer) { showToast('Rapor alanı bulunamadı', 'error'); return; }
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Zamanli - ${salon?.name || 'Salon'} Rapor</title>
                        <style>
                            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 2rem; color: #334155; }
                            h1 { font-size: 1.5rem; color: #1e293b; border-bottom: 2px solid #6366f1; padding-bottom: 0.5rem; }
                            .report-summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0; }
                            .report-card { padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
                            .report-card-value { font-size: 1.5rem; font-weight: 700; }
                            .report-card-label { font-size: 0.85rem; color: #64748b; }
                            table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
                            th, td { padding: 0.5rem; border: 1px solid #e2e8f0; text-align: left; font-size: 0.85rem; }
                            th { background: #f1f5f9; font-weight: 600; }
                            .no-print { display: none; }
                            @media print { .no-print { display: none; } }
                        </style>
                    </head>
                    <body>
                        <h1>📊 ${salon?.name || 'Salon'} - Rapor (${currentReportPeriod === 'week' ? 'Haftalık' : currentReportPeriod === 'month' ? 'Aylık' : 'Yıllık'})</h1>
                        <p style="color:#64748b;">Oluşturulma: ${new Date().toLocaleString('tr-TR')}</p>
                        ${reportsContainer.innerHTML}
                        <script>setTimeout(() => window.print(), 500);<\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                showToast('PDF hazırlanıyor...', 'success');
            } catch (e) {
                showToast('PDF export hatası: ' + e.message, 'error');
            }
        }
        
        // Export butonlarını paket bazlı etkinleştir/devre dışı bırak
        function updateExportButtons() {
            const pkg = (salon?.package || 'free').toLowerCase();
            const csvBtn = document.getElementById('btnExportCSV');
            const pdfBtn = document.getElementById('btnExportPDF');
            
            if (csvBtn) {
                if (pkg === 'free') {
                    csvBtn.style.opacity = '0.5';
                    csvBtn.title = 'Pro pakete geçerek CSV export kullanabilirsiniz';
                }
            }
            if (pdfBtn) {
                if (pkg !== 'business') {
                    pdfBtn.style.opacity = '0.5';
                    pdfBtn.title = 'Business pakete geçerek PDF export kullanabilirsiniz';
                }
            }
        }
        
        function changeReportPeriod(period) {
            currentReportPeriod = period;
            
            // Buton stillerini güncelle
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });
            
            loadReports();
        }
        
        function loadReports() {
            const now = new Date();
            let startDate;
            
            switch(currentReportPeriod) {
                case 'week':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'month':
                    startDate = new Date(now);
                    startDate.setMonth(now.getMonth() - 1);
                    break;
                case 'year':
                    startDate = new Date(now);
                    startDate.setFullYear(now.getFullYear() - 1);
                    break;
            }
            
            const startDateStr = startDate.toISOString().split('T')[0];
            let periodAppointments = appointments.filter(a => a.date >= startDateStr);
            
            // PERSONEL MODU: Sadece kendi randevularını filtrele
            if (isStaffMode && currentStaffId) {
                periodAppointments = periodAppointments.filter(a => 
                    a.staffId === currentStaffId || a.staffName === currentStaffName
                );
            }
            
            // Özet istatistikler
            const total = periodAppointments.length;
            const completed = periodAppointments.filter(a => a.status === 'completed').length;
            const confirmed = periodAppointments.filter(a => a.status === 'confirmed').length;
            const pending = periodAppointments.filter(a => a.status === 'pending').length;
            const cancelled = periodAppointments.filter(a => a.status === 'cancelled').length;
            
            // Gelir hesaplamaları (ödeme takibi ile)
            const totalServiceValue = periodAppointments
                .filter(a => a.status === 'completed' || a.status === 'confirmed')
                .reduce((sum, a) => sum + (a.servicePrice || 0), 0);
            
            const actualPaidAmount = periodAppointments
                .filter(a => a.paidAmount > 0)
                .reduce((sum, a) => sum + (a.paidAmount || 0), 0);
            
            const pendingPayment = totalServiceValue - actualPaidAmount;
            
            // Ortalama randevu değeri
            const avgValue = total > 0 ? Math.round(totalServiceValue / total) : 0;
            
            // İptal oranı
            const cancelRate = total > 0 ? Math.round((cancelled / total) * 100) : 0;
            
            // Tamamlanma oranı
            const completionRate = total > 0 ? Math.round(((completed + confirmed) / total) * 100) : 0;
            
            document.getElementById('reportTotalAppointments').textContent = total;
            document.getElementById('reportCompletedAppointments').textContent = completed + confirmed;
            document.getElementById('reportCancelledAppointments').textContent = cancelled;
            // Operatör: finansal verileri gizle
            if (currentStaffRole === STAFF_ROLES.OPERATOR) {
                document.getElementById('reportTotalRevenue').textContent = '—';
                renderDetailedStats({
                    total, completed, confirmed, pending, cancelled,
                    totalServiceValue: 0, actualPaidAmount: 0, pendingPayment: 0,
                    avgValue: 0, cancelRate, completionRate,
                    hideFinancial: true
                });
            } else {
                document.getElementById('reportTotalRevenue').textContent = actualPaidAmount.toLocaleString('tr-TR') + ' ₺';
                renderDetailedStats({
                    total, completed, confirmed, pending, cancelled,
                    totalServiceValue, actualPaidAmount, pendingPayment,
                    avgValue, cancelRate, completionRate
                });
            }
            
            // Chart.js Finans Dashboard'u güncelle (operatör için gizle)
            if (typeof FinanceDashboard !== 'undefined' && currentStaffRole !== STAFF_ROLES.OPERATOR) {
                FinanceDashboard.currentPeriod = currentReportPeriod;
                FinanceDashboard.appointments = appointments;
                FinanceDashboard.render();
            }
            
            // Personel performansı
            renderStaffPerformance(periodAppointments);
            
            // Popüler hizmetler
            renderPopularServices(periodAppointments);
            
            // Günlük dağılım
            renderDailyDistribution(periodAppointments);
            
            // Saatlik dağılım
            renderHourlyDistribution(periodAppointments);
        }
        
        // Detaylı istatistikler render
        function renderDetailedStats(stats) {
            const container = document.getElementById('detailedStatsContainer');
            if (!container) return;
            
            container.innerHTML = `
                <div class="detailed-stats-grid">
                    <div class="detail-stat-card priority-high">
                        <div class="detail-stat-icon">💰</div>
                        <div class="detail-stat-content">
                            <div class="detail-stat-value">${stats.actualPaidAmount.toLocaleString('tr-TR')} ₺</div>
                            <div class="detail-stat-label">Tahsil Edilen</div>
                        </div>
                    </div>
                    <div class="detail-stat-card ${stats.pendingPayment > 0 ? 'priority-warning' : ''}">
                        <div class="detail-stat-icon">⏳</div>
                        <div class="detail-stat-content">
                            <div class="detail-stat-value">${stats.pendingPayment.toLocaleString('tr-TR')} ₺</div>
                            <div class="detail-stat-label">Bekleyen Ödeme</div>
                        </div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-icon">📊</div>
                        <div class="detail-stat-content">
                            <div class="detail-stat-value">${stats.avgValue} ₺</div>
                            <div class="detail-stat-label">Ortalama Değer</div>
                        </div>
                    </div>
                    <div class="detail-stat-card ${stats.completionRate >= 80 ? 'priority-success' : ''}">
                        <div class="detail-stat-icon">✅</div>
                        <div class="detail-stat-content">
                            <div class="detail-stat-value">%${stats.completionRate}</div>
                            <div class="detail-stat-label">Tamamlanma Oranı</div>
                        </div>
                    </div>
                    <div class="detail-stat-card ${stats.cancelRate > 20 ? 'priority-danger' : ''}">
                        <div class="detail-stat-icon">❌</div>
                        <div class="detail-stat-content">
                            <div class="detail-stat-value">%${stats.cancelRate}</div>
                            <div class="detail-stat-label">İptal Oranı</div>
                        </div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-icon">⏰</div>
                        <div class="detail-stat-content">
                            <div class="detail-stat-value">${stats.pending}</div>
                            <div class="detail-stat-label">Onay Bekleyen</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Saatlik dağılım
        function renderHourlyDistribution(periodAppointments) {
            const container = document.getElementById('hourlyDistribution');
            if (!container) return;
            
            const hourCounts = {};
            for (let h = 9; h <= 20; h++) {
                hourCounts[h] = 0;
            }
            
            periodAppointments.forEach(apt => {
                if (apt.time) {
                    const hour = parseInt(apt.time.split(':')[0]);
                    if (hourCounts[hour] !== undefined) {
                        hourCounts[hour]++;
                    }
                }
            });
            
            const maxCount = Math.max(...Object.values(hourCounts), 1);
            const peakHour = Object.entries(hourCounts).sort((a, b) => b[1] - a[1])[0];
            
            const html = `
                <div class="hourly-header">
                    <span>En yoğun saat: <strong>${peakHour[0]}:00</strong> (${peakHour[1]} randevu)</span>
                </div>
                <div class="hourly-bars">
                    ${Object.entries(hourCounts).map(([hour, count]) => {
                        const height = (count / maxCount) * 100;
                        const isPeak = hour === peakHour[0];
                        return `
                            <div class="hourly-bar ${isPeak ? 'peak' : ''}">
                                <div class="hourly-bar-count">${count}</div>
                                <div class="hourly-bar-fill" style="height: ${height}%"></div>
                                <div class="hourly-bar-label">${hour}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function renderStaffPerformance(periodAppointments) {
            const staffStats = {};
            const staff = salon?.staff || [];
            
            // Her personel için istatistik hesapla
            periodAppointments.forEach(apt => {
                const staffName = apt.staffName || 'Belirtilmemiş';
                if (!staffStats[staffName]) {
                    staffStats[staffName] = { count: 0, revenue: 0 };
                }
                staffStats[staffName].count++;
                if (apt.status === 'completed' || apt.status === 'confirmed') {
                    staffStats[staffName].revenue += (apt.servicePrice || 0);
                }
            });
            
            const container = document.getElementById('staffPerformanceList');
            
            if (Object.keys(staffStats).length === 0) {
                container.innerHTML = '<p style="color: var(--slate-500); text-align: center; padding: 1rem;">Bu dönemde randevu bulunmuyor</p>';
                return;
            }
            
            const html = Object.entries(staffStats)
                .sort((a, b) => b[1].count - a[1].count)
                .map(([name, stats]) => `
                    <div class="staff-performance-item">
                        <div class="staff-performance-info">
                            <div class="staff-performance-avatar">${name.charAt(0)}</div>
                            <span style="font-weight: 500;">${escapeHtml(name)}</span>
                        </div>
                        <div class="staff-performance-stats">
                            <span>📅 <strong>${stats.count}</strong> randevu</span>
                            <span>💰 <strong>${stats.revenue.toLocaleString('tr-TR')} ₺</strong></span>
                        </div>
                    </div>
                `).join('');
            
            container.innerHTML = html;
        }
        
        function renderPopularServices(periodAppointments) {
            const serviceStats = {};
            
            periodAppointments.forEach(apt => {
                const serviceName = apt.serviceName || 'Belirtilmemiş';
                if (!serviceStats[serviceName]) {
                    serviceStats[serviceName] = 0;
                }
                serviceStats[serviceName]++;
            });
            
            const container = document.getElementById('popularServicesList');
            
            if (Object.keys(serviceStats).length === 0) {
                container.innerHTML = '<p style="color: var(--slate-500); text-align: center; padding: 1rem;">Bu dönemde randevu bulunmuyor</p>';
                return;
            }
            
            const maxCount = Math.max(...Object.values(serviceStats));
            
            const html = Object.entries(serviceStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([name, count]) => {
                    const percentage = (count / maxCount) * 100;
                    return `
                        <div class="popular-service-item">
                            <span style="font-weight: 500; min-width: 120px;">${escapeHtml(name)}</span>
                            <div class="popular-service-bar">
                                <div class="popular-service-fill" style="width: ${percentage}%"></div>
                            </div>
                            <span style="font-weight: 600; color: var(--slate-700);">${count}</span>
                        </div>
                    `;
                }).join('');
            
            container.innerHTML = html;
        }
        
        function renderDailyDistribution(periodAppointments) {
            const dayNames = ['Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt', 'Paz'];
            const dayCounts = [0, 0, 0, 0, 0, 0, 0];
            
            periodAppointments.forEach(apt => {
                if (apt.date) {
                    const date = new Date(apt.date);
                    const dayIndex = date.getDay();
                    // JavaScript'te Pazar=0, bizde Pazartesi=0 olmalı
                    const adjustedIndex = dayIndex === 0 ? 6 : dayIndex - 1;
                    dayCounts[adjustedIndex]++;
                }
            });
            
            const maxCount = Math.max(...dayCounts, 1);
            
            const container = document.getElementById('dailyDistribution');
            const html = dayNames.map((day, index) => {
                const count = dayCounts[index];
                const height = (count / maxCount) * 100;
                return `
                    <div class="daily-bar">
                        <div class="daily-bar-count">${count}</div>
                        <div class="daily-bar-fill">
                            <div class="daily-bar-value" style="height: ${height}%"></div>
                        </div>
                        <div class="daily-bar-label">${day}</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        // ========== MANUEL RANDEVU EKLEME ==========
        
        let selectedCustomerForAppointment = null;
        let customerMode = 'existing'; // 'existing' veya 'new'
        
        async function openManualAppointmentModal(prefillDate, prefillTime) {
            const modal = document.getElementById('manualAppointmentModal');
            
            // Müşterileri yükle (her zaman taze veri çek)
            showToast('Müşteriler yükleniyor...', 'info');
            await loadCustomers();
            
            // Tarihi ayarla: parametreden gelen veya bugün
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('manualAppointmentDate');
            dateInput.value = prefillDate || today;
            dateInput.min = today;
            
            // Saatleri doldur
            populateTimeSlots();
            
            // Eğer prefillTime varsa, saati ayarla
            if (prefillTime) {
                const timeSelect = document.getElementById('manualAppointmentTime');
                if (timeSelect) {
                    let matched = false;
                    for (let option of timeSelect.options) {
                        if (option.value === prefillTime) {
                            option.selected = true;
                            matched = true;
                            break;
                        }
                    }
                    // Tam eşleşme yoksa saat kısmıyla dene
                    if (!matched) {
                        const hour = prefillTime.split(':')[0];
                        for (let option of timeSelect.options) {
                            if (option.value.startsWith(hour + ':')) {
                                option.selected = true;
                                break;
                            }
                        }
                    }
                }
            }
            
            // Hizmetleri doldur
            populateServices();
            
            // Personelleri doldur
            populateStaffForManual();
            
            // Formu temizle
            document.getElementById('manualCustomerName').value = '';
            document.getElementById('manualCustomerPhone').value = '';
            document.getElementById('manualAppointmentNote').value = '';
            document.getElementById('manualServicePrice').textContent = '';
            document.getElementById('customerSearchInput').value = '';
            document.getElementById('customerSearchResults').style.display = 'none';
            
            // Müşteri seçimini sıfırla
            selectedCustomerForAppointment = null;
            document.getElementById('selectedCustomerInfo').style.display = 'none';
            
            // Varsayılan olarak kayıtlı müşteri modu
            toggleCustomerMode('existing');
            
            modal.classList.add('active');
            console.log('[Manual] Modal açıldı, tarih:', prefillDate || today, 'saat:', prefillTime || 'varsayılan');
        }
        
        function toggleCustomerMode(mode) {
            customerMode = mode;
            const existingSection = document.getElementById('existingCustomerSection');
            const newSection = document.getElementById('newCustomerSection');
            const btnExisting = document.getElementById('btnExistingCustomer');
            const btnNew = document.getElementById('btnNewCustomer');
            
            if (mode === 'existing') {
                existingSection.style.display = 'block';
                newSection.style.display = 'none';
                btnExisting.className = 'btn btn-primary btn-sm';
                btnNew.className = 'btn btn-outline btn-sm';
            } else {
                existingSection.style.display = 'none';
                newSection.style.display = 'block';
                btnExisting.className = 'btn btn-outline btn-sm';
                btnNew.className = 'btn btn-primary btn-sm';
                // Seçili müşteriyi temizle
                selectedCustomerForAppointment = null;
            }
        }
        
        function searchSavedCustomers() {
            const query = document.getElementById('customerSearchInput').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('customerSearchResults');
            
            if (query.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            // Kayıtlı müşterilerden ara (allCustomers veya randevulardan)
            const customers = getAllSavedCustomers();
            console.log('[Search] Toplam müşteri:', customers.length, 'Aranan:', query);
            
            // Önce isim başlangıcına göre, sonra içerenlere göre sırala
            const searchPhone = query.replace(/\D/g, '');
            
            const filtered = customers.filter(c => {
                const name = (c.name || '').toLowerCase();
                const phone = (c.phone || '').replace(/\D/g, '');
                return name.includes(query) || (searchPhone.length >= 3 && phone.includes(searchPhone));
            }).sort((a, b) => {
                const nameA = (a.name || '').toLowerCase();
                const nameB = (b.name || '').toLowerCase();
                
                // İsim query ile başlıyorsa öncelikli
                const startsWithA = nameA.startsWith(query) ? 0 : 1;
                const startsWithB = nameB.startsWith(query) ? 0 : 1;
                
                if (startsWithA !== startsWithB) return startsWithA - startsWithB;
                
                // Randevu sayısına göre sırala
                return (b.appointmentCount || 0) - (a.appointmentCount || 0);
            }).slice(0, 10);
            
            console.log('[Search] Bulunan:', filtered.length);
            
            if (filtered.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 0.75rem; color: var(--slate-500); text-align: center; font-size: 0.85rem;">Sonuç bulunamadı</div>';
            } else {
                resultsContainer.innerHTML = filtered.map(c => `
                    <div onclick="selectCustomerForAppointment('${escapeHtml(c.name || 'İsimsiz')}', '${c.phone}')" 
                         style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid var(--slate-100); display: flex; align-items: center; gap: 0.75rem; transition: background 0.2s;"
                         onmouseover="this.style.background='var(--slate-50)'" 
                         onmouseout="this.style.background='white'">
                        <div style="width: 36px; height: 36px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem;">
                            ${(c.name || 'İ').charAt(0).toUpperCase()}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 0.9rem; color: var(--slate-800);">${escapeHtml(c.name || 'İsimsiz')}</div>
                            <div style="font-size: 0.8rem; color: var(--slate-500);">📱 0${c.phone}</div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--slate-400);">${c.appointmentCount || 0} randevu</div>
                    </div>
                `).join('');
            }
            
            resultsContainer.style.display = 'block';
        }
        
        function selectCustomerForAppointment(name, phone) {
            selectedCustomerForAppointment = { name, phone };
            
            document.getElementById('selectedCustomerName').textContent = name;
            document.getElementById('selectedCustomerPhone').textContent = '📱 0' + phone;
            document.getElementById('selectedCustomerInfo').style.display = 'block';
            document.getElementById('customerSearchResults').style.display = 'none';
            document.getElementById('customerSearchInput').value = '';
        }
        
        function clearSelectedCustomer() {
            selectedCustomerForAppointment = null;
            document.getElementById('selectedCustomerInfo').style.display = 'none';
            document.getElementById('customerSearchInput').value = '';
        }
        
        function getAllSavedCustomers() {
            // Her iki kaynaktan müşterileri birleştir
            const customerMap = new Map();
            
            // 1. allCustomers'dan ekle (manuel eklenen + randevulardan toplanan)
            if (allCustomers && allCustomers.length > 0) {
                allCustomers.forEach(c => {
                    const phone = (c.phone || '').replace(/\D/g, '').slice(-10);
                    if (phone && phone.length === 10) {
                        customerMap.set(phone, {
                            name: c.name || 'İsimsiz',
                            phone: phone,
                            appointmentCount: c.appointments?.length || c.appointmentCount || 0
                        });
                    }
                });
            }
            
            // 2. Randevulardan da ekle (allCustomers boş olsa bile)
            appointments.forEach(apt => {
                if (apt.customerPhone && apt.customerName) {
                    const phone = apt.customerPhone.replace(/\D/g, '').slice(-10);
                    if (phone && phone.length === 10) {
                        if (!customerMap.has(phone)) {
                            customerMap.set(phone, {
                                name: apt.customerName,
                                phone: phone,
                                appointmentCount: 1
                            });
                        } else {
                            // Randevu sayısını artır
                            const existing = customerMap.get(phone);
                            existing.appointmentCount = (existing.appointmentCount || 0) + 1;
                        }
                    }
                }
            });
            
            // En çok randevusu olanları öne al
            return Array.from(customerMap.values()).sort((a, b) => (b.appointmentCount || 0) - (a.appointmentCount || 0));
        }
        
        function closeManualAppointmentModal() {
            document.getElementById('manualAppointmentModal').classList.remove('active');
        }
        
        function populateTimeSlots() {
            const select = document.getElementById('manualAppointmentTime');
            const hours = salon?.workingHours || {};
            
            // Varsayılan saatler
            let startHour = 9;
            let endHour = 20;
            
            // Çalışma saatlerinden al
            const todayKey = DAY_KEYS[new Date().getDay()];
            const todayHours = hours[todayKey];
            if (todayHours && !todayHours.closed) {
                startHour = parseInt(todayHours.open?.split(':')[0]) || 9;
                endHour = parseInt(todayHours.close?.split(':')[0]) || 20;
            }
            
            select.innerHTML = '<option value="">Saat Seçin</option>';
            
            for (let h = startHour; h < endHour; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    select.innerHTML += `<option value="${timeStr}">${timeStr}</option>`;
                }
            }
        }
        
        function populateServices() {
            const select = document.getElementById('manualServiceSelect');
            const services = salon?.services || [];
            
            select.innerHTML = '<option value="">Hizmet Seçin</option>';
            
            services.forEach((service, index) => {
                const name = typeof service === 'string' ? service : service.name;
                const price = typeof service === 'object' ? service.price : 0;
                const duration = typeof service === 'object' ? service.duration : 30;
                
                select.innerHTML += `<option value="${index}" data-price="${price}" data-duration="${duration}" data-name="${name}">${name} - ${price}₺</option>`;
            });
        }
        
        function populateStaffForManual() {
            const select = document.getElementById('manualStaffSelect');
            const staff = salon?.staff || [];
            
            // PERSONEL MODU: Sadece kendisini seçebilsin
            if (isStaffMode && currentStaffId) {
                select.innerHTML = '';
                const currentStaff = staff.find(s => s.id === currentStaffId || s.name === currentStaffName);
                if (currentStaff) {
                    select.innerHTML = `<option value="${currentStaff.id || currentStaff.name}" data-name="${currentStaff.name}" selected>${currentStaff.name}</option>`;
                }
                select.disabled = true;
                select.style.opacity = '0.7';
                return;
            }
            
            select.innerHTML = '<option value="">Personel Seçin (Opsiyonel)</option>';
            select.disabled = false;
            select.style.opacity = '1';
            
            staff.forEach(s => {
                if (s.active !== false) {
                    select.innerHTML += `<option value="${s.id || s.name}" data-name="${s.name}">${s.name}</option>`;
                }
            });
        }
        
        function updateManualServicePrice() {
            const select = document.getElementById('manualServiceSelect');
            const option = select.selectedOptions[0];
            const priceDiv = document.getElementById('manualServicePrice');
            
            if (option && option.dataset.price) {
                priceDiv.textContent = `💰 ${option.dataset.price}₺ • ⏱️ ${option.dataset.duration || 30} dk`;
            } else {
                priceDiv.textContent = '';
            }
        }
        
        async function submitManualAppointment(event) {
            event.preventDefault();
            
            // Müşteri bilgilerini al - seçilen veya yeni girilen
            let customerName, customerPhone;
            
            if (customerMode === 'existing' && selectedCustomerForAppointment) {
                customerName = selectedCustomerForAppointment.name;
                customerPhone = selectedCustomerForAppointment.phone;
            } else {
                customerName = document.getElementById('manualCustomerName').value.trim();
                customerPhone = document.getElementById('manualCustomerPhone').value.replace(/\D/g, '');
            }
            
            const date = document.getElementById('manualAppointmentDate').value;
            const time = document.getElementById('manualAppointmentTime').value;
            const serviceSelect = document.getElementById('manualServiceSelect');
            const staffSelect = document.getElementById('manualStaffSelect');
            const note = document.getElementById('manualAppointmentNote').value.trim();
            const status = document.querySelector('input[name="manualStatus"]:checked').value;
            
            if (!customerName || !customerPhone || !date || !time || !serviceSelect.value) {
                showToast('Lütfen tüm zorunlu alanları doldurun', 'error');
                return;
            }
            
            const serviceOption = serviceSelect.selectedOptions[0];
            const serviceName = serviceOption.dataset.name;
            const servicePrice = parseInt(serviceOption.dataset.price) || 0;
            const serviceDuration = parseInt(serviceOption.dataset.duration) || 30;
            
            const staffOption = staffSelect.selectedOptions[0];
            const staffId = staffSelect.value || null;
            const staffName = staffOption?.dataset?.name || null;
            
            try {
                const appointmentData = {
                    salonId: salon.id,
                    salonSlug: salon.slug,
                    customerName: customerName,
                    customerPhone: customerPhone,
                    date: date,
                    time: time,
                    service: serviceName,
                    serviceName: serviceName,
                    servicePrice: servicePrice,
                    serviceDuration: serviceDuration,
                    staffId: staffId,
                    staffName: staffName,
                    status: status,
                    note: note,
                    source: 'manual', // Manuel eklendi işareti
                    createdAt: new Date().toISOString(),
                    createdBy: isStaffMode ? currentStaffName : 'salon_owner'
                };
                
                const docRef = await db.collection('appointments').add(appointmentData);
                
                // Lokal listeye ekle
                appointments.push({
                    id: docRef.id,
                    ...appointmentData
                });
                
                // MÜŞTERİYİ OTOMATİK OLARAK CUSTOMERS KOLEKSIYONUNA EKLE
                await autoSaveCustomer(customerName, customerPhone);
                
                // Görünümleri güncelle
                renderWeeklyCalendar();
                renderWeeklyCalendarNew();
                renderAppointments();
                renderPendingRequests();
                renderTodayAppointments();
                updateStats();
                
                closeManualAppointmentModal();
                showToast('Randevu başarıyla oluşturuldu ✅', 'success');
                
                // WhatsApp bildirimi sor
                if (status === 'confirmed') {
                    setTimeout(() => {
                        if (confirm('Müşteriye WhatsApp ile onay mesajı göndermek ister misiniz?')) {
                            const salonLink = `https://zamanli.com/berber/salon/?slug=${salon.slug}`;
                            const msg = `Merhaba ${customerName},

RANDEVUNUZ ONAYLANDI

${salon.name}
Tarih: ${formatDateTR(date)}
Saat: ${time}
Hizmet: ${serviceName}
${staffName ? `Personel: ${staffName}` : ''}
${servicePrice ? `Ucret: ${servicePrice} TL` : ''}

Adres: ${salon.address || 'Salonumuzda'}
${salon.phone ? `Tel: ${salon.phone}` : ''}

Online Randevu: ${salonLink}

Sizi bekliyoruz!

${salon.name}`;
                            openWhatsAppWithMessage(customerPhone, msg);
                        }
                    }, 500);
                }
                
            } catch (error) {
                console.error('Manuel randevu ekleme hatası:', error);
                showToast('Randevu eklenirken hata oluştu', 'error');
            }
        }
        
        // ========== MÜŞTERİ YÖNETİMİ ==========
        
        function openAddCustomerModal() {
            document.getElementById('newCustomerName').value = '';
            document.getElementById('newCustomerPhone').value = '';
            document.getElementById('newCustomerEmail').value = '';
            document.getElementById('newCustomerNote').value = '';
            document.getElementById('addCustomerModal').classList.add('active');
        }
        
        function closeAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.remove('active');
        }
        
        async function saveNewCustomer(event) {
            if (event) event.preventDefault();
            
            const name = document.getElementById('newCustomerName').value.trim();
            const phone = document.getElementById('newCustomerPhone').value.replace(/\D/g, '').slice(-10);
            const email = document.getElementById('newCustomerEmail').value.trim();
            const note = document.getElementById('newCustomerNote').value.trim();
            
            if (!name || !phone || phone.length !== 10) {
                showToast('Ad ve geçerli telefon numarası (10 hane) gerekli', 'error');
                return;
            }
            
            // Duplicate kontrolü
            const existingCustomer = allCustomers.find(c => c.phone === phone);
            if (existingCustomer) {
                showToast('Bu telefon zaten kayıtlı: ' + existingCustomer.name, 'warning');
                return;
            }
            
            try {
                // Müşteriyi Firestore'a kaydet
                const customerData = {
                    name: name,
                    phone: phone,
                    email: email || null,
                    note: note || null,
                    salonId: salon.id,
                    createdAt: new Date().toISOString(),
                    createdBy: isStaffMode ? currentStaffName : 'salon_owner'
                };
                
                await db.collection('salons').doc(salon.id).collection('customers').doc(phone).set(customerData, { merge: true });
                
                // Lokal listeye ekle
                allCustomers.push({
                    name: name,
                    phone: phone,
                    email: email,
                    note: note,
                    appointments: [],
                    totalSpent: 0
                });
                
                closeAddCustomerModal();
                renderCustomers();
                showToast('Müşteri başarıyla eklendi ✅', 'success');
                
            } catch (error) {
                console.error('Müşteri ekleme hatası:', error);
                showToast('Müşteri eklenirken hata oluştu', 'error');
            }
        }
        
        // Randevu oluşturulduğunda müşteriyi otomatik kaydet
        async function autoSaveCustomer(name, phone) {
            try {
                const cleanPhone = phone.replace(/\D/g, '').slice(-10);
                if (!cleanPhone || cleanPhone.length !== 10) return;
                
                // Müşteri zaten var mı kontrol et
                const existingDoc = await db.collection('salons').doc(salon.id).collection('customers').doc(cleanPhone).get();
                
                const now = new Date().toISOString();
                
                if (existingDoc.exists) {
                    // Varsa sadece son randevu tarihini güncelle
                    await db.collection('salons').doc(salon.id).collection('customers').doc(cleanPhone).update({
                        lastAppointmentAt: now,
                        updatedAt: now
                    });
                    console.log('[AutoSave] Müşteri güncellendi:', cleanPhone);
                } else {
                    // Yoksa yeni kayıt oluştur
                    await db.collection('salons').doc(salon.id).collection('customers').doc(cleanPhone).set({
                        name: name,
                        phone: cleanPhone,
                        salonId: salon.id,
                        createdAt: now,
                        lastAppointmentAt: now,
                        source: 'appointment'
                    });
                    console.log('[AutoSave] Yeni müşteri kaydedildi:', cleanPhone);
                }
            } catch (e) {
                console.log('[AutoSave] Müşteri kaydetme hatası:', e.message);
            }
        }
        
        // ========== PERSONEL FOTO VE ROL ==========
        
        let staffPhotoBase64 = null;
        
        // Resim sıkıştırma fonksiyonu
        function compressImage(file, maxWidth = 800, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Boyut hesaplama
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Sıkıştırılmış base64 döndür
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        async function previewStaffPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 10MB limit (sıkıştırma yapacağız)
            if (file.size > 10 * 1024 * 1024) {
                showToast('Fotoğraf maksimum 10MB olmalı', 'error');
                return;
            }
            
            try {
                showToast('Fotoğraf işleniyor...', 'info');
                // Resmi sıkıştır
                staffPhotoBase64 = await compressImage(file, 800, 0.8);
                document.getElementById('staffPhotoPreview').innerHTML = `<img src="${staffPhotoBase64}" style="width: 100%; height: 100%; object-fit: cover;">`;
                showToast('Fotoğraf yüklendi', 'success');
            } catch (err) {
                console.error('Photo compression error:', err);
                showToast('Fotoğraf işlenirken hata oluştu', 'error');
            }
        }
        
        function toggleStaffRoleOptions() {
            const role = document.getElementById('staffRole').value;
            const hint = document.getElementById('staffRoleHint');
            const staffHoursSection = document.getElementById('staffHoursSection');
            
            if (role === 'operator') {
                hint.textContent = 'Operatör: Tüm randevuları görebilir ve düzenleyebilir, manuel randevu ekleyebilir, ancak onay/iptal yetkisi yoktur';
                // Operatör için çalışma saatleri gerekmez
                if (staffHoursSection) staffHoursSection.style.display = 'none';
            } else if (role === 'assistant') {
                hint.textContent = 'Asistan: Tüm randevuları sadece görüntüleyebilir, düzenleme yetkisi yoktur';
                if (staffHoursSection) staffHoursSection.style.display = 'none';
            } else {
                hint.textContent = 'Personel: Kendi randevularını tam yetki ile yönetebilir, müşteriler tarafından randevu alınabilir';
                if (staffHoursSection) staffHoursSection.style.display = 'block';
            }
        }
        
        function populateStaffWorkingHours(staffHours = null) {
            const container = document.getElementById('staffWorkingHours');
            const dayLabels = { mon: 'Pzt', tue: 'Sal', wed: 'Çar', thu: 'Per', fri: 'Cum', sat: 'Cmt', sun: 'Paz' };
            const salonHours = salon?.workingHours || {};
            
            container.innerHTML = Object.entries(dayLabels).map(([key, label]) => {
                const dayHours = staffHours?.[key] || salonHours[key] || { open: '09:00', close: '20:00', active: true };
                const isActive = staffHours?.[key]?.active ?? dayHours.active;
                
                return `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem 0;">
                        <input type="checkbox" id="staffHours-${key}-active" ${isActive ? 'checked' : ''} style="width: 16px; height: 16px;">
                        <span style="width: 35px; font-weight: 600;">${label}</span>
                        <input type="time" id="staffHours-${key}-open" value="${dayHours.open}" style="padding: 0.25rem; border: 1px solid var(--slate-200); border-radius: 4px; font-size: 0.8rem;">
                        <span>-</span>
                        <input type="time" id="staffHours-${key}-close" value="${dayHours.close}" style="padding: 0.25rem; border: 1px solid var(--slate-200); border-radius: 4px; font-size: 0.8rem;">
                    </div>
                `;
            }).join('');
        }
        
        function getStaffWorkingHoursFromForm() {
            const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const hours = {};
            
            dayKeys.forEach(key => {
                const activeEl = document.getElementById(`staffHours-${key}-active`);
                const openEl = document.getElementById(`staffHours-${key}-open`);
                const closeEl = document.getElementById(`staffHours-${key}-close`);
                
                if (activeEl && openEl && closeEl) {
                    hours[key] = {
                        active: activeEl.checked,
                        open: openEl.value,
                        close: closeEl.value
                    };
                }
            });
            
            return hours;
        }
        
        // ========== PERSONEL KAPALI GÜN/SAAT ==========
        
        function openStaffBlockModal(staffId) {
            document.getElementById('blockStaffId').value = staffId;
            document.getElementById('blockDate').value = '';
            document.getElementById('blockDate').min = new Date().toISOString().split('T')[0];
            document.getElementById('blockType').value = 'full_day';
            document.getElementById('blockReason').value = '';
            document.getElementById('blockTimeInputs').style.display = 'none';
            document.getElementById('staffBlockModal').classList.add('active');
        }
        
        function closeStaffBlockModal() {
            document.getElementById('staffBlockModal').classList.remove('active');
        }
        
        function toggleBlockTimeInputs() {
            const type = document.getElementById('blockType').value;
            document.getElementById('blockTimeInputs').style.display = type === 'time_range' ? 'block' : 'none';
        }
        
        async function saveStaffBlock(event) {
            event.preventDefault();
            
            const staffId = document.getElementById('blockStaffId').value;
            const date = document.getElementById('blockDate').value;
            const type = document.getElementById('blockType').value;
            const reason = document.getElementById('blockReason').value.trim();
            
            if (!date) {
                showToast('Tarih seçin', 'error');
                return;
            }
            
            const blockData = {
                staffId: staffId,
                date: date,
                type: type,
                reason: reason || null,
                createdAt: new Date().toISOString()
            };
            
            if (type === 'time_range') {
                blockData.startTime = document.getElementById('blockStartTime').value;
                blockData.endTime = document.getElementById('blockEndTime').value;
                
                if (!blockData.startTime || !blockData.endTime) {
                    showToast('Başlangıç ve bitiş saati girin', 'error');
                    return;
                }
            }
            
            try {
                await db.collection('salons').doc(salon.id).collection('staffBlocks').add(blockData);
                closeStaffBlockModal();
                showToast('İzin/Kapalı gün eklendi ✅', 'success');
            } catch (error) {
                console.error('Block ekleme hatası:', error);
                showToast('Hata oluştu', 'error');
            }
        }
        
        // ========== WHATSAPP PERSONEL YÖNLENDIRME ==========
        
        function getStaffPhoneForWhatsApp(staffId, staffName) {
            const staff = salon?.staff || [];
            const targetStaff = staff.find(s => s.id === staffId || s.name === staffName);
            return targetStaff?.phone || salon.phone; // Personel telefonu yoksa salon telefonu
        }
        
        // Session debug fonksiyonu - konsola session bilgilerini yazar
        function debugSession() {
            console.log('=== SESSION DEBUG ===');
            console.log('localStorage keys:', Object.keys(localStorage));
            
            const salonSession = localStorage.getItem('salonSession');
            const staffSession = localStorage.getItem('staffSession');
            const adminSession = localStorage.getItem('zamanli_admin');
            
            console.log('salonSession:', salonSession ? JSON.parse(salonSession) : 'YOK');
            console.log('staffSession:', staffSession ? JSON.parse(staffSession) : 'YOK');
            console.log('adminSession:', adminSession ? JSON.parse(adminSession) : 'YOK');
            console.log('====================');
        }
        
        // Sayfa yüklenirken debug
        debugSession();
        
        // Start
        init();
    </script>
    
    <!-- PWA Install Banner - Geliştirilmiş -->
    <style>
        .pwa-banner {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 1.25rem;
            z-index: 10000;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            border-radius: 16px;
            max-width: 360px;
            width: calc(100% - 2rem);
        }
        .pwa-banner.show { 
            display: block; 
            animation: slideUpBanner 0.4s ease; 
        }
        @keyframes slideUpBanner { 
            from { transform: translateX(-50%) translateY(100px); opacity: 0; } 
            to { transform: translateX(-50%) translateY(0); opacity: 1; } 
        }
        .pwa-banner-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .pwa-banner-icon { 
            width: 52px;
            height: 52px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            flex-shrink: 0;
        }
        .pwa-banner-text h4 { 
            font-size: 1.1rem; 
            font-weight: 700; 
            color: white;
            margin-bottom: 0.25rem;
        }
        .pwa-banner-text p { 
            font-size: 0.85rem; 
            color: rgba(255,255,255,0.9);
            line-height: 1.4;
        }
        .pwa-banner-actions { 
            display: flex; 
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .pwa-btn { 
            padding: 0.75rem 1rem; 
            border-radius: 10px; 
            font-weight: 600; 
            font-size: 0.9rem; 
            cursor: pointer; 
            border: none;
            flex: 1;
            transition: all 0.2s;
        }
        .pwa-btn-install { 
            background: white; 
            color: #059669; 
        }
        .pwa-btn-install:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .pwa-btn-close { 
            background: rgba(255,255,255,0.2); 
            color: white; 
        }
        .pwa-banner-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }
    </style>
    <div id="pwaBanner" class="pwa-banner">
        <button class="pwa-banner-close" onclick="closePWABanner()">&times;</button>
        <div class="pwa-banner-header">
            <div class="pwa-banner-icon">📲</div>
            <div class="pwa-banner-text">
                <h4 id="pwaBannerTitle">Uygulamayı Yükle</h4>
                <p id="pwaBannerDesc">Ana ekrana ekle, hızlı erişim sağla</p>
            </div>
        </div>
        <div class="pwa-banner-actions">
            <button class="pwa-btn pwa-btn-close" onclick="closePWABanner()">Şimdi Değil</button>
            <button class="pwa-btn pwa-btn-install" id="pwaBannerInstallBtn" onclick="installPWA()">📲 Yükle</button>
        </div>
    </div>
    <script>
        // Platform bazlı PWA banner içeriği
        (function() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isAndroid = /Android/.test(navigator.userAgent);
            const btn = document.getElementById('pwaBannerInstallBtn');
            const title = document.getElementById('pwaBannerTitle');
            const desc = document.getElementById('pwaBannerDesc');
            
            if (isIOS) {
                if (btn) btn.textContent = '📲 Nasıl Yapılır?';
                if (title) title.textContent = "iPhone'a Yükle";
                if (desc) desc.textContent = 'Ana ekrana ekleyerek hızlı erişim sağla';
            } else if (isAndroid) {
                if (btn) btn.textContent = '📲 Uygulamayı İndir';
                if (title) title.textContent = 'Android Uygulaması';
                if (desc) desc.textContent = 'Ana ekrana ekle, bildirim al, hızlı eriş';
            }
        })();
    </script>
    
    <!-- Push Notification Banner -->
    <div id="pushBanner" class="push-banner" style="display: none;">
        <div class="push-banner-content">
            <span class="push-banner-icon">🔔</span>
            <div class="push-banner-text">
                <strong>Bildirimleri Aç</strong>
                <span>Yeni randevu geldiğinde anında haber al</span>
            </div>
        </div>
        <div class="push-banner-actions">
            <button class="push-btn push-btn-enable" onclick="enablePushNotifications()">Bildirimleri Aç</button>
            <button class="push-btn push-btn-close" onclick="closePushBanner()">Sonra</button>
        </div>
    </div>
    
    <style>
        /* Push Notification Banner */
        .push-banner {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            max-width: 400px;
            margin: 0 auto;
            background: linear-gradient(135deg, #10B981, #059669);
            border-radius: 16px;
            padding: 1rem 1.25rem;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
            z-index: 9999;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .push-banner-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .push-banner-icon {
            font-size: 1.75rem;
        }
        
        .push-banner-text {
            color: white;
        }
        
        .push-banner-text strong {
            display: block;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }
        
        .push-banner-text span {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .push-banner-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .push-btn {
            flex: 1;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .push-btn-enable {
            background: white;
            color: #059669;
        }
        
        .push-btn-enable:hover {
            background: #f0fdf4;
        }
        
        .push-btn-close {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .push-btn-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Notification Status Badge */
        .notification-status {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .notification-status.enabled {
            background: #ECFDF5;
            color: #059669;
        }
        
        .notification-status.disabled {
            background: #FEF2F2;
            color: #DC2626;
            cursor: pointer;
        }
        
        .notification-status.disabled:hover {
            background: #FEE2E2;
        }
    </style>
    
    <!-- PWA Manager -->
    <script src="/pwa-manager.js"></script>
    
    <!-- Finance Dashboard Module -->
    <script src="/finance-dashboard.js"></script>
    
    <!-- Real-time Bildirim Sistemi (iOS dahil tüm platformlar) -->
    <script>
        // ============================================
        // ZAMANLI BİLDİRİM SİSTEMİ v2.1
        // Tüm platformlarda çalışır (iOS dahil)
        // iOS döngü sorunu düzeltildi
        // ============================================
        
        const ZamanliNotify = {
            // Durum değişkenleri
            listener: null,
            knownAppointments: new Set(),
            sound: null,
            enabled: false,
            isIOS: false,
            isPWA: false,
            salonId: null,
            initialized: false, // Çift init engellemek için
            initInProgress: false, // Init sırasında tekrar çağrılmasını engelle
            
            // Sistemi başlat
            init: function(salonId) {
                // Zaten başlatılmışsa veya devam ediyorsa çık
                if (this.initialized || this.initInProgress) {
                    console.log('[Notify] Zaten başlatılmış veya devam ediyor, atlanıyor');
                    return;
                }
                
                this.initInProgress = true;
                console.log('[Notify] Başlatılıyor...');
                this.salonId = salonId;
                
                // Platform tespiti
                this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                this.isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                             window.navigator.standalone === true;
                
                console.log('[Notify] Platform:', {
                    isIOS: this.isIOS,
                    isPWA: this.isPWA,
                    userAgent: navigator.userAgent.substring(0, 50)
                });
                
                // Ses hazırla (her platformda çalışır)
                this.initSound();
                
                // Mevcut randevuları kaydet
                if (typeof appointments !== 'undefined' && appointments.length > 0) {
                    appointments.forEach(a => this.knownAppointments.add(a.id));
                }
                
                // Bildirim durumunu kontrol et (iOS'ta döngü yapmadan)
                this.checkNotificationStatus();
                
                // Real-time dinlemeyi başlat (her durumda)
                this.startListening();
                
                this.initialized = true;
                this.initInProgress = false;
            },
            
            // Ses sistemini başlat
            initSound: function() {
                try {
                    // Kısa bip sesi (base64)
                    this.sound = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7v/////////////////////////////////' + 
                    '/////////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7UGQAD/AAADSAAAAANIAAAGkAAAAIAAANIAAAAAgAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//tQZB4P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVQ==');
                    console.log('[Notify] Ses hazır');
                } catch (e) {
                    console.log('[Notify] Ses oluşturulamadı:', e);
                }
            },
            
            // Ses çal
            playSound: function() {
                if (this.sound) {
                    this.sound.currentTime = 0;
                    this.sound.play().catch(e => {
                        console.log('[Notify] Ses çalınamadı (kullanıcı etkileşimi gerekli)');
                    });
                }
            },
            
            // Bildirim durumunu kontrol et
            checkNotificationStatus: function() {
                // Notification API var mı?
                if (!('Notification' in window)) {
                    console.log('[Notify] Notification API desteklenmiyor');
                    // iOS Safari (PWA değilse) - banner'ı sadece bir kez göster
                    if (this.isIOS && !this.isPWA) {
                        // Daha önce gösterilmiş mi kontrol et
                        const iosBannerShown = sessionStorage.getItem('ios-banner-shown-session');
                        if (!iosBannerShown) {
                            sessionStorage.setItem('ios-banner-shown-session', 'true');
                            this.showIOSInstallBanner();
                        }
                    }
                    return;
                }
                
                // İzin durumu
                if (Notification.permission === 'granted') {
                    this.enabled = true;
                    this.updateUI(true);
                    console.log('[Notify] İzin verilmiş');
                    
                    // FCM Token'ı kaydet/güncelle (zaten izin varsa) - sadece bir kez
                    if (!this.fcmRegistered) {
                        this.fcmRegistered = true;
                        this.registerFCMToken();
                    }
                } else if (Notification.permission === 'denied') {
                    this.updateUI(false);
                    console.log('[Notify] İzin reddedilmiş');
                } else {
                    // İzin istenmemiş - banner göster (session başına bir kez)
                    const bannerShown = sessionStorage.getItem('push-banner-shown-session');
                    if (!bannerShown) {
                        sessionStorage.setItem('push-banner-shown-session', 'true');
                        this.showNotificationBanner();
                    }
                }
            },
            
            // Real-time dinlemeyi başlat
            startListening: function() {
                if (this.listener) {
                    this.listener();
                }
                
                if (!this.salonId) {
                    console.log('[Notify] Salon ID yok, dinleme başlatılamadı');
                    return;
                }
                
                console.log('[Notify] Real-time dinleme başlatılıyor:', this.salonId);
                
                try {
                    this.listener = db.collection('appointments')
                        .where('salonId', '==', this.salonId)
                        .onSnapshot(
                            (snapshot) => {
                                snapshot.docChanges().forEach(change => {
                                    if (change.type === 'added') {
                                        const apt = { id: change.doc.id, ...change.doc.data() };
                                        
                                        if (!this.knownAppointments.has(apt.id)) {
                                            console.log('[Notify] YENİ RANDEVU:', apt);
                                            this.knownAppointments.add(apt.id);
                                            this.notifyNewAppointment(apt);
                                        }
                                    }
                                });
                            },
                            (error) => {
                                console.error('[Notify] Dinleme hatası:', error);
                            }
                        );
                    
                    console.log('[Notify] Dinleme aktif');
                } catch (e) {
                    console.error('[Notify] Dinleme başlatılamadı:', e);
                }
            },
            
            // Yeni randevu bildirimi
            notifyNewAppointment: function(apt) {
                console.log('[Notify] Bildirim gönderiliyor...', apt.id);
                
                // PERSONEL MODU FİLTRESİ - Sadece kendi randevularım için bildirim al
                if (typeof isStaffMode !== 'undefined' && isStaffMode) {
                    const isMyAppointment = apt.staffId === currentStaffId || 
                                           apt.staffName === currentStaffName ||
                                           (!apt.staffId && !apt.staffName);
                    if (!isMyAppointment) {
                        console.log('[Notify] Farklı personele ait randevu, bildirim atlanıyor:', apt.staffName || apt.staffId);
                        return;
                    }
                }
                
                // Daha önce gösterilmiş mi kontrol et
                if (apt.id) {
                    const seenKey = `seenNotify_${salon?.id || 'default'}`;
                    let seenNotify = JSON.parse(localStorage.getItem(seenKey) || '[]');
                    
                    if (seenNotify.includes(apt.id)) {
                        console.log('[Notify] Bu bildirim zaten gösterildi, atlanıyor:', apt.id);
                        return;
                    }
                    
                    // Seen listesine ekle
                    seenNotify.push(apt.id);
                    if (seenNotify.length > 100) seenNotify = seenNotify.slice(-100);
                    localStorage.setItem(seenKey, JSON.stringify(seenNotify));
                }
                
                // 1. Ses çal
                this.playSound();
                
                // 2. Tarayıcı bildirimi DEVRE DIŞI - FCM (Cloud Function) zaten gönderiyor
                // Duplikat bildirim önleme: Sadece ses + popup + liste güncellemesi yapılır
                // Arka plandayken: Service Worker FCM bildirimini gösterir
                // Ön plandayken: onMessage handler ses + popup gösterir
                console.log('[Notify] Sayfa içi bildirim (ses + popup):', apt.id);
                
                // 3. Sayfa içi popup
                this.showPopup(apt);
                
                // 4. Listeyi güncelle
                if (typeof loadAppointments === 'function') {
                    loadAppointments();
                }
            },
            
            // Sayfa içi popup
            showPopup: function(apt) {
                // Önceki popup varsa kaldır
                const old = document.querySelector('.zamanli-popup');
                if (old) old.remove();
                
                const popup = document.createElement('div');
                popup.className = 'zamanli-popup';
                popup.innerHTML = 
                    '<div class="zp-icon">🎉</div>' +
                    '<div class="zp-content">' +
                        '<strong>Yeni Randevu!</strong>' +
                        '<p>' + (apt.customerName || 'Müşteri') + '</p>' +
                        '<p>' + (apt.service || 'Hizmet') + '</p>' +
                        '<p>' + (apt.date || '') + ' ' + (apt.time || '') + '</p>' +
                    '</div>' +
                    '<button class="zp-close" onclick="this.parentElement.remove()">✕</button>';
                
                document.body.appendChild(popup);
                
                // 15 saniye sonra kapat
                setTimeout(() => {
                    if (popup.parentElement) popup.remove();
                }, 15000);
            },
            
            // Bildirim izni iste
            requestPermission: async function() {
                const banner = document.getElementById('pushBanner');
                const btn = banner ? banner.querySelector('.push-btn-enable') : null;
                
                if (btn) {
                    btn.textContent = 'Açılıyor...';
                    btn.disabled = true;
                }
                
                try {
                    const permission = await Notification.requestPermission();
                    
                    if (permission === 'granted') {
                        this.enabled = true;
                        if (banner) banner.style.display = 'none';
                        this.updateUI(true);
                        
                        // FCM Token al ve kaydet
                        await this.registerFCMToken();
                        
                        // Test bildirimi
                        new Notification('✅ Bildirimler Açıldı!', {
                            body: 'Artık yeni randevulardan haberdar olacaksınız.',
                            icon: '/icons/icon-192x192.png'
                        });
                        
                        console.log('[Notify] İzin verildi ve FCM token kaydedildi');
                    } else {
                        alert('Bildirimlere izin verilmedi.\nTarayıcı ayarlarından açabilirsiniz.');
                        if (btn) {
                            btn.textContent = 'Bildirimleri Aç';
                            btn.disabled = false;
                        }
                    }
                } catch (e) {
                    console.error('[Notify] İzin hatası:', e);
                    alert('Bir hata oluştu. Lütfen tekrar deneyin.');
                    if (btn) {
                        btn.textContent = 'Bildirimleri Aç';
                        btn.disabled = false;
                    }
                }
            },
            
            // FCM Token al ve Firestore'a kaydet
            registerFCMToken: async function() {
                try {
                    // Service Worker'ın hazır olmasını bekle
                    const registration = await navigator.serviceWorker.ready;
                    
                    // Firebase Messaging başlat
                    if (typeof firebase !== 'undefined' && firebase.messaging) {
                        const messaging = firebase.messaging();
                        
                        // VAPID Key - config.js'den al
                        const vapidKey = (typeof FCM_CONFIG !== 'undefined' && FCM_CONFIG.vapidKey) 
                            ? FCM_CONFIG.vapidKey 
                            : 'BBPC1mKHLS8_d1_e0ZvwLLTZOF1RUK56H5r_0fD6TXvZM6sJyFl3ss5DTU5JP6GYWM8wJU079YGqEpCxw3Sv3z0';
                        
                        const token = await messaging.getToken({
                            vapidKey: vapidKey,
                            serviceWorkerRegistration: registration
                        });
                        
                        if (token && this.salonId) {
                            console.log('[Notify] FCM Token alındı:', token.substring(0, 30) + '...');
                            
                            // Token'ı Firestore'a kaydet
                            const tokenHash = await this.hashToken(token);
                            
                            // Personel mi salon sahibi mi?
                            const tokenData = {
                                token: token,
                                salonId: this.salonId,
                                userType: isStaffMode ? 'staff' : 'salon',
                                platform: this.detectPlatform(),
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastActive: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            
                            // Personel ise staffId ve rol ekle
                            if (isStaffMode && currentStaffId) {
                                tokenData.staffId = currentStaffId;
                                tokenData.staffName = currentStaffName;
                                tokenData.staffRole = currentStaffRole || STAFF_ROLES.STAFF;
                            }
                            
                            await db.collection('push_tokens').doc(tokenHash).set(tokenData, { merge: true });
                            
                            console.log('[Notify] FCM Token Firestore\'a kaydedildi', isStaffMode ? '(Personel)' : '(Salon Sahibi)');
                            
                            // Foreground mesaj dinleyicisi
                            messaging.onMessage((payload) => {
                                console.log('[Notify] Foreground mesaj:', payload);
                                
                                // Randevu ID kontrolü - daha önce gösterilmişse atla
                                const appointmentId = payload.data?.appointmentId;
                                if (appointmentId) {
                                    const seenKey = `seenFCM_${salon?.id || 'default'}`;
                                    let seenFCM = JSON.parse(localStorage.getItem(seenKey) || '[]');
                                    
                                    if (seenFCM.includes(appointmentId)) {
                                        console.log('[Notify] Bu bildirim zaten gösterildi, atlanıyor:', appointmentId);
                                        return;
                                    }
                                    
                                    // Seen listesine ekle
                                    seenFCM.push(appointmentId);
                                    if (seenFCM.length > 100) seenFCM = seenFCM.slice(-100);
                                    localStorage.setItem(seenKey, JSON.stringify(seenFCM));
                                }
                                
                                // Uygulama açıkken: Tarayıcı bildirimi OLUŞTURMA (FCM zaten hallediyor)
                                // Sadece ses + popup + liste güncelle
                                console.log('[Notify] Foreground FCM alındı, ses + popup gösteriliyor');
                                
                                // Ses çal
                                if (typeof NotificationManager !== 'undefined') {
                                    NotificationManager.playSound();
                                }
                                
                                // Popup göster
                                if (payload.data && payload.data.type === 'new_appointment') {
                                    this.showPopup({
                                        customerName: payload.data.customerName,
                                        service: payload.data.service,
                                        date: payload.data.date,
                                        time: payload.data.time
                                    });
                                    
                                    // Listeyi güncelle
                                    if (typeof loadAppointments === 'function') {
                                        loadAppointments();
                                    }
                                }
                            });
                            
                            return token;
                        }
                    } else {
                        console.warn('[Notify] Firebase Messaging kullanılamıyor');
                    }
                } catch (error) {
                    console.error('[Notify] FCM Token hatası:', error);
                }
                return null;
            },
            
            // Token hash'leme (ID olarak kullanmak için)
            hashToken: async function(token) {
                const encoder = new TextEncoder();
                const data = encoder.encode(token);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 40);
            },
            
            // Platform tespiti
            detectPlatform: function() {
                const ua = navigator.userAgent;
                if (/android/i.test(ua)) return 'android';
                if (/iPad|iPhone|iPod/.test(ua)) return 'ios';
                if (/Windows/.test(ua)) return 'windows';
                if (/Mac/.test(ua)) return 'mac';
                return 'web';
            },
            
            // Bildirim banner'ını göster
            showNotificationBanner: function() {
                // Daha önce kapatılmış mı?
                const lastClosed = localStorage.getItem('notify-banner-closed');
                if (lastClosed && Date.now() - parseInt(lastClosed) < 24 * 60 * 60 * 1000) {
                    return;
                }
                
                setTimeout(() => {
                    const banner = document.getElementById('pushBanner');
                    if (banner) banner.style.display = 'block';
                }, 2000);
            },
            
            // iOS için "Ana Ekrana Ekle" banner'ı
            showIOSInstallBanner: function() {
                // Daha önce kapatılmış mı?
                const lastClosed = localStorage.getItem('ios-install-closed');
                if (lastClosed && Date.now() - parseInt(lastClosed) < 7 * 24 * 60 * 60 * 1000) {
                    return;
                }
                
                setTimeout(() => {
                    const banner = document.createElement('div');
                    banner.id = 'iosInstallBanner';
                    banner.className = 'ios-install-banner';
                    banner.innerHTML = 
                        '<div class="iib-content">' +
                            '<div class="iib-icon">📱</div>' +
                            '<div class="iib-text">' +
                                '<strong>Bildirim almak için uygulamayı yükleyin</strong>' +
                                '<p>Paylaş <span class="iib-share">⬆️</span> → "Ana Ekrana Ekle" seçin</p>' +
                            '</div>' +
                        '</div>' +
                        '<button class="iib-close" onclick="ZamanliNotify.closeIOSBanner()">✕</button>';
                    
                    document.body.appendChild(banner);
                }, 3000);
            },
            
            // iOS banner'ını kapat
            closeIOSBanner: function() {
                const banner = document.getElementById('iosInstallBanner');
                if (banner) banner.remove();
                localStorage.setItem('ios-install-closed', Date.now().toString());
            },
            
            // Banner'ı kapat
            closeBanner: function() {
                const banner = document.getElementById('pushBanner');
                if (banner) banner.style.display = 'none';
                localStorage.setItem('notify-banner-closed', Date.now().toString());
            },
            
            // UI güncelle
            updateUI: function(enabled) {
                const statusEl = document.getElementById('notificationStatus');
                if (statusEl) {
                    if (enabled) {
                        statusEl.className = 'notification-status enabled';
                        statusEl.innerHTML = '🔔 Bildirimler Açık';
                        statusEl.onclick = null;
                    } else {
                        statusEl.className = 'notification-status disabled';
                        statusEl.innerHTML = '🔕 Bildirimler Kapalı';
                        statusEl.onclick = () => this.requestPermission();
                    }
                }
            }
        };
        
        // Global fonksiyonlar (HTML onclick için)
        function enablePushNotifications() {
            ZamanliNotify.requestPermission();
        }
        
        function closePushBanner() {
            ZamanliNotify.closeBanner();
        }
        
        function checkAndShowPushBanner(salonId) {
            ZamanliNotify.init(salonId);
        }
    </script>
    
    <style>
        /* Yeni Randevu Popup */
        .zamanli-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
            z-index: 10000;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            animation: zp-slide 0.3s ease;
            max-width: 320px;
        }
        
        @keyframes zp-slide {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .zamanli-popup .zp-icon {
            font-size: 1.75rem;
            line-height: 1;
        }
        
        .zamanli-popup .zp-content {
            flex: 1;
        }
        
        .zamanli-popup .zp-content strong {
            display: block;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }
        
        .zamanli-popup .zp-content p {
            margin: 2px 0;
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .zamanli-popup .zp-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.85rem;
            line-height: 1;
            flex-shrink: 0;
        }
        
        .zamanli-popup .zp-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* iOS Install Banner */
        .ios-install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a2e;
            color: white;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10001;
            animation: iib-up 0.3s ease;
        }
        
        @keyframes iib-up {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .ios-install-banner .iib-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .ios-install-banner .iib-icon {
            font-size: 1.5rem;
        }
        
        .ios-install-banner .iib-text strong {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }
        
        .ios-install-banner .iib-text p {
            font-size: 0.8rem;
            opacity: 0.8;
            margin: 0;
        }
        
        .ios-install-banner .iib-share {
            display: inline-block;
            background: #3b82f6;
            padding: 0 4px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .ios-install-banner .iib-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
        }
        
        /* Mobil uyum */
        @media (max-width: 480px) {
            .zamanli-popup {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }
    </style>
    
    <!-- Personel Ayarları Modal -->
    <div id="staffSettingsModal" style="display: none;"></div>
    
    <!-- Genel Modal Container (Owner Profile vb.) -->
    <div id="modal" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;"></div>
    
    <script>
        // closeModal - genel modal kapatma fonksiyonu
        function closeModal() {
            const modal = document.getElementById('modal');
            if (modal) {
                modal.innerHTML = '';
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
