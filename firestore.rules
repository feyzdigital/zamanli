rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== YARDIMCI FONKSİYONLAR ====================
    
    // NOT: Bu proje PIN-based authentication kullanıyor (Firebase Auth değil).
    // request.auth her zaman null olacak. Güvenlik admin panel seviyesinde sağlanır.
    // Firebase Auth entegrasyonu yapıldığında bu kurallar sıkılaştırılacak.
    
    // Kimlik doğrulama kontrolü
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Super admin kontrolü
    function isSuperAdmin() {
      return isAuthenticated() && 
             request.auth.token.role == 'superAdmin' &&
             request.auth.token.level >= 100;
    }
    
    // Geçerli PIN formatı kontrolü (4-6 haneli)
    function isValidPin(pin) {
      return pin is string && pin.size() >= 4 && pin.size() <= 6;
    }
    
    // Telefon numarası formatı kontrolü (10-11 hane)
    function isValidPhone(phone) {
      return phone is string && phone.size() >= 10 && phone.size() <= 11;
    }
    
    // Email formatı kontrolü
    function isValidEmail(email) {
      return email is string && email.matches('.*@.*\\..*');
    }
    
    // ==================== SALONLAR ====================
    match /salons/{salonId} {
      // Herkes salonları okuyabilir (public listing için)
      allow read: if true;
      
      // Yeni salon kaydı - temel validasyon
      // Admin paneli ve kayıt sayfası salon oluşturabilir
      allow create: if request.resource.data.keys().hasAll(['name', 'phone', 'pin']) &&
                       request.resource.data.name is string &&
                       request.resource.data.name.size() > 0 &&
                       isValidPhone(request.resource.data.phone) &&
                       isValidPin(request.resource.data.pin);
      
      // Salon güncelleme - PIN-based auth sistemi ile çalışıyor
      // Güvenlik admin panel ve yönetim paneli seviyesinde sağlanır
      allow update: if true;
      
      // Silme - admin panel üzerinden yapılır
      allow delete: if true;
      
      // ----- Salon Alt Koleksiyonları -----
      
      // Personel
      match /staff/{staffId} {
        allow read: if true;
        allow write: if true;
      }
      
      // Hizmetler
      match /services/{serviceId} {
        allow read: if true;
        allow write: if true;
      }
      
      // Salon randevuları
      match /appointments/{appointmentId} {
        allow read: if true;
        allow create: if true;
        allow update: if true;
        allow delete: if true;
      }
      
      // Müşteriler
      match /customers/{customerId} {
        allow read: if true;
        allow write: if true;
      }
      
      // Personel blokları
      match /staffBlocks/{blockId} {
        allow read: if true;
        allow write: if true;
      }
      
      // Müşteri notları
      match /customerNotes/{noteId} {
        allow read: if true;
        allow write: if true;
      }
      
      // Yorumlar
      match /reviews/{reviewId} {
        allow read: if true;
        allow create: if true;
        allow update, delete: if true;
      }
      
      // Silinmiş müşteriler (blacklist)
      match /deletedCustomers/{customerId} {
        allow read: if true;
        allow write: if true;
      }
    }
    
    // ==================== GLOBAL RANDEVULAR ====================
    match /appointments/{appointmentId} {
      allow read: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if true;
    }
    
    // ==================== MÜŞTERİLER ====================
    match /customers/{customerId} {
      allow read: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if true;
    }
    
    // ==================== ADMIN ====================
    match /admin/{docId} {
      // PIN-based admin auth - güvenlik admin panel seviyesinde
      allow read: if true;
      allow write: if true;
    }
    
    // ==================== SİSTEM AYARLARI ====================
    match /settings/{docId} {
      allow read: if true;
      allow write: if true;
    }
    
    // ==================== PUSH NOTIFICATIONS ====================
    
    // Push Token'lar - müşteriler dahil herkes token kaydedebilir
    match /push_tokens/{tokenId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['token', 'userType']) &&
                      request.resource.data.token is string &&
                      request.resource.data.userType in ['salon', 'staff', 'customer'];
      allow update: if true;
      allow delete: if true;
    }
    
    // Bildirim kuyruğu
    match /notifications/{notificationId} {
      allow read: if true;
      allow write: if true;
    }
    
    // Bildirim logları
    match /notification_logs/{logId} {
      allow read: if true;
      allow write: if true;
    }
    
    // ==================== ÖDEME ====================
    match /payments/{paymentId} {
      allow read: if true;
      allow write: if true;
    }
    
    match /payment_logs/{logId} {
      allow read: if true;
      allow write: if true;
    }
    
    // Bekleyen bildirimler (WhatsApp URL'ler vb.)
    match /pending_notifications/{notifId} {
      allow read: if true;
      allow write: if true;
    }
    
    // ==================== ANALİTİK ====================
    match /analytics/{docId} {
      allow read: if true;
      allow write: if true;
    }
  }
}
